<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    
    <title>
        BIO和NIO底层原理对比 |
        
        YingLong</title>
    
    
        <meta name="keywords" content="Tomcat">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="在Tomcat7中，默认为BIO，可以通过如下配置改为NIO 1&amp;lt;Connector port=&quot;8080&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot; connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; /&amp;gt; BIOBIO的模型比较简单，是通过JioEndpoint实例中的Acce">
<meta name="keywords" content="Tomcat">
<meta property="og:type" content="article">
<meta property="og:title" content="BIO和NIO底层原理对比">
<meta property="og:url" content="https://yaoyinglong.github.io/Blog/中间件/Tomcat/BIO和NIO底层原理对比/index.html">
<meta property="og:site_name" content="YingLong">
<meta property="og:description" content="在Tomcat7中，默认为BIO，可以通过如下配置改为NIO 1&amp;lt;Connector port=&quot;8080&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot; connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; /&amp;gt; BIOBIO的模型比较简单，是通过JioEndpoint实例中的Acce">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://yaoyinglong.github.io/images/Tomcat/Socket请求通过SocketProcessor处理流程.png">
<meta property="og:image" content="https://yaoyinglong.github.io/images/Tomcat/NIO处理Socket请求流程.png">
<meta property="og:updated_time" content="2022-02-23T14:56:14.800Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BIO和NIO底层原理对比">
<meta name="twitter:description" content="在Tomcat7中，默认为BIO，可以通过如下配置改为NIO 1&amp;lt;Connector port=&quot;8080&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot; connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; /&amp;gt; BIOBIO的模型比较简单，是通过JioEndpoint实例中的Acce">
<meta name="twitter:image" content="https://yaoyinglong.github.io/images/Tomcat/Socket请求通过SocketProcessor处理流程.png">
    

    

    
        <link rel="icon" href="/favicon.ico">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>
</html>
<body>
<div id="container">
    <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">YingLong</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
                <a class="main-nav-link" href="javascript:trigger()">Reading</a>
            </nav>
            
            <div id="search-form-wrap">
    
        <form class="search-form">
            <input type="text" class="ins-search-input search-form-input" placeholder="Search">
            <button type="submit" class="search-form-submit"></button>
        </form>
        <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: '/',
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>
<script type="text/javascript">
    var index = 0
    trigger = function () {
        if (index % 2 == 0) {
            $("#sidebar").css("display", "none");
            $("#main").css("float", "none");
        } else {
            $("#sidebar").css("display", "inline");
            $("#main").css("float", "left");
        }
        index++
    }
</script>

    <div class="outer">
        
        
            <aside id="sidebar">
    
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>

        
        
        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Cloud
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Dubbo
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务调用/">Dubbo服务调用</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo基础/">Dubbo基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo与Spring集成原理/">Dubbo与Spring集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/SPI机制源码/">SPI机制源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务引入/">Dubbo服务引入</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务导出/">Dubbo服务导出</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            ELK
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch基础/">ElasticSearch基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch进阶/">ElasticSearch进阶</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch实战/">ElasticSearch实战</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            MQ
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/MQ/Kafka基础/">Kafka基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RabbitMQ基础/">RabbitMQ基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ高级特性/">RocketMQ高级特性</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ消息存储源码/">RocketMQ消息存储源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RabbitMQ高级特性及Spring集成/">RabbitMQ高级特性及Spring集成</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ基础/">RocketMQ基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ生产者源码/">RocketMQ生产者源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ消费者源码/">RocketMQ消费者源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Nacos
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos Client原理/">Nacos Client原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群成员信息同步/">Nacos集群成员信息同步</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos配置中心Server原理/">Nacos配置中心Server原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群注册服务同步/">Nacos集群注册服务同步</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群CP模式/">Nacos集群CP模式</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos Server原理/">Nacos Server原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos配置中心Client原理/">Nacos配置中心Client原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Netty
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty基础/">Netty基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/IO模型基础/">IO模型基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty源码/">Netty源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty进阶/">Netty进阶</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Redis
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis集群架构/">Redis集群架构</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis缓存及性能优化/">Redis缓存及性能优化</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis分布式锁实现/">Redis分布式锁实现</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis基础/">Redis基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Seata
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Seata/Seata集成原理/">Seata集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Seata/Seata分布式事务原理/">Seata分布式事务原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Sentinel
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/常见限流算法/">常见限流算法</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel限流熔断降级源码/">Sentinel限流熔断降级源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel规则发布源码/">Sentinel规则发布源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel配置持久化/">Sentinel配置持久化</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Zookeeper
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper基础/">Zookeeper基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper客户端之ZAB/">Zookeeper客户端之ZAB</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper服务端之ZAB/">Zookeeper服务端之ZAB</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper集群Leader选举/">Zookeeper集群Leader选举</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            网关
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/网关/Gateway源码/">Gateway源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Cloud/Ribbon集成原理/">Ribbon集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Feign集成原理/">Feign集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Canal基础/">Canal基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/分布式系统常见问题/">分布式系统常见问题</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/秒杀问题及解决方案/">秒杀问题及解决方案</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/分布式事务解决方案/">分布式事务解决方案</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            DB
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/DB/MVCC与BufferPool缓存机制/">MVCC与BufferPool缓存机制</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL主从架构/">MySQL主从架构</a></li>
                
                    <li class="file"><a href="/Blog/DB/MongoDB基础/">MongoDB基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL内部组件结构/">MySQL内部组件结构</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL事务隔离级别与锁机制/">MySQL事务隔离级别与锁机制</a></li>
                
                    <li class="file"><a href="/Blog/DB/分库分表/">分库分表</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL基础/">MySQL基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/ShardingSphere基础/">ShardingSphere基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化二/">索引优化二</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化三/">索引优化三</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化一/">索引优化一</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引的原理与使用/">索引的原理与使用</a></li>
                
                    <li class="file"><a href="/Blog/DB/Explain工具/">Explain工具</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL常用SQL总结/">MySQL常用SQL总结</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Java
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            VM
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/VM/JVM内存池/">JVM内存池</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Class文件结构/">Class文件结构</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Minor&Major&Full GC/">Minor&Major&Full GC</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/OutOfMemoryError异常/">OOM异常实验</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/内存非配与回收策略/">内存分配与回收策略</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Java内存区域/">Java内存区域</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/垃圾收集器/">垃圾收集器</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/垃圾收集算法/">垃圾收集算法及实现</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/字节码指令/">字节码指令</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/方法调用/">方法调用</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/对象是否存活/">对象是否存活</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/堆中对象分配&布局&访问/">堆中对象分配&布局&访问</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/字节码指令手册/">字节码指令手册</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/运行时栈帧结构/">运行时栈帧结构</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/理解GC日志/">理解GC日志</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/属性表集合/">属性表集合</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/类加载器/">类加载器</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/类加载过程/">类加载过程</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/常量池/">常量池</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            基础
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/基础/HashMap源码分析JDK8/">HashMap源码分析JDK8</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/HashMap源码分析JDK7/">HashMap源码分析JDK7</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/lambda常用总结/">lambda常用总结</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/PriorityQueue源码/">PriorityQueue源码</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/动态代理/">动态代理</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/反射基础/">反射基础</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/注解实现及应用/">注解实现及应用</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/时间及日期总结/">Java8时间及日期</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/Java实用工具库/">Java实用工具库</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/位运算/">位运算</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/工具/国密SM2/">国密SM2</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/Java中调用Groovy脚本/">Java中调用Groovy脚本</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/国密SM4/">国密SM4</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/JAVA实用工具/">JAVA实用工具</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            并发
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/并发/AQS与ReentrantLock/">AQS与ReentrantLock</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/BlockingQueue阻塞队列二/">BlockingQueue阻塞队列二</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/BlockingQueue阻塞队列一/">BlockingQueue阻塞队列一</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Callable与Future/">Callable与Future</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Java与线程/">Java与线程</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Synchronized总结/">Synchronized总结</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ScheduledThreadPoolExecutor/">ScheduledThreadPoolExecutor</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Unsafe应用/">Unsafe应用</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Volatile原理/">Volatile原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/操作系统底层/">操作系统底层</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/原子性、可见性、有序性/">原子性、可见性、有序性</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/同步工具类/">同步工具类</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ReentrantReadWriteLock原理/">ReentrantReadWriteLock原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程安全实现方式/">线程安全实现方式</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程安全/">线程安全</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/锁优化/">锁优化</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程池原理/">线程池原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Java内存模型/">Java内存模型</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Condition原理/">Condition原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ThreadLocal原理/">ThreadLocal原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ConcurrentHashMap源码JDK8/">ConcurrentHashMap源码JDK8</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ConcurrentHashMap源码JDK7/">ConcurrentHashMap源码JDK7</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Java/JVM整体概览/">JVM整体概览</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM内存参数设置/">JVM内存参数设置</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM调优工具/">JVM调优工具</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM调优思路/">JVM调优思路</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Maven
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Maven/Maven Assembly标签全解/">Maven Assembly标签全解</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven基础/">Maven基础</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用/">Maven常用</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven个性化打包/">Maven个性化打包</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven仓库/">Maven仓库</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用工具/">Maven常用工具</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven属性/">Maven属性</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven加密JAR包/">Maven加密JAR包</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven插件编写/">Maven插件编写</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven插件基础/">Maven插件基础</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用插件/">Maven常用插件</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven标签全解/">Maven标签全解</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven生命周期/">Maven生命周期</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven聚合与继承/">Maven聚合与继承</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常见问题总结/">Maven常见问题总结</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Spring
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            SpringBoot
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot Jar包启动原理/">SpringBoot Jar包启动原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot自动装配原理/">SpringBoot自动装配原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot资源加载/">SpringBoot资源加载</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot启动原理/">SpringBoot启动原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Spring/AOP切面类解析/">AOP切面类解析</a></li>
                
                    <li class="file"><a href="/Blog/Spring/AOP创建代理与调用/">AOP创建代理与调用</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Bean的加载过程/">Bean的加载过程</a></li>
                
                    <li class="file"><a href="/Blog/Spring/IoC容器加载过程/">IoC容器加载过程</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Bean的生命周期/">Bean的生命周期</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Hystrix总结/">Hystrix总结</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring Gzip压缩/">Spring Gzip压缩</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring初始化扩展/">Spring初始化扩展</a></li>
                
                    <li class="file"><a href="/Blog/Spring/IoC容器/">IoC容器</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc异步/">SpringMvc异步原理及实现</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring线程池跨线程数据共享/">Spring线程池跨线程数据共享</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring整体架构/">Spring整体架构</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事务解析原理/">事务解析原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事件监听器/">事件监听器</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事务调用原理/">事务调用原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/BeanDefinition解析注册/">BeanDefinition解析注册</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc加载机制/">SpringMvc加载机制</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc处理分发请求原理/">SpringMvc处理分发请求原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Test
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Test/IT测试总结/">IT测试总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/JMeter日常总结/">JMeter日常总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/UT测试总结/">UT测试总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/LoadRunner日常总结/">LoadRunner日常总结</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            中间件
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Mybatis
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis缓存原理/">Mybatis缓存原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis执行SQL原理/">Mybatis执行SQL原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis配置文件解析原理/">Mybatis配置文件解析原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis集成到Spring原理/">Mybatis集成到Spring原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Tomcat
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat启动过程/">Tomcat启动过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat工作原理/">Tomcat工作原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat热部署热加载/">Tomcat热部署热加载</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat处理响应过程/">Tomcat处理响应过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat处理请求过程/">Tomcat处理请求过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat整体架构/">Tomcat整体架构</a></li>
                
                    <li class="file active"><a href="/Blog/中间件/Tomcat/BIO和NIO底层原理对比/">BIO和NIO底层原理对比</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            云原生
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/云原生/Docker基础/">Docker基础</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Docker Compose基础/">Docker Compose基础</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Kubernetes基础/">Kubernetes基础</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Docker搭建Prometheus&Grafana/">Docker搭建Prometheus&Grafana</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            杂记
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Git
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Git/GIt基本概念/">Git基本概念</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Git/GIt常用命令/">Git常用命令</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Git/分支管理理解/">分支管理理解</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Go
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Go/Go基础/">Go基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Linux
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux常用技巧/">Linux常用技巧</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux常用命令/">Linux常用命令</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Python
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Python/Excel文件数据抽取/">Excel文件数据抽取</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            协议族
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/协议族/TCPIP四层&五层模型/">TCP/IP四层&五层模型</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/以太网/">以太网</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/地址解析协议/">地址解析协议ARP</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/网络基础知识/">网络基础知识</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/HTTP&TCP&UDP协议/">HTTP&TCP&UDP协议</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/工具/Win实用工具/">Win实用工具</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/IDEA快捷的使用/">IDEA的快捷使用</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/XSD使用总结/">XSD实用总结</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/SonarQube配置总结/">SonarQube配置总结</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            算法
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/算法/二叉搜索树/">二叉搜索树</a></li>
                
                    <li class="file"><a href="/Blog/算法/图基础/">图基础</a></li>
                
                    <li class="file"><a href="/Blog/算法/平衡二叉树/">平衡二叉树</a></li>
                
                    <li class="file"><a href="/Blog/算法/排序算法/">排序算法</a></li>
                
                    <li class="file"><a href="/Blog/算法/树基础/">树基础</a></li>
                
                    <li class="file"><a href="/Blog/算法/基础算法/">基础算法</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法/">经典算法</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            设计模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            创建型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/单例模式/">单例模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/建造者模式/">建造者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/工厂模式/">工厂模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/原型模式/">原型模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            结构型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/外观模式/">外观模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/组合模式/">组合模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/装饰模式/">装饰模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/代理模式/">代理模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/适配器模式/">适配器模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            行为型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/中介者模式/">中介者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/模板方法模式/">模板方法模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/命令模式/">命令模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/状态模式/">状态模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/备忘录模式/">备忘录模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/策略模式/">策略模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/观察者模式/">观察者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/责任链模式/">责任链模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/访问者模式/">访问者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/迭代器模式/">迭代器模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/设计模式/SOLID基本原则/">SOLID基本原则</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/设计模式概览/">设计模式概览</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/index/"></a></li>
                
            </ul>
        
    </div>
    <script>
        $(document).ready(function () {
            var iconFolderOpenClass = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({duration: 100});
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({duration: 100});
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    subtrees.slideUp({duration: 100});
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({duration: 100});
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if (expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({duration: 100});
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({duration: 100});
                    icon.addClass(iconAllExpandClass);
                }
            });
        });
    </script>

    
</aside>
<div id="toTop" class="fa fa-angle-up"></div>

        
        <section id="main"><article id="post-中间件/Tomcat/BIO和NIO底层原理对比" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
        <i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/中间件/">中间件</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/中间件/Tomcat/">Tomcat</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Tomcat/">Tomcat</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/Blog/中间件/Tomcat/BIO和NIO底层原理对比/">
            <time datetime="2021-08-24T16:00:00.000Z" itemprop="datePublished">2021-08-25</time>
        </a>
    </div>


                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            BIO和NIO底层原理对比
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
            
            
                    
            
            
                <p>在Tomcat7中，默认为BIO，可以通过如下配置改为NIO</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h3><p>BIO的模型比较简单，是通过<strong><code>JioEndpoint</code></strong>实例中的<strong><code>Acceptor</code></strong>线程负责循环<strong>阻塞接收socket连接</strong>，每接收到一个socket连接就包装成<strong><code>SocketProcessor</code></strong>扔进线程池Executor中，SocketProcessor是一个Runnable，SocketProcessor负责从socket中<strong>阻塞读取</strong>数据，并且向socket中<strong>阻塞写入</strong>数据。</p>
<p>Acceptor线程的数量默认为1个，可以通过<strong><code>acceptorThreadCount</code></strong>参数进行配置，线程池Executor是可以配置的，比如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">"tomcatThreadPool"</span> <span class="attr">namePrefix</span>=<span class="string">"catalina-exec-"</span> <span class="attr">maxThreads</span>=<span class="string">"150"</span> <span class="attr">minSpareThreads</span>=<span class="string">"4"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">executor</span>=<span class="string">"tomcatThreadPool"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>每个Connector可以对应一个线程池，默认情况下Tomcat中每个Connector都会创建一个自己的线程池，并且该线程池的默认值为：<strong>最小线程数量为<code>10</code>，最大线程数量为<code>200</code></strong>，若两个Connector配置的executor是一样的话，则表示这两个Connector共用一个线程池。</p>
<p>使用BIO来处理请求时，当<strong>请求数量比较大</strong>时，可以<strong>提高<code>Acceptor</code>线程数量</strong>，提高接收请求的速率，当<strong>请求比较耗时</strong>时，可以<strong>提高线程池<code>Executor</code>的最大线程数量</strong>。</p>
<p>增加线程的目的都是为了提高Tomcat的性能，但一台机器的线程数量并不是越多越好，需要利用压测来最终确定一个更加符合当前业务场景的线程数量。</p>
<p><img src="../../../../../images/Tomcat/Socket请求通过SocketProcessor处理流程.png" alt="BIO Socket请求通过SocketProcessor处理流程"></p>
<p>BIO的处理<strong><a href="../Tomcat处理请求过程">请求</a></strong>和<strong><a href="../Tomcat处理响应过程">响应</a></strong>的流程。</p>
<h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><p>NIO最大的特性就是<strong>非阻塞</strong>，<strong>非阻塞接收socket连接，非阻塞从socket中读取数据，非阻塞从将数据写到socket中</strong>。但在<strong><code>Tomcat7</code></strong>中，只有在从socket中读取<strong>请求行</strong>，<strong>请求头</strong>数据时是<strong>非阻塞</strong>的，在<strong>读取请求体是阻塞</strong>的，<strong>响应数据时也是阻塞</strong>的。因为<code>Tomcat7</code>对应Servlet3.0，Servlet3.0规范中没有考虑NIO，如在具体Servlet中读取请求体的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ServletInputStream inputStream = req.getInputStream();</span><br><span class="line"><span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">while</span> ((n = inputStream.read(bytes)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	System.out.println(<span class="keyword">new</span> String(bytes, <span class="number">0</span>, n));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>inputStream.read()</code>方法的含义就是<strong>阻塞读取数据</strong>，当读取请求体时，如果操作系统中还没有准备好，那么read方法就得阻塞。</p>
<p>而NIO则不一样，NIO中是一旦操作系统中的数据准备好了，那么则会<strong>通知</strong>Java程序可以读取数据了，这里的<strong>通知</strong>很重要，这决定了Java代码到底如何实现，若在Servlet中想利用NIO去读取数据，则在Servlet中肯定就要去监听是否有<strong>通知</strong>过来，比如在Servlet3.1中则增加了NIO相关的定义，这里有<code>Listener</code>，用来监听数据可读的通知，这才是真正的利用了NIO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ServletInputStream inputStream = req.getInputStream();</span><br><span class="line">inputStream.setReadListener(<span class="keyword">new</span> ReadListener() &#123;</span><br><span class="line">  <span class="comment">// 有数据可用时触发</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataAvailable</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 数据全部读完了</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAllDataRead</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 出现异常了  </span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="../../../../../images/Tomcat/NIO处理Socket请求流程.png" alt="NIO处理Socket请求流程"></p>
<p>利用Acceptor来<strong>阻塞</strong>获取socket连接，NIO中叫<code>socketChannel</code>，接收到socketChannel后，需要将<strong><code>socketChannel</code></strong>绑定到一个<strong><code>Selector</code></strong>中并<strong>注册读事件</strong>，基于NIO还需要一个线程来<strong>轮询Selector中是否存在就绪事件</strong>，若存在则将就绪事件查出来，并处理该事件，在Tomcat中支持多个线程同时查询是否存在就绪事件，该线程对象为<strong><code>Poller</code></strong>，<strong>每个Poller中都包含一个Selector</strong>，这样每个Poller线程就负责轮询自己的Selector上就绪的事件，然后处理事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioEndpoint</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>&lt;<span class="title">NioChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>.<span class="title">Acceptor</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> errorDelay = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (running) &#123;</span><br><span class="line">                <span class="keyword">while</span> (paused &amp;&amp; running) &#123;</span><br><span class="line">                    state = AcceptorState.PAUSED;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = AcceptorState.RUNNING;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    countUpOrAwaitConnection();</span><br><span class="line">                    SocketChannel socket = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        socket = serverSock.accept();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                        countDownConnection();</span><br><span class="line">                        errorDelay = handleExceptionWithDelay(errorDelay);</span><br><span class="line">                        <span class="keyword">throw</span> ioe;</span><br><span class="line">                    &#125;</span><br><span class="line">                    errorDelay = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (running &amp;&amp; !paused) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!setSocketOptions(socket)) &#123;</span><br><span class="line">                            countDownConnection();</span><br><span class="line">                            closeSocket(socket);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        countDownConnection();</span><br><span class="line">                        closeSocket(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            state = AcceptorState.ENDED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setSocketOptions</span><span class="params">(SocketChannel socket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 从该channel上读取数据不阻塞</span></span><br><span class="line">            socket.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            Socket sock = socket.socket();</span><br><span class="line">            socketProperties.setProperties(sock);</span><br><span class="line">            <span class="comment">// 每接收到一个socket连接就获取一个NioChannel来封装这个socket，NioChannel是可重用的对象</span></span><br><span class="line">            NioChannel channel = nioChannels.poll(); <span class="comment">// nioChannels是一个缓存队列，拿出对头的NioChannel</span></span><br><span class="line">            <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// SSL setup</span></span><br><span class="line">                <span class="keyword">if</span> (sslContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    SSLEngine engine = createSSLEngine();</span><br><span class="line">                    <span class="keyword">int</span> appbufsize = engine.getSession().getApplicationBufferSize();</span><br><span class="line">                    NioBufferHandler bufhandler = <span class="keyword">new</span> NioBufferHandler(Math.max(appbufsize, socketProperties.getAppReadBufSize()),Math.max(appbufsize, socketProperties.getAppWriteBufSize()), socketProperties.getDirectBuffer());</span><br><span class="line">                    channel = <span class="keyword">new</span> SecureNioChannel(socket, engine, bufhandler, selectorPool);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// normal tcp setup</span></span><br><span class="line">                    NioBufferHandler bufhandler = <span class="keyword">new</span> NioBufferHandler(socketProperties.getAppReadBufSize(), socketProperties.getAppWriteBufSize(), socketProperties.getDirectBuffer());</span><br><span class="line">                    channel = <span class="keyword">new</span> NioChannel(socket, bufhandler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel.setIOChannel(socket);</span><br><span class="line">                <span class="keyword">if</span> (channel <span class="keyword">instanceof</span> SecureNioChannel) &#123;</span><br><span class="line">                    SSLEngine engine = createSSLEngine();</span><br><span class="line">                    ((SecureNioChannel) channel).reset(engine);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    channel.reset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 每接收到一个新socket连接，就会生成一个</span></span><br><span class="line">            getPoller0().register(channel);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> NioChannel socket)</span> </span>&#123;</span><br><span class="line">        socket.setPoller(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 获取一个KeyAttachment对象，将当前socket的相关信息设置进去</span></span><br><span class="line">        KeyAttachment key = keyCache.poll();</span><br><span class="line">        <span class="keyword">final</span> KeyAttachment ka = key != <span class="keyword">null</span> ? key : <span class="keyword">new</span> KeyAttachment(socket);</span><br><span class="line">        ka.reset(<span class="keyword">this</span>, socket, getSocketProperties().getSoTimeout());</span><br><span class="line">        ka.setKeepAliveLeft(NioEndpoint.<span class="keyword">this</span>.getMaxKeepAliveRequests());</span><br><span class="line">        ka.setSecure(isSSLEnabled());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取一个PollerEvent对象，本事件为一个注册事件，对读事件感兴趣（这里暂时还没有真正的向select去注册事件）</span></span><br><span class="line">        PollerEvent r = eventCache.poll();</span><br><span class="line">        ka.interestOps(SelectionKey.OP_READ);<span class="comment">//this is what OP_REGISTER turns into.</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span>)</span><br><span class="line">            r = <span class="keyword">new</span> PollerEvent(socket, ka, OP_REGISTER);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            r.reset(socket, ka, OP_REGISTER);</span><br><span class="line">        <span class="comment">// 把PollerEvent添加到事件列表中去</span></span><br><span class="line">        addEvent(r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEvent</span><span class="params">(Runnable event)</span> </span>&#123;</span><br><span class="line">        events.offer(event);</span><br><span class="line">        <span class="keyword">if</span> (wakeupCounter.incrementAndGet() == <span class="number">0</span>)</span><br><span class="line">            selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当Acceptro接收到一个socketChannel后，就会将socketChannel注册到某一个Poller上，确定Polloer的逻辑非常简单，假设现在有3个Poller，编号为1,2,3，那么Tomcat接收到的第一个socketChannel注册到1号Poller上，第二个socketChannel注册到2号Poller上，第三个socketChannel注册到3号Poller上，第四个socketChannel注册到1号Poller上，依次循环。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Poller <span class="title">getPoller0</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> idx = Math.abs(pollerRotater.incrementAndGet()) % pollers.length;</span><br><span class="line">    <span class="keyword">return</span> pollers[idx];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中的<code>nioChannels</code>，<code>keyCache</code>，<code>eventCache</code>等都是<strong>缓存队列</strong>，为了<strong>避免重复大量的New对象</strong>，以及下面的<code>processorCache</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poller</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (paused &amp;&amp; (!close)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> hasEvents = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                    events();</span><br><span class="line">                    timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        selector.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 执行PollerEvent事件，向Selector注册读写事件</span></span><br><span class="line">                    hasEvents = events(); <span class="comment">// 真正的向selector注册</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!close) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (wakeupCounter.getAndSet(-<span class="number">1</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 上面的events()会去注册事件，而这里是去查询是否有事件就绪，不阻塞</span></span><br><span class="line">                            keyCount = selector.selectNow();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 阻塞，超时会继续执行下面的代码，不会报错</span></span><br><span class="line">                            keyCount = selector.select(selectorTimeout);</span><br><span class="line">                        &#125;</span><br><span class="line">                        wakeupCounter.set(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                        events();</span><br><span class="line">                        timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            selector.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (keyCount == <span class="number">0</span>) hasEvents = (hasEvents | events());</span><br><span class="line">                <span class="comment">// 如果存在就绪事件，那么则遍历并处理事件</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = eyCount &gt; <span class="number">0</span> ? selector.selectedKeys().iterator() : <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// 循环处理当前就绪的事件</span></span><br><span class="line">                <span class="keyword">while</span> (iterator != <span class="keyword">null</span> &amp;&amp; iterator.hasNext()) &#123;</span><br><span class="line">                    SelectionKey sk = iterator.next();</span><br><span class="line">                    KeyAttachment attachment = (KeyAttachment) sk.attachment();</span><br><span class="line">                    <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        iterator.remove();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        attachment.access();</span><br><span class="line">                        iterator.remove();</span><br><span class="line">                        processKey(sk, attachment);<span class="comment">// 处理事件</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="comment">//while</span></span><br><span class="line">                timeout(keyCount, hasEvents);</span><br><span class="line">                <span class="keyword">if</span> (oomParachute &gt; <span class="number">0</span> &amp;&amp; oomParachuteData == <span class="keyword">null</span>) checkParachute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (OutOfMemoryError oom) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    oomParachuteData = <span class="keyword">null</span>;</span><br><span class="line">                    releaseCaches();</span><br><span class="line">                    log.error(<span class="string">""</span>, oom);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="comment">//while</span></span><br><span class="line">        stopLatch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">events</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">        Runnable r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// poll会把元素从队列中删除掉</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = events.size(); i &lt; size &amp;&amp; (r = events.poll()) != <span class="keyword">null</span>; i++) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 如果是PollerEvent，会将读事件注册到当前poller中的selector对象上</span></span><br><span class="line">                r.run();</span><br><span class="line">                <span class="keyword">if</span> (r <span class="keyword">instanceof</span> PollerEvent) &#123;</span><br><span class="line">                    ((PollerEvent) r).reset();</span><br><span class="line">                    eventCache.offer((PollerEvent) r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processKey</span><span class="params">(SelectionKey sk, KeyAttachment attachment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                cancelledKey(sk, SocketStatus.STOP, attachment.comet);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sk.isValid() &amp;&amp; attachment != <span class="keyword">null</span>) &#123;</span><br><span class="line">                attachment.access();<span class="comment">//make sure we don't time out valid sockets</span></span><br><span class="line">                sk.attach(attachment);<span class="comment">//cant remember why this is here</span></span><br><span class="line">                <span class="comment">// 当前就绪事件对应的channel</span></span><br><span class="line">                NioChannel channel = attachment.getChannel();</span><br><span class="line">                <span class="comment">// 读就绪或写就绪</span></span><br><span class="line">                <span class="keyword">if</span> (sk.isReadable() || sk.isWritable()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (attachment.getSendfileData() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        processSendfile(sk, attachment, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (isWorkerAvailable()) &#123;</span><br><span class="line">                            unreg(sk, attachment, sk.readyOps()); <span class="comment">//</span></span><br><span class="line">                            <span class="keyword">boolean</span> closeSocket = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="comment">// Read goes before write</span></span><br><span class="line">                            <span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line">                                <span class="comment">// 从channel中读取数据</span></span><br><span class="line">                                <span class="keyword">if</span> (!processSocket(channel, SocketStatus.OPEN_READ, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                    closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 读完数据之后可能就要写数据</span></span><br><span class="line">                            <span class="keyword">if</span> (!closeSocket &amp;&amp; sk.isWritable()) &#123;</span><br><span class="line">                                <span class="comment">// 将数据写入到channel中</span></span><br><span class="line">                                <span class="keyword">if</span> (!processSocket(channel, SocketStatus.OPEN_WRITE, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                    closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (closeSocket) &#123;</span><br><span class="line">                                cancelledKey(sk, SocketStatus.DISCONNECT, <span class="keyword">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            result = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioEndpoint</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>&lt;<span class="title">NioChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(NioChannel socket, SocketStatus status, <span class="keyword">boolean</span> dispatch)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 该方法是用来从socket中读数据或写数据的，dispatch表示是不是要把这个任务派发给线程池，也就是要不要异步</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            KeyAttachment attachment = (KeyAttachment) socket.getAttachment();</span><br><span class="line">            <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            attachment.setCometNotify(<span class="keyword">false</span>); <span class="comment">//will get reset upon next reg</span></span><br><span class="line">            <span class="comment">// 获取一个SocketProcessor对象</span></span><br><span class="line">            SocketProcessor sc = processorCache.poll();</span><br><span class="line">            <span class="keyword">if</span> (sc == <span class="keyword">null</span>) sc = <span class="keyword">new</span> SocketProcessor(socket, status);</span><br><span class="line">            <span class="keyword">else</span> sc.reset(socket, status);</span><br><span class="line">            <span class="comment">// 派发给线程池</span></span><br><span class="line">            <span class="keyword">if</span> (dispatch &amp;&amp; getExecutor() != <span class="keyword">null</span>) getExecutor().execute(sc);</span><br><span class="line">            <span class="keyword">else</span> sc.run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RejectedExecutionException rx) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// events()中r.run()方法实际上是调用的PollerEvent的run方法，真正将读事件注册到当前poller中的selector对象上</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PollerEvent</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// PollerEvent表示需要注册的事件,</span></span><br><span class="line">    <span class="keyword">protected</span> NioChannel socket;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> interestOps;</span><br><span class="line">    <span class="keyword">protected</span> KeyAttachment key;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (interestOps == OP_REGISTER) &#123;</span><br><span class="line">            <span class="comment">// 真正将读事件注册到当前poller中的selector对象上</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket.getIOChannel().register(socket.getPoller().getSelector(), SelectionKey.OP_READ, key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 如果当前这个channel没有任何注册事件了，表示这个这个socket连接已经关掉了</span></span><br><span class="line">                <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    socket.getPoller().getEndpoint().countDownConnection();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> KeyAttachment att = (KeyAttachment) key.attachment();</span><br><span class="line">                    <span class="keyword">if</span> (att != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (att.isComet() &amp;&amp; (interestOps &amp; OP_CALLBACK) == OP_CALLBACK) &#123;</span><br><span class="line">                            att.setCometNotify(<span class="keyword">true</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            att.setCometNotify(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        interestOps = (interestOps &amp; (~OP_CALLBACK));<span class="comment">//remove the callback flag</span></span><br><span class="line">                        att.access();<span class="comment">//to prevent timeout</span></span><br><span class="line">                        <span class="comment">// 将新注册的事件添加到注册事件列表中</span></span><br><span class="line">                        <span class="keyword">int</span> ops = key.interestOps() | interestOps;</span><br><span class="line">                        att.interestOps(ops);</span><br><span class="line">                        key.interestOps(ops);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        socket.getPoller().cancelledKey(key, SocketStatus.ERROR, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException ckx) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.getPoller().cancelledKey(key, SocketStatus.DISCONNECT, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="comment">//end if</span></span><br><span class="line">    &#125;<span class="comment">//run</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在某一个Poller中，除开有selector外，还有一个ConcurrentLinkedQueue队列events，events表示待执行事件，比如Tomcat要socketChannel注册到selector上，但是Tomcat并没有直接这么做，而是先自己生成一个PollerEvent，然后把PollerEvent加入到队列events中，然后这个队列中的事件会在Poller线程的循环过程中真正执行</p>
<p>Poller线程中需要循环查询selector中是否存在就绪事件，而Tomcat在真正查询之前会先看一下events队列中是否存在待执行事件，如果存在就会先执行，这些事件表示需要向selector上注册事件，比如注册socketChannel的读事件和写事件，所以在真正执行events队列中的事件时就会真正的向selector上注册事件。所以只有先执行events队列中的PollerEvent，Poller线程才能有机会从selector中查询到就绪事件，每个Poller线程一旦查询到就绪事件，就会去处理这些事件，事件无非就是读事件和写事件</p>
<ul>
<li>处理的第一步就是获取当前就绪事件对应的socketChannel，因为我们要向socketChannel中读数据或写数据</li>
<li>处理的第二步就是把socketChannel和当前要做的事情（读或写）封装为SocketProcessor对象</li>
<li>处理的第三步就是把SocketProcessor扔进线程池进行处理</li>
</ul>
<p>在SocketProcessor线程运行时，就会从socketChannel读取数据（假设当前处理的是读事件），并且是非阻塞读，既然是非阻塞读，大概的一个流程就是，某一个Poller中的selector查询到了一个读就绪事件，然后交给一个SocketProcessor线程进行处理，SocketProcessor线程读取数据之后，如果发现请求行和请求头的数据都已经读完了，并解析完了，那么该SocketProcessor线程就会继续把解析后的请求交给Servlet进行处理，Servlet中可能会读取请求体，可能会响应数据，而<strong>不管是读请求体还是响应数据都是阻塞</strong>的，直到Servlet中的逻辑都执行完后，SocketProcessor线程才会运行结束。假如SocketProcessor读到了数据之后，发现请求行或请求头的数据还没有读完，那么本次读事件处理完毕，<strong>需要Poller线程再次查询到就绪读事件才能继续读数据，以及解析数据</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> NioChannel socket = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> SocketStatus status = <span class="keyword">null</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取当前channel上就绪的事件</span></span><br><span class="line">        SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());</span><br><span class="line">        KeyAttachment ka = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ka = (KeyAttachment) key.attachment();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ka != <span class="keyword">null</span> &amp;&amp; ka.isUpgraded() &amp;&amp; SocketStatus.OPEN_WRITE == status) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ka.getWriteThreadLock()) &#123;</span><br><span class="line">                doRun(key, ka);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 在nio中，每产生一个就绪的io事件，就会通过一个线程来处理该事件，需要进行同步</span></span><br><span class="line">            <span class="comment">// 多个线程只能并发处理不同socket,不能处理同一个socket</span></span><br><span class="line">            <span class="keyword">synchronized</span> (socket) &#123;</span><br><span class="line">                doRun(key, ka);	<span class="comment">// 真正处理事件的逻辑</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRun</span><span class="params">(SelectionKey key, KeyAttachment ka)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> handshake = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (socket.isHandshakeComplete() || status == SocketStatus.STOP) &#123;</span><br><span class="line">                        handshake = <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        handshake = socket.handshake(key.isReadable(), key.isWritable());</span><br><span class="line">                        status = SocketStatus.OPEN_READ;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                handshake = -<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException ckx) &#123;</span><br><span class="line">                handshake = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (handshake == <span class="number">0</span>) &#123;</span><br><span class="line">                SocketState state = SocketState.OPEN;</span><br><span class="line">                <span class="keyword">if</span> (status == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    state = handler.process(ka, SocketStatus.OPEN_READ);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = handler.process(ka, status);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (state == SocketState.CLOSED) &#123;</span><br><span class="line">                    close(ka, socket, key, SocketStatus.ERROR);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (handshake == -<span class="number">1</span>) &#123;</span><br><span class="line">                close(ka, socket, key, SocketStatus.DISCONNECT);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ka.getPoller().add(socket, handshake);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CancelledKeyException cx) &#123;</span><br><span class="line">            socket.getPoller().cancelledKey(key, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError oom) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                oomParachuteData = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    socket.getPoller().cancelledKey(key, SocketStatus.ERROR, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                releaseCaches();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                socket.getPoller().cancelledKey(key, SocketStatus.ERROR, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            socket = <span class="keyword">null</span>;</span><br><span class="line">            status = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//return to cache</span></span><br><span class="line">            <span class="keyword">if</span> (running &amp;&amp; !paused) &#123;</span><br><span class="line">                processorCache.offer(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用的<strong><code>handler.process</code></strong>和BIO是同一个方法包括<code>processor.process(wrapper)</code>也是一样，不同的点在于后续解析字节流的逻辑，connections是将未处理完的socket缓存起来，以便下一次事件继续读取数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConnectionHandler</span>&lt;<span class="title">S</span>,<span class="title">P</span> <span class="keyword">extends</span> <span class="title">Processor</span>&lt;<span class="title">S</span>&gt;&gt; <span class="keyword">implements</span> <span class="title">AbstractEndpoint</span>.<span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; wrapper, SocketStatus status)</span> </span>&#123;</span><br><span class="line">        S socket = wrapper.getSocket();</span><br><span class="line">        Processor&lt;S&gt; processor = connections.get(socket);</span><br><span class="line">        <span class="comment">// 设置为非异步，就是同步</span></span><br><span class="line">        wrapper.setAsync(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 从被回收的processor中获取processor</span></span><br><span class="line">                processor = recycledProcessors.poll();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                processor = createProcessor(); <span class="comment">// HTTP11NIOProce</span></span><br><span class="line">            &#125;</span><br><span class="line">            initSsl(wrapper, processor);</span><br><span class="line">            SocketState state = SocketState.CLOSED;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (status == SocketStatus.DISCONNECT &amp;&amp; !processor.isComet()) &#123;</span><br><span class="line">                    <span class="comment">// Do nothing here, just wait for it to get recycled</span></span><br><span class="line">                    <span class="comment">// Don't do this for Comet we need to generate an end</span></span><br><span class="line">                    <span class="comment">// event (see BZ 54022)</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isAsync() || state == SocketState.ASYNC_END) &#123;</span><br><span class="line">                    <span class="comment">// 要么Tomcat线程还没结束，业务线程就已经调用过complete方法了，然后利用while走到这个分支</span></span><br><span class="line">                    <span class="comment">// 要么Tomcat线程结束后，在超时时间内业务线程调用complete方法，然后构造一个新的SocketProcessor对象扔到线程池里走到这个分支</span></span><br><span class="line">                    <span class="comment">// 要么Tomcat线程结束后，超过超时时间了，由AsyncTimeout线程来构造一个SocketProcessor对象扔到线程池里走到这个分支</span></span><br><span class="line">                    <span class="comment">// 不管怎么样，在整个调用异步servlet的流程中，此分支只经历一次，用来将output缓冲区中的内容发送出去</span></span><br><span class="line">                    state = processor.asyncDispatch(status);</span><br><span class="line">                    <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">                        getProtocol().endpoint.removeWaitingRequest(wrapper);</span><br><span class="line">                        state = processor.process(wrapper);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isComet()) &#123;</span><br><span class="line">                    state = processor.event(status);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 大多数情况下走这个分支</span></span><br><span class="line">                    state = processor.process(wrapper);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (state != SocketState.CLOSED &amp;&amp; processor.isAsync()) &#123;</span><br><span class="line">                    <span class="comment">// 代码执行到这里，就去判断一下之前有没有调用过complete方法</span></span><br><span class="line">                    <span class="comment">// 如果调用，那么当前的AsyncState就会从COMPLETE_PENDING--&gt;调用doComplete方法改为COMPLETING，SocketState为ASYNC_END</span></span><br><span class="line">                    <span class="comment">// 如果没有调用，那么当前的AsyncState就会从STARTING--&gt;STARTED，SocketState为LONG</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// 状态转换，有三种情况</span></span><br><span class="line">                    <span class="comment">// 1. COMPLETE_PENDING---&gt;COMPLETING，COMPLETE_PENDING是在调用complete方法时候由STARTING改变过来的</span></span><br><span class="line">                    <span class="comment">// 2. STARTING----&gt;STARTED，STARTED的下一个状态需要有complete方法来改变，会改成COMPLETING</span></span><br><span class="line">                    <span class="comment">// 3. COMPLETING----&gt;DISPATCHED</span></span><br><span class="line">                    state = processor.asyncPostProcess();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果在访问异步servlet时，代码执行到这里，已经调用过complete方法了，那么状态就是SocketState.ASYNC_END</span></span><br><span class="line">            &#125; <span class="keyword">while</span> (state == SocketState.ASYNC_END || state == SocketState.UPGRADING || state == SocketState.UPGRADING_TOMCAT);</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHttp11Processor</span>&lt;<span class="title">S</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractProcessor</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; socketWrapper)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        RequestInfo rp = request.getRequestProcessor();</span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);   <span class="comment">// 设置请求状态为解析状态</span></span><br><span class="line">        <span class="comment">// Setting up the I/O</span></span><br><span class="line">        setSocketWrapper(socketWrapper);</span><br><span class="line">        getInputBuffer().init(socketWrapper, endpoint);     <span class="comment">// 将socket的InputStream与InternalInputBuffer进行绑定</span></span><br><span class="line">        getOutputBuffer().init(socketWrapper, endpoint);    <span class="comment">// 将socket的OutputStream与InternalOutputBuffer进行绑定</span></span><br><span class="line">        keepAlive = <span class="keyword">true</span>;</span><br><span class="line">        comet = <span class="keyword">false</span>;</span><br><span class="line">        openSocket = <span class="keyword">false</span>;</span><br><span class="line">        sendfileInProgress = <span class="keyword">false</span>;</span><br><span class="line">        readComplete = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// NioEndpoint返回true, Bio返回false</span></span><br><span class="line">        <span class="keyword">if</span> (endpoint.getUsePolling()) &#123;</span><br><span class="line">            keptAlive = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            keptAlive = socketWrapper.isKeptAlive();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前活跃的线程数占线程池最大线程数的比例大于75%，那么则关闭KeepAlive，不再支持长连接</span></span><br><span class="line">        <span class="keyword">if</span> (disableKeepAlive()) &#123;</span><br><span class="line">            socketWrapper.setKeepAliveLeft(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// keepAlive默认为true,它的值会从请求中读取</span></span><br><span class="line">        <span class="keyword">while</span> (!getErrorState().isError() &amp;&amp; keepAlive &amp;&amp; !comet &amp;&amp; !isAsync() &amp;&amp; upgradeInbound == <span class="keyword">null</span> &amp;&amp; httpUpgradeHandler == <span class="keyword">null</span> &amp;&amp; !endpoint.isPaused()) &#123;</span><br><span class="line">            <span class="comment">// keepAlive如果为true,接下来需要从socket中不停的获取http请求</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 第一次从socket中读取数据，并设置socket的读取数据的超时时间</span></span><br><span class="line">                <span class="comment">// 对于BIO，一个socket连接建立好后，不一定马上就被Tomcat处理了，其中需要线程池的调度，所以这段等待的时间要算在socket读取数据的时间内</span></span><br><span class="line">                <span class="comment">// 而对于NIO而言，没有阻塞</span></span><br><span class="line">                setRequestLineReadTimeout();</span><br><span class="line">                <span class="comment">// 解析请求行</span></span><br><span class="line">                <span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;</span><br><span class="line">                    <span class="comment">// 下面这个方法在NIO时有用，比如在解析请求行时，如果没有从操作系统读到数据，则上面的方法会返回false</span></span><br><span class="line">                    <span class="comment">// 而下面这个方法会返回true，从而退出while，表示此处read事件处理结束，到下一次read事件发生了，就会从小进入到while中</span></span><br><span class="line">                    <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (endpoint.isPaused()) &#123;</span><br><span class="line">                    <span class="comment">// 503 - Service unavailable</span></span><br><span class="line">                    <span class="comment">// 如果Endpoint被暂停了，则返回503</span></span><br><span class="line">                    response.setStatus(<span class="number">503</span>);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    keptAlive = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="comment">// Set this every time in case limit has been changed via JMX</span></span><br><span class="line">                    <span class="comment">// 每次处理一个请求就重新获取一下请求头和cookies的最大限制</span></span><br><span class="line">                    request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</span><br><span class="line">                    request.getCookies().setLimit(getMaxCookieCount());</span><br><span class="line">                    <span class="comment">// Currently only NIO will ever return false here</span></span><br><span class="line">                    <span class="comment">// 解析请求头</span></span><br><span class="line">                    <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;</span><br><span class="line">                        <span class="comment">// We've read part of the request, don't recycle it</span></span><br><span class="line">                        <span class="comment">// instead associate it with the socket</span></span><br><span class="line">                        openSocket = <span class="keyword">true</span>;</span><br><span class="line">                        readComplete = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!disableUploadTimeout) &#123;</span><br><span class="line">                        setSocketTimeout(connectionUploadTimeout);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">                <span class="comment">// Setting up filters, and parse some request headers</span></span><br><span class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);  <span class="comment">// 设置请求状态为预处理状态</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    prepareRequest();   <span class="comment">// 预处理, 主要从请求中处理处keepAlive属性，以及进行一些验证，以及根据请求分析得到ActiveInputFilter</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果最大的活跃http请求数量仅仅只能为1的话，那么设置keepAlive为false，则不会继续从socket中获取Http请求了</span></span><br><span class="line">                keepAlive = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp; socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果已经达到了keepAlive的最大限制，也设置为false，则不会继续从socket中获取Http请求了</span></span><br><span class="line">                keepAlive = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Process the request in the adapter</span></span><br><span class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE); <span class="comment">// 设置请求的状态为服务状态，表示正在处理请求</span></span><br><span class="line">                    adapter.service(request, response); <span class="comment">// 交给容器处理请求</span></span><br><span class="line">                    <span class="keyword">if</span>(keepAlive &amp;&amp; !getErrorState().isError() &amp;&amp; (response.getErrorException() != <span class="keyword">null</span> || (!isAsync() &amp;&amp; statusDropsConnection(response.getStatus())))) &#123;</span><br><span class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    setCometTimeouts(socketWrapper);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Finish the handling of the request</span></span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDINPUT);  <span class="comment">// 设置请求的状态为处理请求结束</span></span><br><span class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet) &#123;</span><br><span class="line">                <span class="comment">// 当前http请求已经处理完了，做一些收尾工作</span></span><br><span class="line">                endRequest();</span><br><span class="line">            &#125;</span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDOUTPUT); <span class="comment">// 请求状态为输出结束</span></span><br><span class="line">            <span class="keyword">if</span> (getErrorState().isError()) &#123;</span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            request.updateCounters();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet || getErrorState().isError()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (getErrorState().isIoAllowed()) &#123;</span><br><span class="line">                    <span class="comment">// 准备处理下一个请求</span></span><br><span class="line">                    getInputBuffer().nextRequest();</span><br><span class="line">                    getOutputBuffer().nextRequest();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);</span><br><span class="line">            <span class="comment">// 如果处理完当前这个Http请求之后，发现socket里没有下一个请求了,那么就退出当前循环</span></span><br><span class="line">            <span class="comment">// 如果是keepalive，就不会关闭socket, 如果是close就会关闭socket</span></span><br><span class="line">            <span class="comment">// 对于keepalive的情况，因为是一个线程处理一个socket,当退出这个while后，当前线程就会介绍，</span></span><br><span class="line">            <span class="comment">// 当时对于socket来说，它仍然要继续介绍连接，所以又会新开一个线程继续来处理这个socket</span></span><br><span class="line">            <span class="keyword">if</span> (breakKeepAliveLoop(socketWrapper)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当Servlet中通过<code>inputstream.read()</code>来读取请求体数据时，最终执行的是<strong><code>InternalNioInputBuffer.SocketInputBuffer.doRead()</code></strong>方法，该方法中会调用<strong><code>fill(true,true)</code></strong>，第一个参数是<code>timeout</code>，第二个参数是<code>block</code>，block等于true，表示阻塞，<code>fill</code>方法会从操作系统读取数据填充到Tomcat的buf中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">fill</span><span class="params">(<span class="keyword">boolean</span> timeout, <span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException, EOFException </span>&#123;</span><br><span class="line">    <span class="comment">// 读请求体数据的时候需要阻塞读</span></span><br><span class="line">    <span class="keyword">boolean</span> read = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (parsingHeader) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastValid &gt; headerBufferSize) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(sm.getString(<span class="string">"iib.requestheadertoolarge.error"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Do a simple read with a short timeout</span></span><br><span class="line">        read = readSocket(timeout,block)&gt;<span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lastValid = pos = end;</span><br><span class="line">        <span class="comment">// Do a simple read with a short timeout</span></span><br><span class="line">        read = readSocket(timeout, block)&gt;<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">readSocket</span><span class="params">(<span class="keyword">boolean</span> timeout, <span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 读请求体数据的时候需要阻塞读</span></span><br><span class="line">    <span class="keyword">int</span> nRead = <span class="number">0</span>;</span><br><span class="line">    socket.getBufHandler().getReadBuffer().clear();</span><br><span class="line">    <span class="keyword">if</span> ( block ) &#123;</span><br><span class="line">        Selector selector = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            selector = pool.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            NioEndpoint.KeyAttachment att = (NioEndpoint.KeyAttachment) socket.getAttachment();</span><br><span class="line">            <span class="keyword">if</span> (att == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Key must be cancelled."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// socket. selector</span></span><br><span class="line">            nRead = pool.read(socket.getBufHandler().getReadBuffer(), socket, selector, att.getTimeout());</span><br><span class="line">        &#125; <span class="keyword">catch</span> ( EOFException eof ) &#123;</span><br><span class="line">            nRead = -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ( selector != <span class="keyword">null</span> ) pool.put(selector);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 非阻塞读，没有读到不会阻塞，立即返回0，如果在处理这次NIo事件中没有读到数据，那么此事件其实就是处理结束了，等待下一次事件</span></span><br><span class="line">        nRead = socket.read(socket.getBufHandler().getReadBuffer());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        socket.getBufHandler().getReadBuffer().flip();</span><br><span class="line">        socket.getBufHandler().getReadBuffer().limit(nRead);</span><br><span class="line">        expand(nRead + pos);</span><br><span class="line">        <span class="comment">// 把readBuffer中的数据转移到buf中</span></span><br><span class="line">        socket.getBufHandler().getReadBuffer().get(buf, pos, nRead);</span><br><span class="line">        lastValid = pos + nRead;</span><br><span class="line">        <span class="keyword">return</span> nRead;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nRead == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//return false;</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EOFException(sm.getString(<span class="string">"iib.eof.error"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在接下来的<strong>阻塞读取数据流程</strong>中，主要利用的还是<code>Selector</code>，为什么阻塞的时候还要利用Selector呢，因为<strong>socketChannel一开始是非阻塞</strong>的，我们现在如果想把它改成阻塞的，在NIO里是有一个限制的，如果一个socketChannel被设置成了非阻塞的，然后注册了事件，然后又想把socketChannel设置成阻塞的，这时会抛异常。所以在Tomcat中是使用的另外的方式来达到阻塞效果的。</p>
<p>在需要读取请求体数据时，<strong>不能直接利用之前的主<code>Selector</code>了</strong>，<strong>主<code>Selector</code></strong>就是<strong>用来注册新<code>socketChannel</code></strong>的，需要一个<strong>辅助<code>Selector</code></strong>，在读取请求体数据时，<strong>新生成一个辅助<code>Selector</code></strong>，这个辅助Selector用来监听当前请求的读事件，当有数据就绪时，辅助Selector就会查询到此次就绪事件，这时主Selector是监听不到的，因为在这之前主Selector已经取消了对当前socketChannel的事件。</p>
<p>这是辅助Selector的主要作用，<strong><code>inputstream.read()</code></strong>，向辅助Selector注册读事件，加锁（目的是达到阻塞），与辅助Selector对应的有另外一个辅助Poller，辅助Poller负责轮询辅助Selector上发生的就绪事件，一旦轮询到就绪事件就会解锁，从而解阻塞，从socketChannel中读数据，返回，本次read结束。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioSelectorPool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHARED = Boolean.parseBoolean(System.getProperty(<span class="string">"org.apache.tomcat.util.net.NioSelectorShared"</span>, <span class="string">"true"</span>));</span><br><span class="line">    <span class="keyword">protected</span> NioBlockingSelector blockingSelector;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> Selector SHARED_SELECTOR;</span><br><span class="line">    <span class="keyword">protected</span> ConcurrentLinkedQueue&lt;Selector&gt; selectors = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Selector&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Selector <span class="title">getSharedSelector</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (SHARED &amp;&amp; SHARED_SELECTOR == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> ( NioSelectorPool<span class="class">.<span class="keyword">class</span> ) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> ( SHARED_SELECTOR == <span class="keyword">null</span> )  &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (Selector<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                        SHARED_SELECTOR = Selector.open();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  SHARED_SELECTOR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Selector <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( SHARED ) &#123;</span><br><span class="line">            <span class="keyword">return</span> getSharedSelector();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( (!enabled) || active.incrementAndGet() &gt;= maxSelectors ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( enabled ) active.decrementAndGet();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Selector s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            s = selectors.size()&gt;<span class="number">0</span>?selectors.poll():<span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (Selector<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                    s = Selector.open();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> spare.decrementAndGet();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException x ) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (Selector<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                    s = Selector.open();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ( s == <span class="keyword">null</span> ) active.decrementAndGet();<span class="comment">//we were unable to find a selector</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        enabled = <span class="keyword">true</span>;</span><br><span class="line">        getSharedSelector();</span><br><span class="line">        <span class="keyword">if</span> (SHARED) &#123;</span><br><span class="line">            blockingSelector = <span class="keyword">new</span> NioBlockingSelector();</span><br><span class="line">            blockingSelector.open(getSharedSelector());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(ByteBuffer buf, NioChannel socket, Selector selector, <span class="keyword">long</span> writeTimeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> write(buf,socket,selector,writeTimeout,<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(ByteBuffer buf, NioChannel socket, Selector selector, <span class="keyword">long</span> writeTimeout, <span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( SHARED &amp;&amp; block ) &#123;</span><br><span class="line">            <span class="keyword">return</span> blockingSelector.write(buf,socket,writeTimeout);</span><br><span class="line">        &#125;</span><br><span class="line">        SelectionKey key = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> written = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can write 假设现在就可以写</span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 没有超时并且buf中有数据</span></span><br><span class="line">            <span class="keyword">while</span> ( (!timedout) &amp;&amp; buf.hasRemaining() ) &#123;</span><br><span class="line">                <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ( keycount &gt; <span class="number">0</span> ) &#123; <span class="comment">//only write if we were registered for a write</span></span><br><span class="line">                    <span class="comment">// 写数据，返回的数字是多少，表示写了多少，可能返回0，表示没有写入数据</span></span><br><span class="line">                    cnt = socket.write(buf); <span class="comment">//write the data</span></span><br><span class="line">                    <span class="keyword">if</span> (cnt == -<span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">                    written += cnt;</span><br><span class="line">                    <span class="keyword">if</span> (cnt &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 如果有数据写到socket中了，就继续while，看buf中还有没剩余数据</span></span><br><span class="line">                        time = System.currentTimeMillis(); <span class="comment">//reset our timeout timer</span></span><br><span class="line">                        <span class="keyword">continue</span>; <span class="comment">//we successfully wrote, try again without a selector</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 如果没有写入数据并且是阻塞的，则不会break</span></span><br><span class="line">                    <span class="keyword">if</span> (cnt==<span class="number">0</span> &amp;&amp; (!block)) <span class="keyword">break</span>; <span class="comment">//don't block</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( selector != <span class="keyword">null</span> ) &#123;</span><br><span class="line">                    <span class="comment">//register OP_WRITE to the selector</span></span><br><span class="line">                    <span class="comment">// 向selector注册一个写事件</span></span><br><span class="line">                    <span class="keyword">if</span> (key==<span class="keyword">null</span>) key = socket.getIOChannel().register(selector, SelectionKey.OP_WRITE);</span><br><span class="line">                    <span class="keyword">else</span> key.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">                    <span class="comment">// 查询是否有写事件发生</span></span><br><span class="line">                    keycount = selector.select(writeTimeout);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 看是否超时</span></span><br><span class="line">                <span class="keyword">if</span> (writeTimeout &gt; <span class="number">0</span> &amp;&amp; (selector == <span class="keyword">null</span> || keycount == <span class="number">0</span>) ) timedout = (System.currentTimeMillis()-time)&gt;=writeTimeout;</span><br><span class="line">            &#125;<span class="comment">//while</span></span><br><span class="line">            <span class="keyword">if</span> ( timedout ) <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                key.cancel();</span><br><span class="line">                <span class="keyword">if</span> (selector != <span class="keyword">null</span>) selector.selectNow();<span class="comment">//removes the key from this selector</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> written;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer buf, NioChannel socket, Selector selector, <span class="keyword">long</span> readTimeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> read(buf,socket,selector,readTimeout,<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer buf, NioChannel socket, Selector selector, <span class="keyword">long</span> readTimeout, <span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( SHARED &amp;&amp; block ) &#123;</span><br><span class="line">            <span class="keyword">return</span> blockingSelector.read(buf,socket,readTimeout);</span><br><span class="line">        &#125;</span><br><span class="line">        SelectionKey key = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> read = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can write</span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ( (!timedout) ) &#123;</span><br><span class="line">                <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ( keycount &gt; <span class="number">0</span> ) &#123; <span class="comment">//only read if we were registered for a read</span></span><br><span class="line">                    cnt = socket.read(buf);</span><br><span class="line">                    <span class="keyword">if</span> (cnt == -<span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">                    read += cnt;</span><br><span class="line">                    <span class="keyword">if</span> (cnt &gt; <span class="number">0</span>) <span class="keyword">continue</span>; <span class="comment">//read some more</span></span><br><span class="line">                    <span class="keyword">if</span> (cnt==<span class="number">0</span> &amp;&amp; (read&gt;<span class="number">0</span> || (!block) ) ) <span class="keyword">break</span>; <span class="comment">//we are done reading</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( selector != <span class="keyword">null</span> ) &#123;<span class="comment">//perform a blocking read</span></span><br><span class="line">                    <span class="comment">//register OP_WRITE to the selector</span></span><br><span class="line">                    <span class="keyword">if</span> (key==<span class="keyword">null</span>) key = socket.getIOChannel().register(selector, SelectionKey.OP_READ);</span><br><span class="line">                    <span class="keyword">else</span> key.interestOps(SelectionKey.OP_READ);</span><br><span class="line">                    keycount = selector.select(readTimeout);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (readTimeout &gt; <span class="number">0</span> &amp;&amp; (selector == <span class="keyword">null</span> || keycount == <span class="number">0</span>) ) timedout = (System.currentTimeMillis()-time)&gt;=readTimeout;</span><br><span class="line">            &#125;<span class="comment">//while</span></span><br><span class="line">            <span class="keyword">if</span> ( timedout ) <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                key.cancel();</span><br><span class="line">                <span class="keyword">if</span> (selector != <span class="keyword">null</span>) selector.selectNow();<span class="comment">//removes the key from this selector</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> read;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，辅助Selector是<strong><code>NioBlockingSelector</code></strong>对象，每次read都使用<strong>同一个<code>NioBlockingSelector</code></strong>对象，在NioBlockingSelector对象中存在一个<strong>辅助Poller即<code>BlockPoller</code></strong>线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioBlockingSelector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> BlockPoller poller;</span><br><span class="line">    <span class="keyword">protected</span> Selector sharedSelector;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Selector selector)</span> </span>&#123;</span><br><span class="line">        sharedSelector = selector;</span><br><span class="line">        poller = <span class="keyword">new</span> BlockPoller();</span><br><span class="line">        poller.selector = sharedSelector;</span><br><span class="line">        poller.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        poller.setName(<span class="string">"NioBlockingSelector.BlockPoller-"</span>+(++threadCounter));</span><br><span class="line">        poller.start();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer buf, NioChannel socket, <span class="keyword">long</span> readTimeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());</span><br><span class="line">        <span class="keyword">if</span> ( key == <span class="keyword">null</span> ) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Key no longer registered"</span>);</span><br><span class="line">        KeyReference reference = keyReferenceQueue.poll();</span><br><span class="line">        <span class="keyword">if</span> (reference == <span class="keyword">null</span>) &#123;</span><br><span class="line">            reference = <span class="keyword">new</span> KeyReference();</span><br><span class="line">        &#125;</span><br><span class="line">        KeyAttachment att = (KeyAttachment) key.attachment();</span><br><span class="line">        <span class="keyword">int</span> read = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can read</span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!timedout) &#123;</span><br><span class="line">                <span class="keyword">if</span> (keycount &gt; <span class="number">0</span>) &#123; <span class="comment">//only read if we were registered for a read</span></span><br><span class="line">                    <span class="comment">// 先尝试着读一下，如果没有读到数据，则返回0</span></span><br><span class="line">                    read = socket.read(buf);</span><br><span class="line">                    <span class="keyword">if</span> (read == -<span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">                    <span class="keyword">if</span> (read &gt; <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 开启latch</span></span><br><span class="line">                    <span class="keyword">if</span> ( att.getReadLatch()==<span class="keyword">null</span> || att.getReadLatch().getCount()==<span class="number">0</span>) att.startReadLatch(<span class="number">1</span>);</span><br><span class="line">                    <span class="comment">// 将注册读事件，通过events队列和线程实现，poller为BlockPoller</span></span><br><span class="line">                    poller.add(att,SelectionKey.OP_READ, reference);</span><br><span class="line">                    <span class="keyword">if</span> (readTimeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        att.awaitReadLatch(Long.MAX_VALUE, TimeUnit.MILLISECONDS);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 注册完事件后就会阻塞，直到BlockPoller发现了读事件，才会解阻塞</span></span><br><span class="line">                        att.awaitReadLatch(readTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                    Thread.interrupted();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 不是正常被poller解阻塞的</span></span><br><span class="line">                <span class="keyword">if</span> ( att.getReadLatch()!=<span class="keyword">null</span> &amp;&amp; att.getReadLatch().getCount()&gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//we got interrupted, but we haven't received notification from the poller.</span></span><br><span class="line">                    keycount = <span class="number">0</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 解阻塞之后就得到了1个读事件，就可以读取数据了</span></span><br><span class="line">                    <span class="comment">//latch countdown has happened</span></span><br><span class="line">                    keycount = <span class="number">1</span>;</span><br><span class="line">                    att.resetReadLatch();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (readTimeout &gt;= <span class="number">0</span> &amp;&amp; (keycount == <span class="number">0</span>))</span><br><span class="line">                    timedout = (System.currentTimeMillis() - time) &gt;= readTimeout;</span><br><span class="line">            &#125; <span class="comment">//while</span></span><br><span class="line">            <span class="keyword">if</span> (timedout)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            poller.remove(att,SelectionKey.OP_READ);</span><br><span class="line">            <span class="keyword">if</span> (timedout &amp;&amp; reference.key!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                poller.cancelKey(reference.key);</span><br><span class="line">            &#125;</span><br><span class="line">            reference.key = <span class="keyword">null</span>;</span><br><span class="line">            keyReferenceQueue.add(reference);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> read;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockPoller</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> run = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">protected</span> Selector selector = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> ConcurrentLinkedQueue&lt;Runnable&gt; events = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Runnable&gt;();</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> KeyAttachment key, <span class="keyword">final</span> <span class="keyword">int</span> ops, <span class="keyword">final</span> KeyReference ref)</span> </span>&#123;</span><br><span class="line">            Runnable r = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> ( key == <span class="keyword">null</span> ) <span class="keyword">return</span>;</span><br><span class="line">                    NioChannel nch = key.getChannel();</span><br><span class="line">                    <span class="keyword">if</span> ( nch == <span class="keyword">null</span> ) <span class="keyword">return</span>;</span><br><span class="line">                    SocketChannel ch = nch.getIOChannel();</span><br><span class="line">                    <span class="keyword">if</span> ( ch == <span class="keyword">null</span> ) <span class="keyword">return</span>;</span><br><span class="line">                    SelectionKey sk = ch.keyFor(selector);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 将事件注册到BlockPoller的selector上，sharedSelector</span></span><br><span class="line">                        <span class="keyword">if</span> (sk == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            sk = ch.register(selector, ops, key);</span><br><span class="line">                            ref.key = sk;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!sk.isValid()) &#123;</span><br><span class="line">                            cancel(sk,key,ops);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            sk.interestOps(sk.interestOps() | ops);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (CancelledKeyException cx) &#123;</span><br><span class="line">                        cancel(sk,key,ops);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (ClosedChannelException cx) &#123;</span><br><span class="line">                        cancel(sk,key,ops);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 添加进事件队列</span></span><br><span class="line">            events.offer(r);</span><br><span class="line">            <span class="comment">// 添加事件成功后，立即唤醒select.select()方法</span></span><br><span class="line">            wakeup();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">events</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Runnable r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> size = events.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size &amp;&amp; (r = events.poll()) != <span class="keyword">null</span>; i++) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (size &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (run) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    events(); <span class="comment">// 执行PollerEvent实现，就是Runnable</span></span><br><span class="line">                    <span class="keyword">int</span> keyCount = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 这个wakeupCounter只有0，-1，1三中情况</span></span><br><span class="line">                        <span class="keyword">int</span> i = wakeupCounter.get();</span><br><span class="line">                        <span class="comment">// i==1表示添加了PollerEvent，并且上面执行了events方法，所以应该可以直接selectNow查询到事件</span></span><br><span class="line">                        <span class="keyword">if</span> (i&gt;<span class="number">0</span>)</span><br><span class="line">                            keyCount = selector.selectNow();</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 此处i只可能为0，然后改成-1，表示没有添加过PollerEvent，然后阻塞获取</span></span><br><span class="line">                            <span class="comment">// 在阻塞获取就绪事件的过程中，很有可能添加了PollerEvent进入到了events中，并且会被唤醒，调用selector.wakeup()</span></span><br><span class="line">                            wakeupCounter.set(-<span class="number">1</span>);</span><br><span class="line">                            keyCount = selector.select(<span class="number">1000</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 不管有没有查询到就绪事件，都会改为0</span></span><br><span class="line">                        wakeupCounter.set(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (!run) <span class="keyword">break</span>;</span><br><span class="line">                    &#125;<span class="keyword">catch</span> ( NullPointerException x ) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> ( CancelledKeyException x ) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                        ExceptionUtils.handleThrowable(x);</span><br><span class="line">                        log.error(<span class="string">""</span>,x);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iterator = keyCount &gt; <span class="number">0</span> ? selector.selectedKeys().iterator() : <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> (run &amp;&amp; iterator != <span class="keyword">null</span> &amp;&amp; iterator.hasNext()) &#123;</span><br><span class="line">                        SelectionKey sk = iterator.next();</span><br><span class="line">                        KeyAttachment attachment = (KeyAttachment)sk.attachment();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            attachment.access();</span><br><span class="line">                            iterator.remove();</span><br><span class="line">                            sk.interestOps(sk.interestOps() &amp; (~sk.readyOps()));</span><br><span class="line">                            <span class="keyword">if</span> ( sk.isReadable() ) &#123;</span><br><span class="line">                                countDown(attachment.getReadLatch());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (sk.isWritable()) &#123;</span><br><span class="line">                                countDown(attachment.getWriteLatch());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (CancelledKeyException ckx) &#123;</span><br><span class="line">                            sk.cancel();</span><br><span class="line">                            countDown(attachment.getReadLatch());</span><br><span class="line">                            countDown(attachment.getWriteLatch());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="comment">//while</span></span><br><span class="line">                &#125;<span class="keyword">catch</span> ( Throwable t ) &#123;</span><br><span class="line">                    log.error(<span class="string">""</span>,t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            events.clear();</span><br><span class="line">            <span class="keyword">if</span> (selector.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    selector.selectNow();</span><br><span class="line">                &#125;<span class="keyword">catch</span>( Exception ignore ) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (log.isDebugEnabled())log.debug(<span class="string">""</span>,ignore);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于响应也是类似的思路，也是先注册写事件，阻塞，都有写就绪事件时就解阻塞，开始写入数据。</p>

        </div>
        
    <footer class="article-footer">
    </footer>
    </div>
</article>


    
    <nav id="article-nav">
        
            <a href="/Blog/中间件/Tomcat/Tomcat整体架构/" id="article-nav-newer" class="article-nav-link-wrap">
                <strong class="article-nav-caption">Newer</strong>
                <div class="article-nav-title">
                    
                        Tomcat整体架构
                    
                </div>
            </a>
        
        
            <a href="/Blog/中间件/Tomcat/Tomcat处理响应过程/" id="article-nav-older" class="article-nav-link-wrap">
                <strong class="article-nav-caption">Older</strong>
                <div class="article-nav-title">Tomcat处理响应过程</div>
            </a>
        
    </nav>





    
    




    <!-- baidu url auto push script -->
    <script type="text/javascript">
        !function () {
            var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi, r = window.location.href,
                o = document.referrer;
            if (!e.test(r)) {
                var n = "//api.share.baidu.com/s.gif";
                o ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
                var t = new Image;
                t.src = n
            }
        }(window);
    </script>
</section>
    </div>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            YaoYingLong &copy; 2022
            <!-- <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a> -->
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten" rel="external nofollow noopener noreferrer" target="_blank">wikitten</a>
        </div>
    </div>
</footer>
    

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });


</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

</div>
</body>
