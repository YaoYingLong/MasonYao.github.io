<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    
    <title>
        Zookeeper服务端之ZAB |
        
        YingLong</title>
    
    
        <meta name="keywords" content="Zookeeper">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="服务端处理客户端的请求入口是通过NettyServerCnxnFactory无产构造函数中启动Netty服务端时绑定的CnxnChannelHandler的channelRead方法。该构造方法是集群启动时通过QuorumPeerMain的runFromConfig中调用ServerCnxnFactory.createFactory()反射调用。 当收到客户端请求后CnxnChannelHandl">
<meta name="keywords" content="Zookeeper">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookeeper服务端之ZAB">
<meta property="og:url" content="https://yaoyinglong.github.io/Blog/Cloud/Zookeeper/Zookeeper服务端之ZAB/index.html">
<meta property="og:site_name" content="YingLong">
<meta property="og:description" content="服务端处理客户端的请求入口是通过NettyServerCnxnFactory无产构造函数中启动Netty服务端时绑定的CnxnChannelHandler的channelRead方法。该构造方法是集群启动时通过QuorumPeerMain的runFromConfig中调用ServerCnxnFactory.createFactory()反射调用。 当收到客户端请求后CnxnChannelHandl">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2021-12-21T14:53:14.585Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zookeeper服务端之ZAB">
<meta name="twitter:description" content="服务端处理客户端的请求入口是通过NettyServerCnxnFactory无产构造函数中启动Netty服务端时绑定的CnxnChannelHandler的channelRead方法。该构造方法是集群启动时通过QuorumPeerMain的runFromConfig中调用ServerCnxnFactory.createFactory()反射调用。 当收到客户端请求后CnxnChannelHandl">
    

    

    
        <link rel="icon" href="/favicon.ico">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>
</html>
<body>
<div id="container">
    <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">YingLong</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
                <a class="main-nav-link" href="javascript:trigger()">Reading</a>
            </nav>
            
            <div id="search-form-wrap">
    
        <form class="search-form">
            <input type="text" class="ins-search-input search-form-input" placeholder="Search">
            <button type="submit" class="search-form-submit"></button>
        </form>
        <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: '/',
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>
<script type="text/javascript">
    var index = 0
    trigger = function () {
        if (index % 2 == 0) {
            $("#sidebar").css("display", "none");
            $("#main").css("float", "none");
        } else {
            $("#sidebar").css("display", "inline");
            $("#main").css("float", "left");
        }
        index++
    }
</script>

    <div class="outer">
        
        
            <aside id="sidebar">
    
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>

        
        
        
            <ul class="unstyled" id="tree">
                
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Cloud
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Dubbo
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo基础/">Dubbo基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务调用/">Dubbo服务调用</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/SPI机制源码/">SPI机制源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务引入/">Dubbo服务引入</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务导出/">Dubbo服务导出</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo与Spring集成原理/">Dubbo与Spring集成原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            ELK
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch基础/">ElasticSearch基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch实战/">ElasticSearch实战</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch进阶/">ElasticSearch进阶</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            MQ
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            RocketMQ
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/NameServer&Broker启动源码/">NameServer&Broker启动源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ高级特性/">RocketMQ高级特性</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ基础/">RocketMQ基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ消息存储源码/">RocketMQ消息存储源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ生产者源码/">RocketMQ生产者源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ消费者源码/">RocketMQ消费者源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/Consumer启动源码/">Consumer启动源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/Producer启动源码/">Producer启动源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/Kafka基础/">Kafka基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RabbitMQ高级特性及Spring集成/">RabbitMQ高级特性及Spring集成</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RabbitMQ基础/">RabbitMQ基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Nacos
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos Client原理/">Nacos Client原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos Server原理/">Nacos Server原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos问题总结/">Nacos问题总结</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群CP模式/">Nacos集群CP模式</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos配置中心Server原理/">Nacos配置中心Server原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群成员信息同步/">Nacos集群成员信息同步</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群注册服务同步/">Nacos集群注册服务同步</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos配置中心Client原理/">Nacos配置中心Client原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Netty
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Netty/IO模型基础/">IO模型基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty基础/">Netty基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty源码/">Netty源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty进阶/">Netty进阶</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Redis
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis分布式锁实现/">Redis分布式锁实现</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis缓存及性能优化/">Redis缓存及性能优化</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis基础/">Redis基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis集群架构/">Redis集群架构</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Seata
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Seata/Seata集成原理/">Seata集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Seata/Seata分布式事务原理/">Seata分布式事务原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Sentinel
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel配置持久化/">Sentinel配置持久化</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel规则发布源码/">Sentinel规则发布源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/常见限流算法/">常见限流算法</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel限流熔断降级源码/">Sentinel限流熔断降级源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Zookeeper
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper基础/">Zookeeper基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper客户端之ZAB/">Zookeeper客户端之ZAB</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper集群Leader选举/">Zookeeper集群Leader选举</a></li>
                
                    <li class="file active"><a href="/Blog/Cloud/Zookeeper/Zookeeper服务端之ZAB/">Zookeeper服务端之ZAB</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            网关
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/网关/Gateway源码/">Gateway源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Cloud/Feign集成原理/">Feign集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Canal基础/">Canal基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Ribbon集成原理/">Ribbon集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/分布式事务解决方案/">分布式事务解决方案</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/分布式系统常见问题/">分布式系统常见问题</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/秒杀问题及解决方案/">秒杀问题及解决方案</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            DB
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/DB/Explain工具/">Explain工具</a></li>
                
                    <li class="file"><a href="/Blog/DB/MongoDB基础/">MongoDB基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/MVCC与BufferPool缓存机制/">MVCC与BufferPool缓存机制</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL主从架构/">MySQL主从架构</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL事务隔离级别与锁机制/">MySQL事务隔离级别与锁机制</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL内部组件结构/">MySQL内部组件结构</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL基础/">MySQL基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL常用SQL总结/">MySQL常用SQL总结</a></li>
                
                    <li class="file"><a href="/Blog/DB/ShardingSphere基础/">ShardingSphere基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/分库分表/">分库分表</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化一/">索引优化一</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化三/">索引优化三</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化二/">索引优化二</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引的原理与使用/">索引的原理与使用</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Java
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            VM
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/VM/JVM内存池/">JVM内存池</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Minor&Major&Full GC/">Minor&Major&Full GC</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Class文件结构/">Class文件结构</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Java内存区域/">Java内存区域</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/OutOfMemoryError异常/">OOM异常实验</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/内存非配与回收策略/">内存分配与回收策略</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/垃圾收集器/">垃圾收集器</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/堆中对象分配&布局&访问/">堆中对象分配&布局&访问</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/垃圾收集算法/">垃圾收集算法及实现</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/字节码指令/">字节码指令</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/字节码指令手册/">字节码指令手册</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/对象是否存活/">对象是否存活</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/方法调用/">方法调用</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/属性表集合/">属性表集合</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/常量池/">常量池</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/理解GC日志/">理解GC日志</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/类加载器/">类加载器</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/运行时栈帧结构/">运行时栈帧结构</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/类加载过程/">类加载过程</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            基础
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/基础/HashMap源码分析JDK8/">HashMap源码分析JDK8</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/Java实用工具库/">Java实用工具库</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/HashMap源码分析JDK7/">HashMap源码分析JDK7</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/lambda常用总结/">lambda常用总结</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/位运算/">位运算</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/PriorityQueue源码/">PriorityQueue源码</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/动态代理/">动态代理</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/反射基础/">反射基础</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/时间及日期总结/">Java8时间及日期</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/注解实现及应用/">注解实现及应用</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/工具/Java中调用Groovy脚本/">Java中调用Groovy脚本</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/JAVA实用工具/">JAVA实用工具</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/国密SM2/">国密SM2</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/国密SM4/">国密SM4</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            并发
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/并发/BlockingQueue阻塞队列二/">BlockingQueue阻塞队列二</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/AQS与ReentrantLock/">AQS与ReentrantLock</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Callable与Future/">Callable与Future</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ConcurrentHashMap源码JDK7/">ConcurrentHashMap源码JDK7</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Condition原理/">Condition原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Java内存模型/">Java内存模型</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ConcurrentHashMap源码JDK8/">ConcurrentHashMap源码JDK8</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Java与线程/">Java与线程</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/BlockingQueue阻塞队列一/">BlockingQueue阻塞队列一</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ReentrantReadWriteLock原理/">ReentrantReadWriteLock原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ScheduledThreadPoolExecutor/">ScheduledThreadPoolExecutor</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Synchronized总结/">Synchronized总结</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ThreadLocal原理/">ThreadLocal原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/原子性、可见性、有序性/">原子性、可见性、有序性</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Unsafe应用/">Unsafe应用</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Volatile原理/">Volatile原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程安全/">线程安全</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程安全实现方式/">线程安全实现方式</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/同步工具类/">同步工具类</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/锁优化/">锁优化</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程池原理/">线程池原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/操作系统底层/">操作系统底层</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Java/JVM内存参数设置/">JVM内存参数设置</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM调优工具/">JVM调优工具</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM整体概览/">JVM整体概览</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM调优思路/">JVM调优思路</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Maven
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Maven/Maven仓库/">Maven仓库</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven Assembly标签全解/">Maven Assembly标签全解</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven基础/">Maven基础</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven加密JAR包/">Maven加密JAR包</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven个性化打包/">Maven个性化打包</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven属性/">Maven属性</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用/">Maven常用</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用工具/">Maven常用工具</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常见问题总结/">Maven常见问题总结</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用插件/">Maven常用插件</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven插件基础/">Maven插件基础</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven插件编写/">Maven插件编写</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven标签全解/">Maven标签全解</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven生命周期/">Maven生命周期</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven聚合与继承/">Maven聚合与继承</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Spring
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            SpringBoot
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot Jar包启动原理/">SpringBoot Jar包启动原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot资源加载/">SpringBoot资源加载</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot自动装配原理/">SpringBoot自动装配原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot启动原理/">SpringBoot启动原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Spring/AOP切面类解析/">AOP切面类解析</a></li>
                
                    <li class="file"><a href="/Blog/Spring/AOP创建代理与调用/">AOP创建代理与调用</a></li>
                
                    <li class="file"><a href="/Blog/Spring/BeanDefinition解析注册/">BeanDefinition解析注册</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Bean的生命周期/">Bean的生命周期</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Hystrix总结/">Hystrix总结</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Bean的加载过程/">Bean的加载过程</a></li>
                
                    <li class="file"><a href="/Blog/Spring/IoC容器/">IoC容器</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring Gzip压缩/">Spring Gzip压缩</a></li>
                
                    <li class="file"><a href="/Blog/Spring/IoC容器加载过程/">IoC容器加载过程</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc异步/">SpringMvc异步原理及实现</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc加载机制/">SpringMvc加载机制</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring初始化扩展/">Spring初始化扩展</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring整体架构/">Spring整体架构</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc处理分发请求原理/">SpringMvc处理分发请求原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring线程池跨线程数据共享/">Spring线程池跨线程数据共享</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事件监听器/">事件监听器</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事务解析原理/">事务解析原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事务调用原理/">事务调用原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Test
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Test/IT测试总结/">IT测试总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/UT测试总结/">UT测试总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/JMeter日常总结/">JMeter日常总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/LoadRunner日常总结/">LoadRunner日常总结</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            中间件
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Mybatis
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis缓存原理/">Mybatis缓存原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis执行SQL原理/">Mybatis执行SQL原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis集成到Spring原理/">Mybatis集成到Spring原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis配置文件解析原理/">Mybatis配置文件解析原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Tomcat
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/BIO和NIO底层原理对比/">BIO和NIO底层原理对比</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat处理响应过程/">Tomcat处理响应过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat启动过程/">Tomcat启动过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat处理请求过程/">Tomcat处理请求过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat工作原理/">Tomcat工作原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat热部署热加载/">Tomcat热部署热加载</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat整体架构/">Tomcat整体架构</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            云原生
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/云原生/Docker基础/">Docker基础</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Docker Compose基础/">Docker Compose基础</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Docker搭建Prometheus&Grafana/">Docker搭建Prometheus&Grafana</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Kubernetes基础/">Kubernetes基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            杂记
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Git
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Git/GIt基本概念/">Git基本概念</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Git/GIt常用命令/">Git常用命令</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Git/分支管理理解/">分支管理理解</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Linux
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux常用命令/">Linux常用命令</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux基础/">Linux基础</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Shell基础/">Shell基础</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux磁盘与文件系统/">Linux磁盘与文件系统</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/零拷贝技术/">零拷贝技术</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux非常用命令/">Linux非常用命令</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/文件&文件系统压缩打包备份/">Linux压缩打包备份</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Vim编辑器/">Vim编辑器</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Bash和Shell/">Bash与Shell</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            协议族
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/协议族/TCPIP四层&五层模型/">TCP/IP四层&五层模型</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/以太网/">以太网</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/网络基础知识/">网络基础知识</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/地址解析协议/">地址解析协议ARP</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/TCP&UDP协议/">TCP&UDP协议</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/HTTP协议/">HTTP协议</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/HTTPs协议/">HTTPs协议</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/工具/SonarQube配置总结/">SonarQube配置总结</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/IDEA快捷的使用/">IDEA的快捷使用</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/Win实用工具/">Win实用工具</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/XSD使用总结/">XSD实用总结</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            算法
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/算法/二叉搜索树/">二叉搜索树</a></li>
                
                    <li class="file"><a href="/Blog/算法/图基础/">图基础</a></li>
                
                    <li class="file"><a href="/Blog/算法/基础算法/">基础算法</a></li>
                
                    <li class="file"><a href="/Blog/算法/平衡二叉树/">平衡二叉树</a></li>
                
                    <li class="file"><a href="/Blog/算法/排序算法/">排序算法</a></li>
                
                    <li class="file"><a href="/Blog/算法/树基础/">树基础</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法-动态规划/">经典算法-动态规划</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法-栈/">经典算法-栈</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法-链表/">经典算法-链表</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法/">经典算法</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            设计模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            创建型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/单例模式/">单例模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/原型模式/">原型模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/工厂模式/">工厂模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/建造者模式/">建造者模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            结构型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/外观模式/">外观模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/代理模式/">代理模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/组合模式/">组合模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/装饰模式/">装饰模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/适配器模式/">适配器模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/享元模式/">享元模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/桥梁模式/">桥梁模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            行为型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/命令模式/">命令模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/备忘录模式/">备忘录模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/模板方法模式/">模板方法模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/状态模式/">状态模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/中介者模式/">中介者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/策略模式/">策略模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/观察者模式/">观察者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/责任链模式/">责任链模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/迭代器模式/">迭代器模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/访问者模式/">访问者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/解释器模式/">解释器模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/设计模式/SOLID基本原则/">SOLID基本原则</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/设计模式概览/">设计模式概览</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/设计模式对比/">设计模式对比</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            语言
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            CPP
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/CPP/IO流/">IO流</a></li>
                
                    <li class="file"><a href="/Blog/语言/CPP/CPP基础/">CPP基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Go
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/Go/Go基础/">Go基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Python
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/Python/Excel文件数据抽取/">Excel文件数据抽取</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            前端
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/前端/JavaScript基础/">JavaScript基础</a></li>
                
                    <li class="file"><a href="/Blog/语言/前端/TypeScript基础/">TypeScript基础</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/index/"></a></li>
                
            </ul>
        
    </div>
    <script>
        $(document).ready(function () {
            var iconFolderOpenClass = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({duration: 100});
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({duration: 100});
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    subtrees.slideUp({duration: 100});
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({duration: 100});
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if (expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({duration: 100});
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({duration: 100});
                    icon.addClass(iconAllExpandClass);
                }
            });
        });
    </script>

    
</aside>
<div id="toTop" class="fa fa-angle-up"></div>

        
        <section id="main"><article id="post-Cloud/Zookeeper/Zookeeper服务端之ZAB" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
        <i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Cloud/">Cloud</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Cloud/Zookeeper/">Zookeeper</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Zookeeper/">Zookeeper</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/Blog/Cloud/Zookeeper/Zookeeper服务端之ZAB/">
            <time datetime="2021-12-19T16:00:00.000Z" itemprop="datePublished">2021-12-20</time>
        </a>
    </div>


                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            Zookeeper服务端之ZAB
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
            
            
                    
            
            
                <p>服务端处理客户端的请求<strong>入口</strong>是通过<strong><code>NettyServerCnxnFactory</code>无产构造函数</strong>中启动<strong><code>Netty</code>服务端</strong>时绑定的<strong><code>CnxnChannelHandler</code></strong>的<strong><code>channelRead</code></strong>方法。该<strong>构造方法</strong>是<strong>集群启动时</strong>通过<strong><code>QuorumPeerMain</code></strong>的<strong><code>runFromConfig</code></strong>中调用<strong><code>ServerCnxnFactory.createFactory()</code>反射调用</strong>。</p>
<p>当收到客户端请求后<strong><code>CnxnChannelHandler</code></strong>的<strong><code>channelRead</code></strong>方法中调用<strong><code>NettyServerCnxn</code></strong>的<strong><code>processMessage</code></strong>方法从而调用<strong><code>receiveMessage</code></strong>方法，将数据读到<strong><code>ByteBuffer</code></strong>中，然后调用<strong><code>ZooKeeperServer</code></strong>的<strong><code>processPacket</code></strong>处理数据包，最终在<strong><code>submitRequest</code></strong>方法中通过执行<strong><code>firstProcessor</code></strong>的<strong><code>processRequest</code></strong>方法<strong>执行请求处理链</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerCnxnFactory</span> <span class="keyword">extends</span> <span class="title">ServerCnxnFactory</span> </span>&#123;</span><br><span class="line">    CnxnChannelHandler channelHandler = <span class="keyword">new</span> CnxnChannelHandler();</span><br><span class="line">    NettyServerCnxnFactory() &#123;</span><br><span class="line">        x509Util = <span class="keyword">new</span> ClientX509Util();</span><br><span class="line">        <span class="keyword">boolean</span> usePortUnification = Boolean.getBoolean(PORT_UNIFICATION_KEY);</span><br><span class="line">        <span class="keyword">if</span> (usePortUnification) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                QuorumPeerConfig.configureSSLAuth();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (QuorumPeerConfig.ConfigException e) &#123;</span><br><span class="line">                usePortUnification = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.shouldUsePortUnification = usePortUnification;</span><br><span class="line">        <span class="comment">// 初始化Netty线程组</span></span><br><span class="line">        EventLoopGroup bossGroup = NettyUtils.newNioOrEpollEventLoopGroup(NettyUtils.getClientReachableLocalInetAddressCount());</span><br><span class="line">        EventLoopGroup workerGroup = NettyUtils.newNioOrEpollEventLoopGroup();</span><br><span class="line">        ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap()</span><br><span class="line">            .group(bossGroup, workerGroup)</span><br><span class="line">            .channel(NettyUtils.nioOrEpollServerSocketChannel())</span><br><span class="line">            .option(ChannelOption.SO_REUSEADDR, <span class="keyword">true</span>) <span class="comment">// parent channel options</span></span><br><span class="line">            .childOption(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>) <span class="comment">// child channels options</span></span><br><span class="line">            .childOption(ChannelOption.SO_LINGER, -<span class="number">1</span>)</span><br><span class="line">            .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                    <span class="keyword">if</span> (secure) &#123;</span><br><span class="line">                        initSSL(pipeline, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldUsePortUnification) &#123;</span><br><span class="line">                        initSSL(pipeline, <span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    pipeline.addLast(<span class="string">"servercnxnfactory"</span>, channelHandler); <span class="comment">// 绑定业务处理CnxnChannelHandler</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">this</span>.bootstrap = configureBootstrapAllocator(bootstrap);</span><br><span class="line">        <span class="keyword">this</span>.bootstrap.validate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CnxnChannelHandler</span> <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                NettyServerCnxn cnxn = ctx.channel().attr(CONNECTION_ATTRIBUTE).get();</span><br><span class="line">                <span class="keyword">if</span> (cnxn == <span class="keyword">null</span>) &#123;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cnxn.processMessage((ByteBuf) msg); <span class="comment">// 客户端执行命令最终调用该方法</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ReferenceCountUtil.release(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerCnxn</span> <span class="keyword">extends</span> <span class="title">ServerCnxn</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">processMessage</span><span class="params">(ByteBuf buf)</span> </span>&#123;</span><br><span class="line">        checkIsInEventLoop(<span class="string">"processMessage"</span>);</span><br><span class="line">        <span class="keyword">if</span> (throttled.get()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (queuedBuffer == <span class="keyword">null</span>) &#123;</span><br><span class="line">                queuedBuffer = channel.alloc().compositeBuffer();</span><br><span class="line">            &#125;</span><br><span class="line">            appendToQueuedBuffer(buf.retainedDuplicate());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (queuedBuffer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                appendToQueuedBuffer(buf.retainedDuplicate());</span><br><span class="line">                processQueuedBuffer();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                receiveMessage(buf); <span class="comment">// 处理客户端命令</span></span><br><span class="line">                <span class="keyword">if</span> (!closingChannel &amp;&amp; buf.isReadable()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (queuedBuffer == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        queuedBuffer = channel.alloc().compositeBuffer();</span><br><span class="line">                    &#125;</span><br><span class="line">                    appendToQueuedBuffer(buf.retainedSlice(buf.readerIndex(), buf.readableBytes()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(ByteBuf message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(message.isReadable() &amp;&amp; !throttled.get()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bb != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        ByteBuffer dat = bb.duplicate();</span><br><span class="line">                        dat.flip();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (bb.remaining() &gt; message.readableBytes()) &#123;</span><br><span class="line">                        <span class="keyword">int</span> newLimit = bb.position() + message.readableBytes();</span><br><span class="line">                        bb.limit(newLimit);</span><br><span class="line">                    &#125;</span><br><span class="line">                    message.readBytes(bb);</span><br><span class="line">                    bb.limit(bb.capacity());</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        ByteBuffer dat = bb.duplicate();</span><br><span class="line">                        dat.flip();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (bb.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                        packetReceived();</span><br><span class="line">                        bb.flip();</span><br><span class="line">                        ZooKeeperServer zks = <span class="keyword">this</span>.zkServer;</span><br><span class="line">                        <span class="keyword">if</span> (zks == <span class="keyword">null</span> || !zks.isRunning()) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"ZK down"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">                            zks.processPacket(<span class="keyword">this</span>, bb);</span><br><span class="line">                            <span class="keyword">if</span> (zks.shouldThrottle(outstandingCount.incrementAndGet())) &#123;</span><br><span class="line">                                disableRecvNoWait();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            zks.processConnectRequest(<span class="keyword">this</span>, bb);</span><br><span class="line">                            initialized = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        bb = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        ByteBuffer dat = bbLen.duplicate();</span><br><span class="line">                        dat.flip();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (message.readableBytes() &lt; bbLen.remaining()) &#123;</span><br><span class="line">                        bbLen.limit(bbLen.position() + message.readableBytes());</span><br><span class="line">                    &#125;</span><br><span class="line">                    message.readBytes(bbLen);</span><br><span class="line">                    bbLen.limit(bbLen.capacity());</span><br><span class="line">                    <span class="keyword">if</span> (bbLen.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                        bbLen.flip();</span><br><span class="line">                        <span class="keyword">int</span> len = bbLen.getInt();</span><br><span class="line">                        bbLen.clear();</span><br><span class="line">                        <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (checkFourLetterWord(channel, message, len)) &#123;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (len &lt; <span class="number">0</span> || len &gt; BinaryInputArchive.maxBuffer) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Len error "</span> + len);</span><br><span class="line">                        &#125;</span><br><span class="line">                        bb = ByteBuffer.allocate(len);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperServer</span> <span class="keyword">implements</span> <span class="title">SessionExpirer</span>, <span class="title">ServerStats</span>.<span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(ServerCnxn cnxn, ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream bais = <span class="keyword">new</span> ByteBufferInputStream(incomingBuffer);</span><br><span class="line">        BinaryInputArchive bia = BinaryInputArchive.getArchive(bais);</span><br><span class="line">        RequestHeader h = <span class="keyword">new</span> RequestHeader();</span><br><span class="line">        h.deserialize(bia, <span class="string">"header"</span>);</span><br><span class="line">        incomingBuffer = incomingBuffer.slice();</span><br><span class="line">        <span class="keyword">if</span> (h.getType() == OpCode.auth) &#123;</span><br><span class="line">            AuthPacket authPacket = <span class="keyword">new</span> AuthPacket();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(incomingBuffer, authPacket);</span><br><span class="line">            String scheme = authPacket.getScheme();</span><br><span class="line">            AuthenticationProvider ap = ProviderRegistry.getProvider(scheme);</span><br><span class="line">            Code authReturn = KeeperException.Code.AUTHFAILED;</span><br><span class="line">            <span class="keyword">if</span> (ap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    authReturn = ap.handleAuthentication(cnxn, authPacket.getAuth());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    authReturn = KeeperException.Code.AUTHFAILED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (authReturn == KeeperException.Code.OK) &#123;</span><br><span class="line">                ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>, KeeperException.Code.OK.intValue());</span><br><span class="line">                cnxn.sendResponse(rh, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>, KeeperException.Code.AUTHFAILED.intValue());</span><br><span class="line">                cnxn.sendResponse(rh, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                cnxn.sendBuffer(ServerCnxnFactory.closeConn);</span><br><span class="line">                cnxn.disableRecv();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (h.getType() == OpCode.sasl) &#123;</span><br><span class="line">                Record rsp = processSasl(incomingBuffer, cnxn);</span><br><span class="line">                ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>, KeeperException.Code.OK.intValue());</span><br><span class="line">                cnxn.sendResponse(rh, rsp, <span class="string">"response"</span>); <span class="comment">// not sure about 3rd arg..what is it?</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Request si = <span class="keyword">new</span> Request(cnxn, cnxn.getSessionId(), h.getXid(), h.getType(), incomingBuffer, cnxn.getAuthInfo());</span><br><span class="line">                si.setOwner(ServerCnxn.me);</span><br><span class="line">                setLocalSessionFlag(si);</span><br><span class="line">                submitRequest(si);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cnxn.incrOutstandingRequests(h);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitRequest</span><span class="params">(Request si)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (firstProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (state == State.INITIAL) &#123;</span><br><span class="line">                        wait(<span class="number">1000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (firstProcessor == <span class="keyword">null</span> || state != State.RUNNING) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not started"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            touch(si.cnxn);</span><br><span class="line">            <span class="keyword">boolean</span> validpacket = Request.isValid(si.type);</span><br><span class="line">            <span class="keyword">if</span> (validpacket) &#123;</span><br><span class="line">                firstProcessor.processRequest(si);</span><br><span class="line">                <span class="keyword">if</span> (si.cnxn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    incInProcess();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">new</span> UnimplementedRequestProcessor().processRequest(si);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MissingSessionException e) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RequestProcessorException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若是<strong>单机</strong>则是通过<strong><code>ZooKeeperServerMain</code></strong>的<strong><code>runFromConfig</code></strong>中调用<strong><code>ServerCnxnFactory</code></strong>的<strong><code>startup</code></strong>方法，最终调用子类<strong><code>NettyServerCnxnFactory</code></strong>的<strong><code>startup</code></strong>方法从而调用<strong><code>ZooKeeperServer</code></strong>子类<strong><code>LeaderZooKeeperServer</code></strong>的<strong><code>startup</code></strong>方法从而调用其<strong><code>setupRequestProcessors</code></strong>方法完成<strong>Leader请求处理链加载</strong>。若为<strong>集群</strong>则是<strong>在<code>Leader</code>选举出来后</strong>通过<strong><code>Leader</code></strong>的<strong><code>lead</code></strong>方法中调用<strong><code>startZkServer</code></strong>从而调用<strong><code>ZooKeeperServer</code></strong>子类<strong><code>LeaderZooKeeperServer</code></strong>的<strong><code>startup</code></strong>方法从而调用其<strong><code>setupRequestProcessors</code></strong>方法完成<strong>Leader请求处理链加载</strong>。</p>
<p>最终产生的请求处理链为<strong><code>LeaderRequestProcessor</code></strong>、<strong><code>PrepRequestProcessor</code></strong>、<strong><code>ProposalRequestProcessor</code></strong>、<strong><code>CommitProcessor</code></strong>、<strong><code>ToBeAppliedRequestProcessor</code></strong>、<strong><code>FinalRequestProcessor</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Leader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startZkServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lastCommitted = zk.getZxid();</span><br><span class="line">        QuorumVerifier newQV = self.getLastSeenQuorumVerifier();</span><br><span class="line">        Long designatedLeader = getDesignatedLeader(newLeaderProposal, zk.getZxid());</span><br><span class="line">        self.processReconfig(newQV, designatedLeader, zk.getZxid(), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (designatedLeader != self.getId()) &#123;</span><br><span class="line">            allowedToCommit = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        zk.startup(); <span class="comment">// 加载</span></span><br><span class="line">        self.updateElectionVote(getEpoch());</span><br><span class="line">        zk.getZKDatabase().setlastProcessedZxid(zk.getZxid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaderZooKeeperServer</span> <span class="keyword">extends</span> <span class="title">QuorumZooKeeperServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.startup();</span><br><span class="line">        <span class="keyword">if</span> (containerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            containerManager.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupRequestProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestProcessor finalProcessor = <span class="keyword">new</span> FinalRequestProcessor(<span class="keyword">this</span>);</span><br><span class="line">        RequestProcessor toBeAppliedProcessor = <span class="keyword">new</span> Leader.ToBeAppliedRequestProcessor(finalProcessor, getLeader());</span><br><span class="line">        commitProcessor = <span class="keyword">new</span> CommitProcessor(toBeAppliedProcessor, Long.toString(getServerId()), <span class="keyword">false</span>, getZooKeeperServerListener());</span><br><span class="line">        commitProcessor.start();</span><br><span class="line">        ProposalRequestProcessor proposalProcessor = <span class="keyword">new</span> ProposalRequestProcessor(<span class="keyword">this</span>, commitProcessor);</span><br><span class="line">        proposalProcessor.initialize();</span><br><span class="line">        prepRequestProcessor = <span class="keyword">new</span> PrepRequestProcessor(<span class="keyword">this</span>, proposalProcessor);</span><br><span class="line">        prepRequestProcessor.start();</span><br><span class="line">        firstProcessor = <span class="keyword">new</span> LeaderRequestProcessor(<span class="keyword">this</span>, prepRequestProcessor);</span><br><span class="line">        setupContainerManager();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperServer</span> <span class="keyword">implements</span> <span class="title">SessionExpirer</span>, <span class="title">ServerStats</span>.<span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sessionTracker == <span class="keyword">null</span>) &#123;</span><br><span class="line">            createSessionTracker();</span><br><span class="line">        &#125;</span><br><span class="line">        startSessionTracker();</span><br><span class="line">        setupRequestProcessors(); <span class="comment">// 回调子类LeaderZooKeeperServer的setupRequestProcessors方法</span></span><br><span class="line">        registerJMX();</span><br><span class="line">        setState(State.RUNNING);</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="LeaderRequestProcessor"><a href="#LeaderRequestProcessor" class="headerlink" title="LeaderRequestProcessor"></a>LeaderRequestProcessor</h4><p>首先执行<strong><code>LeaderRequestProcessor</code></strong>的<strong><code>processRequest</code></strong>方法完成<strong>检查处理<code>Session</code></strong>，然后继续调用<strong><code>PrepRequestProcessor</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaderRequestProcessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">        Request upgradeRequest = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            upgradeRequest = lzks.checkUpgradeSession(request); <span class="comment">// 检查处理Session</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException ke) &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getHdr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                request.getHdr().setType(OpCode.error);</span><br><span class="line">                request.setTxn(<span class="keyword">new</span> ErrorTxn(ke.code().intValue()));</span><br><span class="line">            &#125;</span><br><span class="line">            request.setException(ke);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (upgradeRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">            nextProcessor.processRequest(upgradeRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        nextProcessor.processRequest(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="PrepRequestProcessor"><a href="#PrepRequestProcessor" class="headerlink" title="PrepRequestProcessor"></a>PrepRequestProcessor</h4><p>调用<strong><code>PrepRequestProcessor</code></strong>的<strong><code>processRequest</code></strong>方法只是将请求任务放入<strong><code>submittedRequests</code>阻塞队列</strong>中，<strong><code>PrepRequestProcessor</code></strong>本身是一个线程类，在<strong><code>LeaderZooKeeperServer</code></strong>中创建时就被启动，当队列中有数据时通过<strong><code>pRequest</code></strong>方法根据<strong><code>OpCode</code></strong>执行对应的逻辑，<strong>主要是做一些校验</strong>，若有变化则将其其添加到<strong><code>ZooKeeperServer</code></strong>的<strong><code>outstandingChanges</code></strong>队列中，然后调用下一个处理器<strong><code>ProposalRequestProcessor</code></strong>，生成<strong>事务<code>zxid</code></strong>处理客户端命令逻辑是<strong>单线程从队列中拿数据处理</strong>保证事务处理的顺序一致性，且只在主节点调用<strong><code>ZooKeeperServer</code></strong>的<strong><code>getNextZxid</code></strong>方法通过<strong><code>AtomicLong</code></strong>自增得到<strong>事务<code>zxid</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrepRequestProcessor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperCriticalThread</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    LinkedBlockingQueue&lt;Request&gt; submittedRequests = <span class="keyword">new</span> LinkedBlockingQueue&lt;Request&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        submittedRequests.add(request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; <span class="comment">// 单线程处理</span></span><br><span class="line">                Request request = submittedRequests.take();</span><br><span class="line">                <span class="keyword">long</span> traceMask = ZooTrace.CLIENT_REQUEST_TRACE_MASK;</span><br><span class="line">                <span class="keyword">if</span> (request.type == OpCode.ping) &#123;</span><br><span class="line">                    traceMask = ZooTrace.CLIENT_PING_TRACE_MASK;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (Request.requestOfDeath == request) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                pRequest(request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RequestProcessorException e) &#123;</span><br><span class="line">            handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">        request.setHdr(<span class="keyword">null</span>);</span><br><span class="line">        request.setTxn(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (request.type) &#123;</span><br><span class="line">                <span class="keyword">case</span> OpCode.createContainer:</span><br><span class="line">                <span class="keyword">case</span> OpCode.create:</span><br><span class="line">                <span class="keyword">case</span> OpCode.create2:</span><br><span class="line">                    CreateRequest create2Request = <span class="keyword">new</span> CreateRequest();</span><br><span class="line">                    pRequest2Txn(request.type, zks.getNextZxid(), request, create2Request, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.createTTL:</span><br><span class="line">                    CreateTTLRequest createTtlRequest = <span class="keyword">new</span> CreateTTLRequest();</span><br><span class="line">                    pRequest2Txn(request.type, zks.getNextZxid(), request, createTtlRequest, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.deleteContainer:</span><br><span class="line">                <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">                    DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest();</span><br><span class="line">                    pRequest2Txn(request.type, zks.getNextZxid(), request, deleteRequest, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">                    SetDataRequest setDataRequest = <span class="keyword">new</span> SetDataRequest();                </span><br><span class="line">                    pRequest2Txn(request.type, zks.getNextZxid(), request, setDataRequest, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.reconfig:</span><br><span class="line">                    ReconfigRequest reconfigRequest = <span class="keyword">new</span> ReconfigRequest();</span><br><span class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, reconfigRequest);</span><br><span class="line">                    pRequest2Txn(request.type, zks.getNextZxid(), request, reconfigRequest, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.setACL:</span><br><span class="line">                    SetACLRequest setAclRequest = <span class="keyword">new</span> SetACLRequest();                </span><br><span class="line">                    pRequest2Txn(request.type, zks.getNextZxid(), request, setAclRequest, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.check:</span><br><span class="line">                    CheckVersionRequest checkRequest = <span class="keyword">new</span> CheckVersionRequest();              </span><br><span class="line">                    pRequest2Txn(request.type, zks.getNextZxid(), request, checkRequest, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.multi:</span><br><span class="line">                    MultiTransactionRecord multiRequest = <span class="keyword">new</span> MultiTransactionRecord();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ByteBufferInputStream.byteBuffer2Record(request.request, multiRequest);</span><br><span class="line">                    &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">                        request.setHdr(<span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zks.getNextZxid(), Time.currentWallTime(), OpCode.multi));</span><br><span class="line">                        <span class="keyword">throw</span> e;</span><br><span class="line">                    &#125;</span><br><span class="line">                    List&lt;Txn&gt; txns = <span class="keyword">new</span> ArrayList&lt;Txn&gt;();</span><br><span class="line">                    <span class="keyword">long</span> zxid = zks.getNextZxid();</span><br><span class="line">                    KeeperException ke = <span class="keyword">null</span>;</span><br><span class="line">                    Map&lt;String, ChangeRecord&gt; pendingChanges = getPendingChanges(multiRequest);</span><br><span class="line">                    <span class="keyword">for</span>(Op op: multiRequest) &#123;</span><br><span class="line">                        Record subrequest = op.toRequestRecord();</span><br><span class="line">                        <span class="keyword">int</span> type;</span><br><span class="line">                        Record txn;</span><br><span class="line">                        <span class="keyword">if</span> (ke != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            type = OpCode.error;</span><br><span class="line">                            txn = <span class="keyword">new</span> ErrorTxn(Code.RUNTIMEINCONSISTENCY.intValue());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123; <span class="comment">/* Prep the request and convert to a Txn */</span></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                pRequest2Txn(op.getType(), zxid, request, subrequest, <span class="keyword">false</span>);</span><br><span class="line">                                type = request.getHdr().getType();</span><br><span class="line">                                txn = request.getTxn();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                                ke = e;</span><br><span class="line">                                type = OpCode.error;</span><br><span class="line">                                txn = <span class="keyword">new</span> ErrorTxn(e.code().intValue());</span><br><span class="line">                                request.setException(e);</span><br><span class="line">                                rollbackPendingChanges(zxid, pendingChanges);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                        BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">                        txn.serialize(boa, <span class="string">"request"</span>) ;</span><br><span class="line">                        ByteBuffer bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line">                        txns.add(<span class="keyword">new</span> Txn(type, bb.array()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    request.setHdr(<span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid, Time.currentWallTime(), request.type));</span><br><span class="line">                    request.setTxn(<span class="keyword">new</span> MultiTxn(txns));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">                <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">                    <span class="keyword">if</span> (!request.isLocalSession()) &#123;</span><br><span class="line">                        pRequest2Txn(request.type, zks.getNextZxid(), request, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.sync:</span><br><span class="line">                <span class="keyword">case</span> OpCode.exists:</span><br><span class="line">                <span class="keyword">case</span> OpCode.getData:</span><br><span class="line">                <span class="keyword">case</span> OpCode.getACL:</span><br><span class="line">                <span class="keyword">case</span> OpCode.getChildren:</span><br><span class="line">                <span class="keyword">case</span> OpCode.getChildren2:</span><br><span class="line">                <span class="keyword">case</span> OpCode.ping:</span><br><span class="line">                <span class="keyword">case</span> OpCode.setWatches:</span><br><span class="line">                <span class="keyword">case</span> OpCode.checkWatches:</span><br><span class="line">                <span class="keyword">case</span> OpCode.removeWatches:</span><br><span class="line">                    zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getHdr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                request.getHdr().setType(OpCode.error);</span><br><span class="line">                request.setTxn(<span class="keyword">new</span> ErrorTxn(e.code().intValue()));</span><br><span class="line">            &#125;</span><br><span class="line">            request.setException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            ByteBuffer bb = request.request;</span><br><span class="line">            <span class="keyword">if</span>(bb != <span class="keyword">null</span>)&#123;</span><br><span class="line">                bb.rewind();</span><br><span class="line">                <span class="keyword">while</span> (bb.hasRemaining()) &#123;</span><br><span class="line">                    sb.append(Integer.toHexString(bb.get() &amp; <span class="number">0xff</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sb.append(<span class="string">"request buffer is null"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (request.getHdr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                request.getHdr().setType(OpCode.error);</span><br><span class="line">                request.setTxn(<span class="keyword">new</span> ErrorTxn(Code.MARSHALLINGERROR.intValue()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        request.zxid = zks.getZxid();</span><br><span class="line">        nextProcessor.processRequest(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperServer</span> <span class="keyword">implements</span> <span class="title">SessionExpirer</span>, <span class="title">ServerStats</span>.<span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong hzxid = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getNextZxid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hzxid.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ProposalRequestProcessor"><a href="#ProposalRequestProcessor" class="headerlink" title="ProposalRequestProcessor"></a>ProposalRequestProcessor</h4><p><strong><code>ProposalRequestProcessor</code></strong>主要完成三件事，首先<strong>调用<code>CommitProcessor</code></strong>，然后<strong>给所有<code>follower</code>发送<code>proposal</code></strong>，最后<strong>将数据存储到本机日志文件中</strong>。若是<strong><code>getData</code></strong>等<strong>不涉及事务变更</strong>的请求，则其<strong>Request的hdr属性为空</strong>，则直接<strong>跳过给follower发送proposal以及将数据保存到本机日志文件中的步骤</strong>。</p>
<p><strong>给所有<code>follower</code>发送<code>proposal</code></strong>是通过调用<strong><code>Leader</code></strong>的<strong><code>propose</code></strong>方法，首先封装要发送给<strong><code>follower</code></strong>的<strong><code>proposal</code></strong>，然后遍历所有follower发送packet，实际是将packet放入各自follower对应<strong><code>LearnerHandler</code></strong>的<strong><code>queuedPackets</code>阻塞队列</strong>中。队列中的数据最终被各自的<strong><code>LearnerHandler</code></strong>线程中调用<strong><code>startSendingPackets</code></strong>方法<strong>启动一个新线程</strong>完成队列的消费从而给<strong><code>follower</code></strong>发送<strong><code>proposal</code></strong>。<strong><code>LearnerHandler</code></strong>线程是在<strong>选举完成后<code>Leader</code>的lead方法</strong>中<strong><code>LearnerCnxAcceptor</code></strong>线程启动中启动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProposalRequestProcessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProposalRequestProcessor</span><span class="params">(LeaderZooKeeperServer zks, RequestProcessor nextProcessor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zks = zks;</span><br><span class="line">        <span class="keyword">this</span>.nextProcessor = nextProcessor;</span><br><span class="line">        AckRequestProcessor ackProcessor = <span class="keyword">new</span> AckRequestProcessor(zks.getLeader());</span><br><span class="line">        syncProcessor = <span class="keyword">new</span> SyncRequestProcessor(zks, ackProcessor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        syncProcessor.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> LearnerSyncRequest)&#123;</span><br><span class="line">            zks.getLeader().processSync((LearnerSyncRequest)request);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextProcessor.processRequest(request); <span class="comment">// 调用CommitProcessor</span></span><br><span class="line">            <span class="keyword">if</span> (request.getHdr() != <span class="keyword">null</span>) &#123; <span class="comment">// 若为getData等不需要同步数据的请求则跳过以下两步</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    zks.getLeader().propose(request); <span class="comment">// 给所有follower发送propose</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (XidRolloverException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RequestProcessorException(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">                syncProcessor.processRequest(request); <span class="comment">// 将数据存储到本机日志文件中，ACK处理</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Leader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Proposal <span class="title">propose</span><span class="params">(Request request)</span> <span class="keyword">throws</span> XidRolloverException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((request.zxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0xffffffffL</span>) &#123;</span><br><span class="line">            String msg = <span class="string">"zxid lower 32 bits have rolled over, forcing re-election, and therefore new epoch start"</span>;</span><br><span class="line">            shutdown(msg);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> XidRolloverException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] data = SerializeUtils.serializeRequest(request);</span><br><span class="line">        proposalStats.setLastBufferSize(data.length);</span><br><span class="line">        QuorumPacket pp = <span class="keyword">new</span> QuorumPacket(Leader.PROPOSAL, request.zxid, data, <span class="keyword">null</span>);</span><br><span class="line">        Proposal p = <span class="keyword">new</span> Proposal();</span><br><span class="line">        p.packet = pp;</span><br><span class="line">        p.request = request;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            p.addQuorumVerifier(self.getQuorumVerifier());</span><br><span class="line">            <span class="keyword">if</span> (request.getHdr().getType() == OpCode.reconfig)&#123;</span><br><span class="line">                self.setLastSeenQuorumVerifier(request.qv, <span class="keyword">true</span>);                     </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (self.getQuorumVerifier().getVersion()&lt;self.getLastSeenQuorumVerifier().getVersion()) &#123;</span><br><span class="line">                p.addQuorumVerifier(self.getLastSeenQuorumVerifier());</span><br><span class="line">            &#125;</span><br><span class="line">            lastProposed = p.packet.getZxid();</span><br><span class="line">            outstandingProposals.put(lastProposed, p);</span><br><span class="line">            sendPacket(pp); <span class="comment">// 遍历follower放入其对应的阻塞队列中</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(QuorumPacket qp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (forwardingFollowers) &#123;</span><br><span class="line">            <span class="keyword">for</span> (LearnerHandler f : forwardingFollowers) &#123;</span><br><span class="line">                f.queuePacket(qp); <span class="comment">// 将Proposal放入对应阻塞队列中</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LearnerHandler</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startSendingPackets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sendingThreadStarted) &#123;</span><br><span class="line">            <span class="comment">// Start sending packets</span></span><br><span class="line">            <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    Thread.currentThread().setName(<span class="string">"Sender-"</span> + sock.getRemoteSocketAddress());</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        sendPackets(); <span class="comment">// 从队列中取出Proposal发送给对应的follower</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;.start();</span><br><span class="line">            sendingThreadStarted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPackets</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> traceMask = ZooTrace.SERVER_PACKET_TRACE_MASK;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                QuorumPacket p;</span><br><span class="line">                p = queuedPackets.poll(); <span class="comment">// 从队列中拿packet发给follower</span></span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bufferedOutput.flush();</span><br><span class="line">                    p = queuedPackets.take();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p == proposalOfDeath) &#123;<span class="comment">// Packet of death!</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p.getType() == Leader.PING) &#123;</span><br><span class="line">                    traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p.getType() == Leader.PROPOSAL) &#123;</span><br><span class="line">                    syncLimitCheck.updateProposal(p.getZxid(), System.nanoTime());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                    ZooTrace.logQuorumPacket(LOG, traceMask, <span class="string">'o'</span>, p);</span><br><span class="line">                &#125;</span><br><span class="line">                oa.writeRecord(p, <span class="string">"packet"</span>); <span class="comment">// 使用jute序列化方式发给follower</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!sock.isClosed()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        sock.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span>(IOException ie) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>将数据存储到本机日志文件中</strong>是通过在<strong><code>ProposalRequestProcessor</code>构造方法</strong>中创建的<strong><code>SyncRequestProcessor</code></strong>和<strong><code>AckRequestProcessor</code></strong>来完成。<strong><code>SyncRequestProcessor</code></strong>也是线程类通过<strong><code>ProposalRequestProcessor</code></strong>的<strong><code>initialize</code></strong>方法启动。</p>
<p>调用<strong><code>SyncRequestProcessor</code></strong>的<strong><code>processRequest</code></strong>方法只是将Request放入到<strong>阻塞队列</strong>中。通过其run方法异步处理，将其更新到事务日志文件中，若是Leader则调用<strong><code>AckRequestProcessor</code></strong>从而调用<strong><code>Leader</code></strong>的<strong><code>processAck</code></strong>方法，通过<strong><code>addAck</code></strong>方法将当前节点<strong><code>ACK</code></strong>放入<strong><code>qvAcksetPairs</code></strong>中，然后调用<strong><code>tryToCommit</code></strong>方法<strong>判断收到的<code>ACK</code>是否超过半数</strong>，若未超过则退出，<strong>若超过则向所有<code>follower</code>发送<code>commit</code>命令且向<code>Observer</code>发送<code>proposal</code></strong>，最后<strong>唤醒<code>CommitProcessor</code>线程的<code>wait</code>等待</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncRequestProcessor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperCriticalThread</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        queuedRequests.add(request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> logCount = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> randRoll = r.nextInt(snapCount/<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Request si = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                    si = queuedRequests.take();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    si = queuedRequests.poll();</span><br><span class="line">                    <span class="keyword">if</span> (si == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        flush(toFlush);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (si == requestOfDeath) &#123; <span class="comment">// 若为失效请求则直接退出</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (si != <span class="keyword">null</span>) &#123;<span class="comment">// track the number of records written to the log</span></span><br><span class="line">                    <span class="keyword">if</span> (zks.getZKDatabase().append(si)) &#123;<span class="comment">// 添加到事务日志文件中</span></span><br><span class="line">                        logCount++;</span><br><span class="line">                        <span class="keyword">if</span> (logCount &gt; (snapCount / <span class="number">2</span> + randRoll)) &#123;</span><br><span class="line">                            randRoll = r.nextInt(snapCount/<span class="number">2</span>);</span><br><span class="line">                            zks.getZKDatabase().rollLog(); <span class="comment">// roll the log</span></span><br><span class="line">                            <span class="keyword">if</span> (snapInProcess != <span class="keyword">null</span> &amp;&amp; snapInProcess.isAlive()) &#123; <span class="comment">// take a snapshot</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                snapInProcess = <span class="keyword">new</span> ZooKeeperThread(<span class="string">"Snapshot Thread"</span>) &#123;</span><br><span class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                        <span class="keyword">try</span> &#123;</span><br><span class="line">                                            zks.takeSnapshot();</span><br><span class="line">                                        &#125; <span class="keyword">catch</span>(Exception e) &#123;&#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;;</span><br><span class="line">                                snapInProcess.start();</span><br><span class="line">                            &#125;</span><br><span class="line">                            logCount = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (nextProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            nextProcessor.processRequest(si);</span><br><span class="line">                            <span class="keyword">if</span> (nextProcessor <span class="keyword">instanceof</span> Flushable) &#123;</span><br><span class="line">                                ((Flushable)nextProcessor).flush();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    toFlush.add(si);</span><br><span class="line">                    <span class="keyword">if</span> (toFlush.size() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                        flush(toFlush);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleException(<span class="keyword">this</span>.getName(), t);</span><br><span class="line">        &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">            running = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">(LinkedList&lt;Request&gt; toFlush)</span> <span class="keyword">throws</span> IOException, RequestProcessorException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (toFlush.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">        zks.getZKDatabase().commit();</span><br><span class="line">        <span class="keyword">while</span> (!toFlush.isEmpty()) &#123;</span><br><span class="line">            Request i = toFlush.remove();</span><br><span class="line">            <span class="keyword">if</span> (nextProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                nextProcessor.processRequest(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nextProcessor != <span class="keyword">null</span> &amp;&amp; nextProcessor <span class="keyword">instanceof</span> Flushable) &#123;</span><br><span class="line">            ((Flushable) nextProcessor).flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AckRequestProcessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        QuorumPeer self = leader.self;</span><br><span class="line">        <span class="keyword">if</span>(self != <span class="keyword">null</span>) leader.processAck(self.getId(), request.zxid, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Leader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processAck</span><span class="params">(<span class="keyword">long</span> sid, <span class="keyword">long</span> zxid, SocketAddress followerAddr)</span> </span>&#123; <span class="comment">// 在LearnerHandler中当Leader接收到Follower的ACK时也会调用该方法</span></span><br><span class="line">        <span class="keyword">if</span> (!allowedToCommit) <span class="keyword">return</span>; <span class="comment">// last op committed was a leader change - from now on </span></span><br><span class="line">        <span class="keyword">if</span> ((zxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (outstandingProposals.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lastCommitted &gt;= zxid) &#123; <span class="comment">// The proposal has already been committed</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Proposal p = outstandingProposals.get(zxid); <span class="comment">// 在ProposalRequestProcessor中给给follower发送propose之前放入</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        p.addAck(sid); <span class="comment">// leader节点直接将ack放入qvAcksetPairs中</span></span><br><span class="line">        <span class="keyword">boolean</span> hasCommitted = tryToCommit(p, zxid, followerAddr);</span><br><span class="line">        <span class="keyword">if</span> (hasCommitted &amp;&amp; p.request != <span class="keyword">null</span> &amp;&amp; p.request.getHdr().getType() == OpCode.reconfig) &#123;</span><br><span class="line">            <span class="keyword">long</span> curZxid = zxid;</span><br><span class="line">            <span class="keyword">while</span> (allowedToCommit &amp;&amp; hasCommitted &amp;&amp; p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                curZxid++;</span><br><span class="line">                p = outstandingProposals.get(curZxid);</span><br><span class="line">                <span class="keyword">if</span> (p != <span class="keyword">null</span>) hasCommitted = tryToCommit(p, curZxid, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryToCommit</span><span class="params">(Proposal p, <span class="keyword">long</span> zxid, SocketAddress followerAddr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (outstandingProposals.containsKey(zxid - <span class="number">1</span>)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!p.hasAllQuorums()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 若ACK未超过半数则直接返回false</span></span><br><span class="line">        &#125;</span><br><span class="line">        outstandingProposals.remove(zxid);</span><br><span class="line">        <span class="keyword">if</span> (p.request != <span class="keyword">null</span>) &#123;</span><br><span class="line">            toBeApplied.add(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (p.request == <span class="keyword">null</span>) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.request.getHdr().getType() == OpCode.reconfig) &#123;</span><br><span class="line">            Long designatedLeader = getDesignatedLeader(p, zxid);</span><br><span class="line">            QuorumVerifier newQV = p.qvAcksetPairs.get(p.qvAcksetPairs.size() - <span class="number">1</span>).getQuorumVerifier();</span><br><span class="line">            self.processReconfig(newQV, designatedLeader, zk.getZxid(), <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (designatedLeader != self.getId()) &#123;</span><br><span class="line">                allowedToCommit = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            commitAndActivate(zxid, designatedLeader);</span><br><span class="line">            informAndActivate(p, designatedLeader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commit(zxid); <span class="comment">// 向follower发送commit命令</span></span><br><span class="line">            inform(p); <span class="comment">// 向Observer同步发送proposal</span></span><br><span class="line">        &#125;</span><br><span class="line">        zk.commitProcessor.commit(p.request); <span class="comment">// 唤醒CommitProcessor线程的wait等待</span></span><br><span class="line">        <span class="keyword">if</span> (pendingSyncs.containsKey(zxid)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (LearnerSyncRequest r : pendingSyncs.remove(zxid)) &#123;</span><br><span class="line">                sendSync(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            lastCommitted = zxid;</span><br><span class="line">        &#125;</span><br><span class="line">        QuorumPacket qp = <span class="keyword">new</span> QuorumPacket(Leader.COMMIT, zxid, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        sendPacket(qp); <span class="comment">// 给所有follower发送COMMIT命令</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inform</span><span class="params">(Proposal proposal)</span> </span>&#123;</span><br><span class="line">        QuorumPacket qp = <span class="keyword">new</span> QuorumPacket(Leader.INFORM, proposal.request.zxid, proposal.packet.getData(), <span class="keyword">null</span>);</span><br><span class="line">        sendObserverPacket(qp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendObserverPacket</span><span class="params">(QuorumPacket qp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (LearnerHandler f : getObservingLearners()) &#123;</span><br><span class="line">            f.queuePacket(qp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncedLearnerTracker</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAck</span><span class="params">(Long sid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> change = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (QuorumVerifierAcksetPair qvAckset : qvAcksetPairs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (qvAckset.getQuorumVerifier().getVotingMembers().containsKey(sid)) &#123;</span><br><span class="line">                qvAckset.getAckset().add(sid);</span><br><span class="line">                change = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> change;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CommitProcessor"><a href="#CommitProcessor" class="headerlink" title="CommitProcessor"></a>CommitProcessor</h4><p>当调用<strong><code>CommitProcessor</code></strong>的<strong><code>processRequest</code></strong>方法时会将Request添加到<strong><code>queuedRequests</code>阻塞队列</strong>中，通过run方法<strong>异步处理</strong>，首先明显<strong><code>queuedRequests</code></strong>不为null，正在等待提交的请求为null，正在提交的请求为null，故不会执行wait方法，<strong>若<code>Request</code>不需要<code>commit</code>如<code>getData</code>等命令，则直接往下执行下一个<code>RequestProcessor</code></strong>，否则将其放入<strong><code>nextPending</code></strong>中，然后执行<strong><code>processCommitted</code></strong>方法时由于<strong><code>committedRequests</code>为空</strong>则什么都不做，当再次执行while时，明显正在等待提交的请求不为null且<strong><code>committedRequests</code></strong>为空，则现场会被wait住。</p>
<p>当Leader收到的选票超过半数时在<strong><code>tryToCommit</code></strong>中调用<strong><code>CommitProcessor</code></strong>的<strong><code>commit</code></strong>方法将request放入<strong><code>committedRequests</code></strong>阻塞队列中且会唤醒<strong><code>CommitProcessor</code></strong>线程，然后执行<strong><code>processCommitted</code></strong>方法从而执行<strong><code>sendToNextProcessor</code></strong>，在<strong><code>CommitWorkRequest</code></strong>的<strong><code>doWork</code></strong>方法中调用下一个请求处理器<strong><code>ToBeAppliedRequestProcessor</code></strong>，且清除当前正在提交的请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommitProcessor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperCriticalThread</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 在提交到来之前一直持有的请求</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;Request&gt; queuedRequests = <span class="keyword">new</span> LinkedBlockingQueue&lt;Request&gt;();</span><br><span class="line">    <span class="comment">// 已提交的请求</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;Request&gt; committedRequests = <span class="keyword">new</span> LinkedBlockingQueue&lt;Request&gt;();</span><br><span class="line">    <span class="comment">// 目前正在等待提交的请求</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> AtomicReference&lt;Request&gt; nextPending = <span class="keyword">new</span> AtomicReference&lt;Request&gt;();</span><br><span class="line">    <span class="comment">// 当前正在提交的请求（即发送到下一个处理器）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Request&gt; currentlyCommitting = <span class="keyword">new</span> AtomicReference&lt;Request&gt;();</span><br><span class="line">    <span class="comment">// 当前正在处理的请求数</span></span><br><span class="line">    <span class="keyword">protected</span> AtomicInteger numRequestsProcessing = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (stopped) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        queuedRequests.add(request);</span><br><span class="line">        <span class="keyword">if</span> (!isWaitingForCommit()) &#123;</span><br><span class="line">            wakeup(); <span class="comment">// 目前正在等待提交的请求为null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(Request request)</span> </span>&#123; <span class="comment">// 被Leader的tryToCommit调用或被LearnerZooKeeperServer的commit方法调用</span></span><br><span class="line">        <span class="keyword">if</span> (stopped || request == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        committedRequests.add(request);</span><br><span class="line">        <span class="keyword">if</span> (!isProcessingCommit()) &#123; <span class="comment">// 正在提交的请求为null</span></span><br><span class="line">            wakeup(); <span class="comment">// 唤醒CommitProcessor线程的wait等待</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Request request;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!stopped) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (!stopped &amp;&amp; ((queuedRequests.isEmpty() || isWaitingForCommit() || isProcessingCommit()) &amp;&amp; (committedRequests.isEmpty() || isProcessingRequest()))) &#123;</span><br><span class="line">                        wait();<span class="comment">// (提交的请求为空 | 正在等待提交的请求不为null | 正在提交的请求数不为null) &amp;&amp; (已提交的请求为null || 正在处理的请求数不为0)</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 正在等待提交的请求为null &amp;&amp; 正在提交的请求为null &amp;&amp; 提交的请求不为null，queuedRequests是阻塞队列没有数据poll会被阻塞</span></span><br><span class="line">                <span class="keyword">while</span> (!stopped &amp;&amp; !isWaitingForCommit() &amp;&amp; !isProcessingCommit() &amp;&amp; (request = queuedRequests.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (needCommit(request)) &#123;</span><br><span class="line">                        nextPending.set(request); <span class="comment">// 放入等待提交请求队列</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 若是不需要执行commit的getData等命令直接往下走</span></span><br><span class="line">                        sendToNextProcessor(request);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                processCommitted(); <span class="comment">// 等待线程被唤醒后返回客户端结果以及写内存数据</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendToNextProcessor</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        numRequestsProcessing.incrementAndGet(); <span class="comment">// 当前正在处理的请求数加一</span></span><br><span class="line">        workerPool.schedule(<span class="keyword">new</span> CommitWorkRequest(request), request.sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processCommitted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Request request;</span><br><span class="line">        <span class="keyword">if</span> (!stopped &amp;&amp; !isProcessingRequest() &amp;&amp; (committedRequests.peek() != <span class="keyword">null</span>)) &#123; <span class="comment">// 当前正在处理的请求数为0，且被提交的请求不为null</span></span><br><span class="line">            <span class="keyword">if</span> (!isWaitingForCommit() &amp;&amp; !queuedRequests.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 正在等待提交的请求为null或queuedRequests中有新请求等待</span></span><br><span class="line">            &#125;</span><br><span class="line">            request = committedRequests.poll();</span><br><span class="line">            <span class="comment">// 与nextPending匹配，以便可以在提交时移动到下一个请求。还想使用nextPending，因为它正确设置了cnxn成员。</span></span><br><span class="line">            Request pending = nextPending.get();</span><br><span class="line">            <span class="keyword">if</span> (pending != <span class="keyword">null</span> &amp;&amp; pending.sessionId == request.sessionId &amp;&amp; pending.cxid == request.cxid) &#123;</span><br><span class="line">                pending.setHdr(request.getHdr());</span><br><span class="line">                pending.setTxn(request.getTxn());</span><br><span class="line">                pending.zxid = request.zxid;</span><br><span class="line">                currentlyCommitting.set(pending);</span><br><span class="line">                nextPending.set(<span class="keyword">null</span>);</span><br><span class="line">                sendToNextProcessor(pending);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 若请求来自其他人则只发送提交数据包</span></span><br><span class="line">                currentlyCommitting.set(request);</span><br><span class="line">                sendToNextProcessor(request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">CommitWorkRequest</span> <span class="keyword">extends</span> <span class="title">WorkerService</span>.<span class="title">WorkRequest</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                nextProcessor.processRequest(request); <span class="comment">// 调用下一个请求处理器ToBeAppliedRequestProcessor</span></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                currentlyCommitting.compareAndSet(request, <span class="keyword">null</span>); <span class="comment">// 若此请求是阻塞处理器提交请求，则清除当前正在提交的请求</span></span><br><span class="line">                <span class="keyword">if</span> (numRequestsProcessing.decrementAndGet() == <span class="number">0</span>) &#123; <span class="comment">// 正在处理的请求数减一</span></span><br><span class="line">                    <span class="keyword">if</span> (!queuedRequests.isEmpty() || !committedRequests.isEmpty()) &#123;</span><br><span class="line">                        wakeup(); <span class="comment">// 减少处理的请求计数，处理器目前可能被阻塞，因为它正在等待管道排空，该情况下若有待处理请求，则将其唤醒</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ToBeAppliedRequestProcessor"><a href="#ToBeAppliedRequestProcessor" class="headerlink" title="ToBeAppliedRequestProcessor"></a>ToBeAppliedRequestProcessor</h4><p>ToBeAppliedRequestProcessor的<strong>下一个<code>RequestProcessor</code>必须是<code>FinalRequestProcessor</code></strong>，其本身没有做什么事，将在请求从<strong><code>toBeApplied</code></strong>中移除，调用<strong><code>FinalRequestProcessor</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ToBeAppliedRequestProcessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    ToBeAppliedRequestProcessor(RequestProcessor next, Leader leader) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(next <span class="keyword">instanceof</span> FinalRequestProcessor)) &#123;</span><br><span class="line">            throw new RuntimeException(ToBeAppliedRequestProcessor.class.getName() + " must be connected to " + FinalRequestProcessor.class.getName() + " not " + next.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.leader = leader;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">        next.processRequest(request);<span class="comment">// 调用下一个请求处理器FinalRequestProcessor</span></span><br><span class="line">        <span class="keyword">if</span> (request.getHdr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> zxid = request.getHdr().getZxid();</span><br><span class="line">            Iterator&lt;Proposal&gt; iter = leader.toBeApplied.iterator();</span><br><span class="line">            <span class="keyword">if</span> (iter.hasNext()) &#123;</span><br><span class="line">                Proposal p = iter.next();</span><br><span class="line">                <span class="keyword">if</span> (p.request != <span class="keyword">null</span> &amp;&amp; p.request.zxid == zxid) &#123;</span><br><span class="line">                    iter.remove(); <span class="comment">// 将在请求从toBeApplied中移除</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FinalRequestProcessor"><a href="#FinalRequestProcessor" class="headerlink" title="FinalRequestProcessor"></a>FinalRequestProcessor</h4><p><strong><code>FinalRequestProcessor</code></strong>会<strong>将数据写入到内存中</strong>，这时客户端才可以真正查到该数据，当调用<strong><code>ZKDatabase</code></strong>的<strong><code>processTxn</code></strong>从而根据请求类型调用具体的方法将数据<strong>更新到<code>DataTree</code>时</strong>，会<strong>触发设置的监听器</strong>，最后<strong>将结果响应给客户端</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FinalRequestProcessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> traceMask = ZooTrace.CLIENT_REQUEST_TRACE_MASK;</span><br><span class="line">        <span class="keyword">if</span> (request.type == OpCode.ping) &#123;</span><br><span class="line">            traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">        &#125;</span><br><span class="line">        ProcessTxnResult rc = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (zks.outstandingChanges) &#123; <span class="comment">// outstandingChanges数据是在PrepRequestProcessor中添加</span></span><br><span class="line">            rc = zks.processTxn(request); <span class="comment">// 写数据到内存中，这这之后客户端节点才可以操作该数据</span></span><br><span class="line">            <span class="keyword">if</span> (request.getHdr() != <span class="keyword">null</span>) &#123; <span class="comment">// request.hdr是为写请求设置的，这是唯一添加到outstandingChanges的请求</span></span><br><span class="line">                TxnHeader hdr = request.getHdr();</span><br><span class="line">                Record txn = request.getTxn();</span><br><span class="line">                <span class="keyword">long</span> zxid = hdr.getZxid();</span><br><span class="line">                <span class="keyword">while</span> (!zks.outstandingChanges.isEmpty() &amp;&amp; zks.outstandingChanges.peek().zxid &lt;= zxid) &#123;</span><br><span class="line">                    ChangeRecord cr = zks.outstandingChanges.remove();</span><br><span class="line">                    <span class="keyword">if</span> (zks.outstandingChangesForPath.get(cr.path) == cr) &#123;</span><br><span class="line">                        zks.outstandingChangesForPath.remove(cr.path);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (request.isQuorum()) &#123; <span class="comment">// do not add non quorum packets to the queue.</span></span><br><span class="line">                zks.getZKDatabase().addCommittedProposal(request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request.type == OpCode.closeSession &amp;&amp; connClosedByClient(request)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (closeSession(zks.serverCnxnFactory, request.sessionId) || closeSession(zks.secureServerCnxnFactory, request.sessionId)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request.cnxn == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ServerCnxn cnxn = request.cnxn;</span><br><span class="line">        String lastOp = <span class="string">"NA"</span>;</span><br><span class="line">        zks.decInProcess();</span><br><span class="line">        Code err = Code.OK;</span><br><span class="line">        Record rsp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getHdr() != <span class="keyword">null</span> &amp;&amp; request.getHdr().getType() == OpCode.error) &#123;</span><br><span class="line">                <span class="keyword">if</span> (request.getException() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> request.getException();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> KeeperException.create(KeeperException.Code.get(((ErrorTxn) request.getTxn()).getErr()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            KeeperException ke = request.getException();</span><br><span class="line">            <span class="keyword">if</span> (ke != <span class="keyword">null</span> &amp;&amp; request.type != OpCode.multi) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ke;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (request.type) &#123; <span class="comment">// 根据request.type生成对应的rsp</span></span><br><span class="line">                <span class="keyword">case</span> OpCode.ping: &#123;</span><br><span class="line">                    zks.serverStats().updateLatency(request.createTime);</span><br><span class="line">                    lastOp = <span class="string">"PING"</span>;</span><br><span class="line">                    cnxn.updateStatsForResponse(request.cxid, request.zxid, lastOp, request.createTime, Time.currentElapsedTime());</span><br><span class="line">                    cnxn.sendResponse(<span class="keyword">new</span> ReplyHeader(-<span class="number">2</span>, zks.getZKDatabase().getDataTreeLastProcessedZxid(), <span class="number">0</span>), <span class="keyword">null</span>, <span class="string">"response"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.createSession: &#123;</span><br><span class="line">                    zks.serverStats().updateLatency(request.createTime);</span><br><span class="line">                    lastOp = <span class="string">"SESS"</span>;</span><br><span class="line">                    cnxn.updateStatsForResponse(request.cxid, request.zxid, lastOp, request.createTime, Time.currentElapsedTime());</span><br><span class="line">                    zks.finishSessionInit(request.cnxn, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.create: &#123;</span><br><span class="line">                    lastOp = <span class="string">"CREA"</span>;</span><br><span class="line">                    rsp = <span class="keyword">new</span> CreateResponse(rc.path);</span><br><span class="line">                    err = Code.get(rc.err);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.create2:</span><br><span class="line">                <span class="keyword">case</span> OpCode.createTTL:</span><br><span class="line">                <span class="keyword">case</span> OpCode.createContainer: &#123;</span><br><span class="line">                    lastOp = <span class="string">"CREA"</span>;</span><br><span class="line">                    rsp = <span class="keyword">new</span> Create2Response(rc.path, rc.stat);</span><br><span class="line">                    err = Code.get(rc.err);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">                <span class="keyword">case</span> OpCode.deleteContainer: &#123;</span><br><span class="line">                    lastOp = <span class="string">"DELE"</span>;</span><br><span class="line">                    err = Code.get(rc.err);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.setData: &#123;</span><br><span class="line">                    lastOp = <span class="string">"SETD"</span>;</span><br><span class="line">                    rsp = <span class="keyword">new</span> SetDataResponse(rc.stat);</span><br><span class="line">                    err = Code.get(rc.err);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.sync: &#123;</span><br><span class="line">                    lastOp = <span class="string">"SYNC"</span>;</span><br><span class="line">                    SyncRequest syncRequest = <span class="keyword">new</span> SyncRequest();</span><br><span class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                                                            syncRequest);</span><br><span class="line">                    rsp = <span class="keyword">new</span> SyncResponse(syncRequest.getPath());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.getData: &#123;</span><br><span class="line">                    lastOp = <span class="string">"GETD"</span>;</span><br><span class="line">                    GetDataRequest getDataRequest = <span class="keyword">new</span> GetDataRequest();</span><br><span class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, getDataRequest);</span><br><span class="line">                    DataNode n = zks.getZKDatabase().getNode(getDataRequest.getPath());</span><br><span class="line">                    <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">                    &#125;</span><br><span class="line">                    PrepRequestProcessor.checkACL(zks, zks.getZKDatabase().aclForNode(n), ZooDefs.Perms.READ, request.authInfo);</span><br><span class="line">                    Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">                    <span class="keyword">byte</span> b[] = zks.getZKDatabase().getData(getDataRequest.getPath(), stat, getDataRequest.getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">                    rsp = <span class="keyword">new</span> GetDataResponse(b, stat);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.setWatches: &#123;</span><br><span class="line">                    lastOp = <span class="string">"SETW"</span>;</span><br><span class="line">                    SetWatches setWatches = <span class="keyword">new</span> SetWatches();</span><br><span class="line">                    <span class="comment">// XXX We really should NOT need this!!!!</span></span><br><span class="line">                    request.request.rewind();</span><br><span class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, setWatches);</span><br><span class="line">                    <span class="keyword">long</span> relativeZxid = setWatches.getRelativeZxid();</span><br><span class="line">                    zks.getZKDatabase().setWatches(relativeZxid, setWatches.getDataWatches(), setWatches.getExistWatches(), setWatches.getChildWatches(), cnxn);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OpCode.getChildren: &#123;</span><br><span class="line">                    lastOp = <span class="string">"GETC"</span>;</span><br><span class="line">                    GetChildrenRequest getChildrenRequest = <span class="keyword">new</span> GetChildrenRequest();</span><br><span class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, getChildrenRequest);</span><br><span class="line">                    DataNode n = zks.getZKDatabase().getNode(getChildrenRequest.getPath());</span><br><span class="line">                    <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">                    &#125;</span><br><span class="line">                    PrepRequestProcessor.checkACL(zks, zks.getZKDatabase().aclForNode(n), ZooDefs.Perms.READ, request.authInfo);</span><br><span class="line">                    List&lt;String&gt; children = zks.getZKDatabase().getChildren(getChildrenRequest.getPath(), <span class="keyword">null</span>, getChildrenRequest.getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">                    rsp = <span class="keyword">new</span> GetChildrenResponse(children);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> lastZxid = zks.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">        ReplyHeader hdr = <span class="keyword">new</span> ReplyHeader(request.cxid, lastZxid, err.intValue());</span><br><span class="line">        zks.serverStats().updateLatency(request.createTime);</span><br><span class="line">        cnxn.updateStatsForResponse(request.cxid, lastZxid, lastOp, request.createTime, Time.currentElapsedTime());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cnxn.sendResponse(hdr, rsp, <span class="string">"response"</span>); <span class="comment">// 响应客户端</span></span><br><span class="line">            <span class="keyword">if</span> (request.type == OpCode.closeSession) &#123;</span><br><span class="line">                cnxn.sendCloseSession();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperServer</span> <span class="keyword">implements</span> <span class="title">SessionExpirer</span>, <span class="title">ServerStats</span>.<span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessTxnResult <span class="title">processTxn</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> processTxn(request, request.getHdr(), request.getTxn());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ProcessTxnResult <span class="title">processTxn</span><span class="params">(Request request, TxnHeader hdr, Record txn)</span> </span>&#123;</span><br><span class="line">        ProcessTxnResult rc;</span><br><span class="line">        <span class="keyword">int</span> opCode = request != <span class="keyword">null</span> ? request.type : hdr.getType();</span><br><span class="line">        <span class="keyword">long</span> sessionId = request != <span class="keyword">null</span> ? request.sessionId : hdr.getClientId();</span><br><span class="line">        <span class="keyword">if</span> (hdr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            rc = getZKDatabase().processTxn(hdr, txn); <span class="comment">// 写数据到内存中</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rc = <span class="keyword">new</span> ProcessTxnResult();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opCode == OpCode.createSession) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hdr != <span class="keyword">null</span> &amp;&amp; txn <span class="keyword">instanceof</span> CreateSessionTxn) &#123;</span><br><span class="line">                CreateSessionTxn cst = (CreateSessionTxn) txn;</span><br><span class="line">                sessionTracker.addGlobalSession(sessionId, cst.getTimeOut());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request != <span class="keyword">null</span> &amp;&amp; request.isLocalSession()) &#123;</span><br><span class="line">                request.request.rewind();</span><br><span class="line">                <span class="keyword">int</span> timeout = request.request.getInt();</span><br><span class="line">                request.request.rewind();</span><br><span class="line">                sessionTracker.addSession(request.sessionId, timeout);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opCode == OpCode.closeSession) &#123;</span><br><span class="line">            sessionTracker.removeSession(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZKDatabase</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessTxnResult <span class="title">processTxn</span><span class="params">(TxnHeader hdr, Record txn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataTree.processTxn(hdr, txn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessTxnResult <span class="title">processTxn</span><span class="params">(TxnHeader header, Record txn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.processTxn(header, txn, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessTxnResult <span class="title">processTxn</span><span class="params">(TxnHeader header, Record txn, <span class="keyword">boolean</span> isSubTxn)</span> </span>&#123;</span><br><span class="line">        ProcessTxnResult rc = <span class="keyword">new</span> ProcessTxnResult();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rc.clientId = header.getClientId();</span><br><span class="line">            rc.cxid = header.getCxid();</span><br><span class="line">            rc.zxid = header.getZxid();</span><br><span class="line">            rc.type = header.getType();</span><br><span class="line">            rc.err = <span class="number">0</span>;</span><br><span class="line">            rc.multiResult = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">switch</span> (header.getType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> OpCode.create:</span><br><span class="line">                    CreateTxn createTxn = (CreateTxn) txn;</span><br><span class="line">                    rc.path = createTxn.getPath();</span><br><span class="line">                    createNode(createTxn.getPath(), createTxn.getData(), createTxn.getAcl(), createTxn.getEphemeral() ? header.getClientId() : <span class="number">0</span>, createTxn.getParentCVersion(), header.getZxid(), header.getTime(), <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.create2:</span><br><span class="line">                    CreateTxn create2Txn = (CreateTxn) txn;</span><br><span class="line">                    rc.path = create2Txn.getPath();</span><br><span class="line">                    Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">                    createNode(create2Txn.getPath(), create2Txn.getData(), create2Txn.getAcl(), create2Txn.getEphemeral() ? header.getClientId() : <span class="number">0</span>, create2Txn.getParentCVersion(), header.getZxid(), header.getTime(), stat);</span><br><span class="line">                    rc.stat = stat;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.createTTL:</span><br><span class="line">                    CreateTTLTxn createTtlTxn = (CreateTTLTxn) txn;</span><br><span class="line">                    rc.path = createTtlTxn.getPath();</span><br><span class="line">                    stat = <span class="keyword">new</span> Stat();</span><br><span class="line">                    createNode(createTtlTxn.getPath(), createTtlTxn.getData(), createTtlTxn.getAcl(), EphemeralType.TTL.toEphemeralOwner(createTtlTxn.getTtl()), createTtlTxn.getParentCVersion(), header.getZxid(), header.getTime(), stat);</span><br><span class="line">                    rc.stat = stat;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.createContainer:</span><br><span class="line">                    CreateContainerTxn createContainerTxn = (CreateContainerTxn) txn;</span><br><span class="line">                    rc.path = createContainerTxn.getPath();</span><br><span class="line">                    stat = <span class="keyword">new</span> Stat();</span><br><span class="line">                    createNode(createContainerTxn.getPath(), createContainerTxn.getData(), createContainerTxn.getAcl(), EphemeralType.CONTAINER_EPHEMERAL_OWNER, createContainerTxn.getParentCVersion(), header.getZxid(), header.getTime(), stat);</span><br><span class="line">                    rc.stat = stat;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">                <span class="keyword">case</span> OpCode.deleteContainer:</span><br><span class="line">                    DeleteTxn deleteTxn = (DeleteTxn) txn;</span><br><span class="line">                    rc.path = deleteTxn.getPath();</span><br><span class="line">                    deleteNode(deleteTxn.getPath(), header.getZxid());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.reconfig:</span><br><span class="line">                <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">                    SetDataTxn setDataTxn = (SetDataTxn) txn;</span><br><span class="line">                    rc.path = setDataTxn.getPath();</span><br><span class="line">                    rc.stat = setData(setDataTxn.getPath(), setDataTxn.getData(), setDataTxn.getVersion(), header.getZxid(), header.getTime());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">                    killSession(header.getClientId(), header.getZxid());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            rc.err = e.code().intValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (!isSubTxn) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rc.zxid &gt; lastProcessedZxid) &#123;</span><br><span class="line">                lastProcessedZxid = rc.zxid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (header.getType() == OpCode.create &amp;&amp; rc.err == Code.NODEEXISTS.intValue()) &#123;</span><br><span class="line">            <span class="keyword">int</span> lastSlash = rc.path.lastIndexOf(<span class="string">'/'</span>);</span><br><span class="line">            String parentName = rc.path.substring(<span class="number">0</span>, lastSlash);</span><br><span class="line">            CreateTxn cTxn = (CreateTxn)txn;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                setCversionPzxid(parentName, cTxn.getParentCVersion(), header.getZxid());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</span><br><span class="line">                rc.err = e.code().intValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataTree</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createNode</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl, <span class="keyword">long</span> ephemeralOwner, <span class="keyword">int</span> parentCVersion, <span class="keyword">long</span> zxid, <span class="keyword">long</span> time, Stat outputStat)</span> <span class="keyword">throws</span> KeeperException.NoNodeException, KeeperException.NodeExistsException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</span><br><span class="line">        String parentName = path.substring(<span class="number">0</span>, lastSlash);</span><br><span class="line">        String childName = path.substring(lastSlash + <span class="number">1</span>);</span><br><span class="line">        StatPersisted stat = <span class="keyword">new</span> StatPersisted();</span><br><span class="line">        stat.setCtime(time);</span><br><span class="line">        stat.setMtime(time);</span><br><span class="line">        stat.setCzxid(zxid);</span><br><span class="line">        stat.setMzxid(zxid);</span><br><span class="line">        stat.setPzxid(zxid);</span><br><span class="line">        stat.setVersion(<span class="number">0</span>);</span><br><span class="line">        stat.setAversion(<span class="number">0</span>);</span><br><span class="line">        stat.setEphemeralOwner(ephemeralOwner);</span><br><span class="line">        DataNode parent = nodes.get(parentName);</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (parent) &#123;</span><br><span class="line">            Set&lt;String&gt; children = parent.getChildren();</span><br><span class="line">            <span class="keyword">if</span> (children.contains(childName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NodeExistsException();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (parentCVersion == -<span class="number">1</span>) &#123;</span><br><span class="line">                parentCVersion = parent.stat.getCversion();</span><br><span class="line">                parentCVersion++;</span><br><span class="line">            &#125;</span><br><span class="line">            parent.stat.setCversion(parentCVersion);</span><br><span class="line">            parent.stat.setPzxid(zxid);</span><br><span class="line">            Long longval = aclCache.convertAcls(acl);</span><br><span class="line">            DataNode child = <span class="keyword">new</span> DataNode(data, longval, stat);</span><br><span class="line">            parent.addChild(childName);</span><br><span class="line">            nodes.put(path, child);</span><br><span class="line">            EphemeralType ephemeralType = EphemeralType.get(ephemeralOwner);</span><br><span class="line">            <span class="keyword">if</span> (ephemeralType == EphemeralType.CONTAINER) &#123;</span><br><span class="line">                containers.add(path);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ephemeralType == EphemeralType.TTL) &#123;</span><br><span class="line">                ttls.add(path);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ephemeralOwner != <span class="number">0</span>) &#123;</span><br><span class="line">                HashSet&lt;String&gt; list = ephemerals.get(ephemeralOwner);</span><br><span class="line">                <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    list = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">                    ephemerals.put(ephemeralOwner, list);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">                    list.add(path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (outputStat != <span class="keyword">null</span>) &#123;</span><br><span class="line">                child.copyStat(outputStat);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (parentName.startsWith(quotaZookeeper)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Quotas.limitNode.equals(childName)) &#123;</span><br><span class="line">                pTrie.addPath(parentName.substring(quotaZookeeper.length()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Quotas.statNode.equals(childName)) &#123;</span><br><span class="line">                updateQuotaForPath(parentName.substring(quotaZookeeper.length()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String lastPrefix = getMaxPrefixWithQuota(path);</span><br><span class="line">        <span class="keyword">if</span>(lastPrefix != <span class="keyword">null</span>) &#123; <span class="comment">// ok we have some match and need to update</span></span><br><span class="line">            updateCount(lastPrefix, <span class="number">1</span>);</span><br><span class="line">            updateBytes(lastPrefix, data == <span class="keyword">null</span> ? <span class="number">0</span> : data.length);</span><br><span class="line">        &#125;</span><br><span class="line">        dataWatches.triggerWatch(path, Event.EventType.NodeCreated);</span><br><span class="line">        childWatches.triggerWatch(parentName.equals(<span class="string">""</span>) ? <span class="string">"/"</span> : parentName, Event.EventType.NodeChildrenChanged);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="与Follower交互"><a href="#与Follower交互" class="headerlink" title="与Follower交互"></a>与Follower交互</h4><p>在<strong><code>LearnerHandler</code></strong>的<strong><code>run</code></strong>方法中会<strong>死循环接收从节点发来的数据</strong>，然后根据请求类型做响应的逻辑，当收到ACK请求时，将调用<strong><code>Leader</code></strong>的<strong><code>processAck</code></strong>方法收集ACK投票，当<strong>票数超过一半</strong>时<strong>唤醒<code>CommitProcessor</code>线程</strong>的wait等待。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LearnerHandler</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            leader.addLearnerHandler(<span class="keyword">this</span>);</span><br><span class="line">            tickOfNextAckDeadline = leader.self.tick.get() + leader.self.initLimit + leader.self.syncLimit;</span><br><span class="line">            ia = BinaryInputArchive.getArchive(bufferedInput);</span><br><span class="line">            bufferedOutput = <span class="keyword">new</span> BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">            oa = BinaryOutputArchive.getArchive(bufferedOutput);</span><br><span class="line">            QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">            <span class="keyword">if</span> (qp.getType() != Leader.FOLLOWERINFO &amp;&amp; qp.getType() != Leader.OBSERVERINFO) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">byte</span> learnerInfoData[] = qp.getData();</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ByteBuffer bbsid = ByteBuffer.wrap(learnerInfoData);</span><br><span class="line">                <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">8</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.sid = bbsid.getLong();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">12</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.version = bbsid.getInt(); <span class="comment">// protocolVersion</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (learnerInfoData.length &gt;= <span class="number">20</span>) &#123;</span><br><span class="line">                    <span class="keyword">long</span> configVersion = bbsid.getLong();</span><br><span class="line">                    <span class="keyword">if</span> (configVersion &gt; leader.self.getQuorumVerifier().getVersion()) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Follower is ahead of the leader (has a later activated configuration)"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.sid = leader.followerCounter.getAndDecrement();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (qp.getType() == Leader.OBSERVERINFO) &#123;</span><br><span class="line">                learnerType = LearnerType.OBSERVER;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> lastAcceptedEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line">            <span class="keyword">long</span> peerLastZxid;</span><br><span class="line">            StateSummary ss = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">long</span> zxid = qp.getZxid();</span><br><span class="line">            <span class="keyword">long</span> newEpoch = leader.getEpochToPropose(<span class="keyword">this</span>.getSid(), lastAcceptedEpoch);</span><br><span class="line">            <span class="keyword">long</span> newLeaderZxid = ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.getVersion() &lt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> epoch = ZxidUtils.getEpochFromZxid(zxid);</span><br><span class="line">                ss = <span class="keyword">new</span> StateSummary(epoch, zxid);</span><br><span class="line">                leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">byte</span> ver[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">                ByteBuffer.wrap(ver).putInt(<span class="number">0x10000</span>);</span><br><span class="line">                QuorumPacket newEpochPacket = <span class="keyword">new</span> QuorumPacket(Leader.LEADERINFO, newLeaderZxid, ver, <span class="keyword">null</span>);</span><br><span class="line">                oa.writeRecord(newEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line">                QuorumPacket ackEpochPacket = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">                ia.readRecord(ackEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">                <span class="keyword">if</span> (ackEpochPacket.getType() != Leader.ACKEPOCH) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ByteBuffer bbepoch = ByteBuffer.wrap(ackEpochPacket.getData());</span><br><span class="line">                ss = <span class="keyword">new</span> StateSummary(bbepoch.getInt(), ackEpochPacket.getZxid());</span><br><span class="line">                leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">            &#125;</span><br><span class="line">            peerLastZxid = ss.getLastZxid();</span><br><span class="line">            <span class="keyword">boolean</span> needSnap = syncFollower(peerLastZxid, leader.zk.getZKDatabase(), leader);</span><br><span class="line">            <span class="keyword">if</span> (needSnap) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> exemptFromThrottle = getLearnerType() != LearnerType.OBSERVER;</span><br><span class="line">                LearnerSnapshot snapshot = leader.getLearnerSnapshotThrottler().beginSnapshot(exemptFromThrottle);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">long</span> zxidToSend = leader.zk.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">                    oa.writeRecord(<span class="keyword">new</span> QuorumPacket(Leader.SNAP, zxidToSend, <span class="keyword">null</span>, <span class="keyword">null</span>), <span class="string">"packet"</span>);</span><br><span class="line">                    bufferedOutput.flush();</span><br><span class="line">                    leader.zk.getZKDatabase().serializeSnapshot(oa);</span><br><span class="line">                    oa.writeString(<span class="string">"BenWasHere"</span>, <span class="string">"signature"</span>);</span><br><span class="line">                    bufferedOutput.flush();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    snapshot.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (getVersion() &lt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">                QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER, newLeaderZxid, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                oa.writeRecord(newLeaderQP, <span class="string">"packet"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER, newLeaderZxid, leader.self.getLastSeenQuorumVerifier().toString().getBytes(), <span class="keyword">null</span>);</span><br><span class="line">                queuedPackets.add(newLeaderQP);</span><br><span class="line">            &#125;</span><br><span class="line">            bufferedOutput.flush();</span><br><span class="line">            startSendingPackets(); <span class="comment">// 启动线程将队列中的数据包发送给Follower</span></span><br><span class="line">            qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">            <span class="keyword">if</span> (qp.getType() != Leader.ACK) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            leader.waitForNewLeaderAck(getSid(), qp.getZxid());</span><br><span class="line">            syncLimitCheck.start();</span><br><span class="line">            sock.setSoTimeout(leader.self.tickTime * leader.self.syncLimit);</span><br><span class="line">            <span class="keyword">synchronized</span> (leader.zk) &#123;</span><br><span class="line">                <span class="keyword">while</span> (!leader.zk.isRunning() &amp;&amp; !<span class="keyword">this</span>.isInterrupted()) &#123;</span><br><span class="line">                    leader.zk.wait(<span class="number">20</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            queuedPackets.add(<span class="keyword">new</span> QuorumPacket(Leader.UPTODATE, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">                ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">                <span class="keyword">long</span> traceMask = ZooTrace.SERVER_PACKET_TRACE_MASK;</span><br><span class="line">                <span class="keyword">if</span> (qp.getType() == Leader.PING) &#123;</span><br><span class="line">                    traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">                &#125;</span><br><span class="line">                tickOfNextAckDeadline = leader.self.tick.get() + leader.self.syncLimit;</span><br><span class="line">                ByteBuffer bb;</span><br><span class="line">                <span class="keyword">long</span> sessionId;</span><br><span class="line">                <span class="keyword">int</span> cxid;</span><br><span class="line">                <span class="keyword">int</span> type;</span><br><span class="line">                <span class="keyword">switch</span> (qp.getType()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> Leader.ACK: <span class="comment">// 处理Follower发送给Leader的ACK</span></span><br><span class="line">                        syncLimitCheck.updateAck(qp.getZxid());</span><br><span class="line">                        leader.processAck(<span class="keyword">this</span>.sid, qp.getZxid(), sock.getLocalSocketAddress());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> Leader.PING:<span class="comment">// Process the touches</span></span><br><span class="line">                        ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(qp.getData());</span><br><span class="line">                        DataInputStream dis = <span class="keyword">new</span> DataInputStream(bis);</span><br><span class="line">                        <span class="keyword">while</span> (dis.available() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">long</span> sess = dis.readLong();</span><br><span class="line">                            <span class="keyword">int</span> to = dis.readInt();</span><br><span class="line">                            leader.zk.touch(sess, to);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> Leader.REQUEST:</span><br><span class="line">                        bb = ByteBuffer.wrap(qp.getData());</span><br><span class="line">                        sessionId = bb.getLong();</span><br><span class="line">                        cxid = bb.getInt();</span><br><span class="line">                        type = bb.getInt();</span><br><span class="line">                        bb = bb.slice();</span><br><span class="line">                        Request si;</span><br><span class="line">                        <span class="keyword">if</span> (type == OpCode.sync) &#123;</span><br><span class="line">                            si = <span class="keyword">new</span> LearnerSyncRequest(<span class="keyword">this</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            si = <span class="keyword">new</span> Request(<span class="keyword">null</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                        &#125;</span><br><span class="line">                        si.setOwner(<span class="keyword">this</span>);</span><br><span class="line">                        leader.zk.submitLearnerRequest(si);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sock != <span class="keyword">null</span> &amp;&amp; !sock.isClosed()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123; <span class="comment">//close the socket to make sure the other side can see it being close</span></span><br><span class="line">                    sock.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<strong><code>LearnerHandler</code></strong>的<strong><code>run</code></strong>方法中通过<strong><code>startSendingPackets</code></strong>方法，启动了一个线程从阻塞队列<strong><code>queuedPackets</code></strong>中poll请求数据包，发送给follower。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LearnerHandler</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startSendingPackets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sendingThreadStarted) &#123;<span class="comment">// Start sending packets</span></span><br><span class="line">            <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    Thread.currentThread().setName(<span class="string">"Sender-"</span> + sock.getRemoteSocketAddress());</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        sendPackets();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;.start();</span><br><span class="line">            sendingThreadStarted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPackets</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> traceMask = ZooTrace.SERVER_PACKET_TRACE_MASK;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                QuorumPacket p;</span><br><span class="line">                p = queuedPackets.poll();</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bufferedOutput.flush();</span><br><span class="line">                    p = queuedPackets.take();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p == proposalOfDeath) &#123;<span class="comment">// Packet of death!</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p.getType() == Leader.PING) &#123;</span><br><span class="line">                    traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p.getType() == Leader.PROPOSAL) &#123;</span><br><span class="line">                    syncLimitCheck.updateProposal(p.getZxid(), System.nanoTime());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                    ZooTrace.logQuorumPacket(LOG, traceMask, <span class="string">'o'</span>, p);</span><br><span class="line">                &#125;</span><br><span class="line">                oa.writeRecord(p, <span class="string">"packet"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!sock.isClosed()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;<span class="comment">// this will cause everything to shutdown on this learner handler and will help notify the learner/observer instantaneously</span></span><br><span class="line">                        sock.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException ie) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="从节点"><a href="#从节点" class="headerlink" title="从节点"></a>从节点</h4><p>对于从节点当<strong>选举完成后</strong>会调用<strong><code>Follower</code></strong>的<strong><code>followLeader</code></strong>方法中通过<strong><code>syncWithLeader</code></strong>调用<strong><code>ZooKeeperServer</code></strong>的子类<strong><code>FollowerZooKeeperServer</code></strong>的<strong><code>setupRequestProcessors</code></strong>方法加载请求处理链<strong><code>FollowerRequestProcessor</code></strong>、<strong><code>CommitProcessor</code></strong>、<strong><code>FinalRequestProcessor</code></strong>和<strong><code>SyncRequestProcessor</code></strong>、<strong><code>SendAckRequestProcessor</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Follower</span> <span class="keyword">extends</span> <span class="title">Learner</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">followLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        self.end_fle = Time.currentElapsedTime();</span><br><span class="line">        <span class="keyword">long</span> electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">        self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">        self.start_fle = <span class="number">0</span>;</span><br><span class="line">        self.end_fle = <span class="number">0</span>;</span><br><span class="line">        fzk.registerJMX(<span class="keyword">new</span> FollowerBean(<span class="keyword">this</span>, zk), self.jmxLocalPeerBean);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            QuorumServer leaderServer = findLeader();  <span class="comment">// 获取leader server</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connectToLeader(leaderServer.addr, leaderServer.hostname); <span class="comment">// 主动向leader发起socket连接</span></span><br><span class="line">                <span class="keyword">long</span> newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO); <span class="comment">// 注册自己到Leader</span></span><br><span class="line">                <span class="keyword">if</span> (self.isReconfigStateChange())</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"learned about role change"</span>);</span><br><span class="line">                <span class="keyword">long</span> newEpoch = ZxidUtils.getEpochFromZxid(newEpochZxid);</span><br><span class="line">                <span class="keyword">if</span> (newEpoch &lt; self.getAcceptedEpoch()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Error: Epoch of leader is lower"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                syncWithLeader(newEpochZxid); <span class="comment">// 同步leader数据</span></span><br><span class="line">                QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">this</span>.isRunning()) &#123; <span class="comment">// while死循环接收leader同步的数据</span></span><br><span class="line">                    readPacket(qp); <span class="comment">// 若leader挂了，这里从leader取数据时会抛出异常退出循环</span></span><br><span class="line">                    processPacket(qp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sock.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                    e1.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                pendingRevalidations.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            zk.unregisterJMX((Learner)<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FollowerZooKeeperServer</span> <span class="keyword">extends</span> <span class="title">LearnerZooKeeperServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupRequestProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestProcessor finalProcessor = <span class="keyword">new</span> FinalRequestProcessor(<span class="keyword">this</span>);</span><br><span class="line">        commitProcessor = <span class="keyword">new</span> CommitProcessor(finalProcessor, Long.toString(getServerId()), <span class="keyword">true</span>, getZooKeeperServerListener());</span><br><span class="line">        commitProcessor.start();</span><br><span class="line">        firstProcessor = <span class="keyword">new</span> FollowerRequestProcessor(<span class="keyword">this</span>, commitProcessor);</span><br><span class="line">        ((FollowerRequestProcessor) firstProcessor).start();</span><br><span class="line">        syncProcessor = <span class="keyword">new</span> SyncRequestProcessor(<span class="keyword">this</span>, <span class="keyword">new</span> SendAckRequestProcessor((Learner)getFollower()));</span><br><span class="line">        syncProcessor.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当接收到Leader发送的数据时调用首先调用<strong><code>readPacket</code></strong>使用jute序列化从输入流中拿数据，然后调用<strong><code>processPacket</code></strong>根据<strong>请求类型</strong>调用具体的方法处理请求数据。对于<strong><code>Leader.PROPOSAL</code>类型</strong>的请求调用<strong><code>FollowerZooKeeperServer</code></strong>的<strong><code>logRequest</code></strong>方法，从而<strong>异步</strong>执行<strong><code>SyncRequestProcessor</code></strong>将数据更新到事务日志文件中。</p>
<p>对于Follower来说，<strong><code>SyncRequestProcessor</code></strong>的<strong><code>nextProcessor</code></strong>为<strong><code>SendAckRequestProcessor</code></strong>，故当将数据同步到事务日志文件中后，则执行<strong><code>SendAckRequestProcessor</code>给Leader回复<code>ACK</code>命令</strong>，当Leader收到的ACK票数超过一半时执行Commit操作，且给<strong><code>Follower</code></strong>发送<code>Commit</code>命令。当收到Leader的Commit命令后调用<strong><code>FollowerZooKeeperServer</code></strong>的<strong><code>commit</code></strong>方法执行<strong><code>CommitProcessor</code></strong>的<strong><code>commit</code></strong>关键方法，然后执行<strong><code>FinalRequestProcessor</code></strong>将数据<strong>同步到内存</strong>中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Learner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readPacket</span><span class="params">(QuorumPacket pp)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (leaderIs) &#123;</span><br><span class="line">            leaderIs.readRecord(pp, <span class="string">"packet"</span>); <span class="comment">// 调用QuorumPacket的deserialize方法，使用jute序列化从输入流中拿数据，jute类似protobuf</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Follower</span> <span class="keyword">extends</span> <span class="title">Learner</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(QuorumPacket qp)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (qp.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> Leader.PING:            </span><br><span class="line">                ping(qp);            </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.PROPOSAL:</span><br><span class="line">                TxnHeader hdr = <span class="keyword">new</span> TxnHeader();</span><br><span class="line">                Record txn = SerializeUtils.deserializeTxn(qp.getData(), hdr);</span><br><span class="line">                lastQueued = hdr.getZxid();</span><br><span class="line">                <span class="keyword">if</span> (hdr.getType() == OpCode.reconfig)&#123;</span><br><span class="line">                    SetDataTxn setDataTxn = (SetDataTxn) txn;       </span><br><span class="line">                    QuorumVerifier qv = self.configFromString(<span class="keyword">new</span> String(setDataTxn.getData()));</span><br><span class="line">                    self.setLastSeenQuorumVerifier(qv, <span class="keyword">true</span>);                               </span><br><span class="line">                &#125;</span><br><span class="line">                fzk.logRequest(hdr, txn);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.COMMIT:</span><br><span class="line">                fzk.commit(qp.getZxid());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.COMMITANDACTIVATE:</span><br><span class="line">                Request request = fzk.pendingTxns.element();</span><br><span class="line">                SetDataTxn setDataTxn = (SetDataTxn) request.getTxn();</span><br><span class="line">                QuorumVerifier qv = self.configFromString(<span class="keyword">new</span> String(setDataTxn.getData()));</span><br><span class="line">                ByteBuffer buffer = ByteBuffer.wrap(qp.getData());    </span><br><span class="line">                <span class="keyword">long</span> suggestedLeaderId = buffer.getLong();</span><br><span class="line">                <span class="keyword">boolean</span> majorChange = self.processReconfig(qv, suggestedLeaderId, qp.getZxid(), <span class="keyword">true</span>);</span><br><span class="line">                fzk.commit(qp.getZxid());</span><br><span class="line">                <span class="keyword">if</span> (majorChange) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"changes proposed in reconfig"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.UPTODATE:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.REVALIDATE:</span><br><span class="line">                revalidate(qp);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.SYNC:</span><br><span class="line">                fzk.sync();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FollowerZooKeeperServer</span> <span class="keyword">extends</span> <span class="title">LearnerZooKeeperServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logRequest</span><span class="params">(TxnHeader hdr, Record txn)</span> </span>&#123;</span><br><span class="line">        Request request = <span class="keyword">new</span> Request(hdr.getClientId(), hdr.getCxid(), hdr.getType(), hdr, txn, hdr.getZxid());</span><br><span class="line">        <span class="keyword">if</span> ((request.zxid &amp; <span class="number">0xffffffffL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            pendingTxns.add(request);</span><br><span class="line">        &#125;</span><br><span class="line">        syncProcessor.processRequest(request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pendingTxns.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> firstElementZxid = pendingTxns.element().zxid;</span><br><span class="line">        <span class="keyword">if</span> (firstElementZxid != zxid) &#123;</span><br><span class="line">            System.exit(<span class="number">12</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Request request = pendingTxns.remove();</span><br><span class="line">        commitProcessor.commit(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendAckRequestProcessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span>, <span class="title">Flushable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request si)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(si.type != OpCode.sync)&#123;</span><br><span class="line">            QuorumPacket qp = <span class="keyword">new</span> QuorumPacket(Leader.ACK, si.getHdr().getZxid(), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                learner.writePacket(qp, <span class="keyword">false</span>); <span class="comment">// 向Leader发送构建的ACK的packet，被LearnerHandler.run接收到执行Leader的processAck方法</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!learner.sock.isClosed()) &#123;</span><br><span class="line">                        learner.sock.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        </div>
        
    <footer class="article-footer">
    </footer>
    </div>
</article>


    
    <nav id="article-nav">
        
            <a href="/Blog/Cloud/Zookeeper/Zookeeper客户端之ZAB/" id="article-nav-newer" class="article-nav-link-wrap">
                <strong class="article-nav-caption">Newer</strong>
                <div class="article-nav-title">
                    
                        Zookeeper客户端之ZAB
                    
                </div>
            </a>
        
        
            <a href="/Blog/Cloud/Dubbo/Dubbo服务调用/" id="article-nav-older" class="article-nav-link-wrap">
                <strong class="article-nav-caption">Older</strong>
                <div class="article-nav-title">Dubbo服务调用</div>
            </a>
        
    </nav>





    
    




    <!-- baidu url auto push script -->
    <script type="text/javascript">
        !function () {
            var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi, r = window.location.href,
                o = document.referrer;
            if (!e.test(r)) {
                var n = "//api.share.baidu.com/s.gif";
                o ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
                var t = new Image;
                t.src = n
            }
        }(window);
    </script>
</section>
    </div>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            YaoYingLong &copy; 2024
            <!-- <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a> -->
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten" rel="external nofollow noopener noreferrer" target="_blank">wikitten</a>
        </div>
    </div>
</footer>
    

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });


</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

</div>
</body>
