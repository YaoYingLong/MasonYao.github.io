<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    
    <title>
        NameServer&amp;Broker启动源码 |
        
        YingLong</title>
    
    
        <meta name="keywords" content="RocketMQ">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="RocketMQ架构 TopicTopic是一类消息的集合，是一种逻辑上的分区，Kafka的Topic也是一种逻辑概念，每个Topic的数据会分成多个Partition，然后存储在不同的Broker上，在RocketMQ中Topic的数据也会分布式存储在Broker上的MessageQueue中。 NameServer启动NameServer一个非常简单的Topic路由注册中心，支持Broker动">
<meta name="keywords" content="RocketMQ">
<meta property="og:type" content="article">
<meta property="og:title" content="NameServer&amp;Broker启动源码">
<meta property="og:url" content="https://yaoyinglong.github.io/Blog/Cloud/MQ/RocketMQ/NameServer&Broker启动源码/index.html">
<meta property="og:site_name" content="YingLong">
<meta property="og:description" content="RocketMQ架构 TopicTopic是一类消息的集合，是一种逻辑上的分区，Kafka的Topic也是一种逻辑概念，每个Topic的数据会分成多个Partition，然后存储在不同的Broker上，在RocketMQ中Topic的数据也会分布式存储在Broker上的MessageQueue中。 NameServer启动NameServer一个非常简单的Topic路由注册中心，支持Broker动">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://yaoyinglong.github.io/images/MQ/rocketmq_architecture_3.png">
<meta property="og:updated_time" content="2022-08-24T15:28:25.385Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NameServer&amp;Broker启动源码">
<meta name="twitter:description" content="RocketMQ架构 TopicTopic是一类消息的集合，是一种逻辑上的分区，Kafka的Topic也是一种逻辑概念，每个Topic的数据会分成多个Partition，然后存储在不同的Broker上，在RocketMQ中Topic的数据也会分布式存储在Broker上的MessageQueue中。 NameServer启动NameServer一个非常简单的Topic路由注册中心，支持Broker动">
<meta name="twitter:image" content="https://yaoyinglong.github.io/images/MQ/rocketmq_architecture_3.png">
    

    

    
        <link rel="icon" href="/favicon.ico">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>
</html>
<body>
<div id="container">
    <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">YingLong</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
                <a class="main-nav-link" href="javascript:trigger()">Reading</a>
            </nav>
            
            <div id="search-form-wrap">
    
        <form class="search-form">
            <input type="text" class="ins-search-input search-form-input" placeholder="Search">
            <button type="submit" class="search-form-submit"></button>
        </form>
        <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: '/',
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>
<script type="text/javascript">
    var index = 0
    trigger = function () {
        if (index % 2 == 0) {
            $("#sidebar").css("display", "none");
            $("#main").css("float", "none");
        } else {
            $("#sidebar").css("display", "inline");
            $("#main").css("float", "left");
        }
        index++
    }
</script>

    <div class="outer">
        
        
            <aside id="sidebar">
    
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>

        
        
        
            <ul class="unstyled" id="tree">
                
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Cloud
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Dubbo
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo基础/">Dubbo基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务调用/">Dubbo服务调用</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/SPI机制源码/">SPI机制源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务引入/">Dubbo服务引入</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo服务导出/">Dubbo服务导出</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Dubbo/Dubbo与Spring集成原理/">Dubbo与Spring集成原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            ELK
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch基础/">ElasticSearch基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch实战/">ElasticSearch实战</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/ELK/ElasticSearch进阶/">ElasticSearch进阶</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            MQ
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            RocketMQ
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file active"><a href="/Blog/Cloud/MQ/RocketMQ/NameServer&Broker启动源码/">NameServer&Broker启动源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ高级特性/">RocketMQ高级特性</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ基础/">RocketMQ基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ消息存储源码/">RocketMQ消息存储源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ生产者源码/">RocketMQ生产者源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/RocketMQ消费者源码/">RocketMQ消费者源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/Consumer启动源码/">Consumer启动源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RocketMQ/Producer启动源码/">Producer启动源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/Kafka基础/">Kafka基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RabbitMQ高级特性及Spring集成/">RabbitMQ高级特性及Spring集成</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/MQ/RabbitMQ基础/">RabbitMQ基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Nacos
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos Client原理/">Nacos Client原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos Server原理/">Nacos Server原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos问题总结/">Nacos问题总结</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群CP模式/">Nacos集群CP模式</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos配置中心Server原理/">Nacos配置中心Server原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群成员信息同步/">Nacos集群成员信息同步</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos集群注册服务同步/">Nacos集群注册服务同步</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Nacos/Nacos配置中心Client原理/">Nacos配置中心Client原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Netty
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Netty/IO模型基础/">IO模型基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty基础/">Netty基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty源码/">Netty源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Netty/Netty进阶/">Netty进阶</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Redis
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis分布式锁实现/">Redis分布式锁实现</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis缓存及性能优化/">Redis缓存及性能优化</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis基础/">Redis基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Redis/Redis集群架构/">Redis集群架构</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Seata
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Seata/Seata集成原理/">Seata集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Seata/Seata分布式事务原理/">Seata分布式事务原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Sentinel
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel配置持久化/">Sentinel配置持久化</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel规则发布源码/">Sentinel规则发布源码</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/常见限流算法/">常见限流算法</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Sentinel/Sentinel限流熔断降级源码/">Sentinel限流熔断降级源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Zookeeper
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper基础/">Zookeeper基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper客户端之ZAB/">Zookeeper客户端之ZAB</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper集群Leader选举/">Zookeeper集群Leader选举</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Zookeeper/Zookeeper服务端之ZAB/">Zookeeper服务端之ZAB</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            网关
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Cloud/网关/Gateway源码/">Gateway源码</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Cloud/Feign集成原理/">Feign集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Canal基础/">Canal基础</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/Ribbon集成原理/">Ribbon集成原理</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/分布式事务解决方案/">分布式事务解决方案</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/分布式系统常见问题/">分布式系统常见问题</a></li>
                
                    <li class="file"><a href="/Blog/Cloud/秒杀问题及解决方案/">秒杀问题及解决方案</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            DB
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/DB/Explain工具/">Explain工具</a></li>
                
                    <li class="file"><a href="/Blog/DB/MongoDB基础/">MongoDB基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/MVCC与BufferPool缓存机制/">MVCC与BufferPool缓存机制</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL主从架构/">MySQL主从架构</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL事务隔离级别与锁机制/">MySQL事务隔离级别与锁机制</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL内部组件结构/">MySQL内部组件结构</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL基础/">MySQL基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/MySQL常用SQL总结/">MySQL常用SQL总结</a></li>
                
                    <li class="file"><a href="/Blog/DB/ShardingSphere基础/">ShardingSphere基础</a></li>
                
                    <li class="file"><a href="/Blog/DB/分库分表/">分库分表</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化一/">索引优化一</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化三/">索引优化三</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引优化二/">索引优化二</a></li>
                
                    <li class="file"><a href="/Blog/DB/索引的原理与使用/">索引的原理与使用</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Java
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            VM
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/VM/JVM内存池/">JVM内存池</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Minor&Major&Full GC/">Minor&Major&Full GC</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Class文件结构/">Class文件结构</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/Java内存区域/">Java内存区域</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/OutOfMemoryError异常/">OOM异常实验</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/内存非配与回收策略/">内存分配与回收策略</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/垃圾收集器/">垃圾收集器</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/堆中对象分配&布局&访问/">堆中对象分配&布局&访问</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/垃圾收集算法/">垃圾收集算法及实现</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/字节码指令/">字节码指令</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/字节码指令手册/">字节码指令手册</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/对象是否存活/">对象是否存活</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/方法调用/">方法调用</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/属性表集合/">属性表集合</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/常量池/">常量池</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/理解GC日志/">理解GC日志</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/类加载器/">类加载器</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/运行时栈帧结构/">运行时栈帧结构</a></li>
                
                    <li class="file"><a href="/Blog/Java/VM/类加载过程/">类加载过程</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            基础
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/基础/HashMap源码分析JDK8/">HashMap源码分析JDK8</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/Java实用工具库/">Java实用工具库</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/HashMap源码分析JDK7/">HashMap源码分析JDK7</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/lambda常用总结/">lambda常用总结</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/位运算/">位运算</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/PriorityQueue源码/">PriorityQueue源码</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/动态代理/">动态代理</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/反射基础/">反射基础</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/时间及日期总结/">Java8时间及日期</a></li>
                
                    <li class="file"><a href="/Blog/Java/基础/注解实现及应用/">注解实现及应用</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/工具/Java中调用Groovy脚本/">Java中调用Groovy脚本</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/JAVA实用工具/">JAVA实用工具</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/国密SM2/">国密SM2</a></li>
                
                    <li class="file"><a href="/Blog/Java/工具/国密SM4/">国密SM4</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            并发
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Java/并发/BlockingQueue阻塞队列二/">BlockingQueue阻塞队列二</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/AQS与ReentrantLock/">AQS与ReentrantLock</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Callable与Future/">Callable与Future</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ConcurrentHashMap源码JDK7/">ConcurrentHashMap源码JDK7</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Condition原理/">Condition原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Java内存模型/">Java内存模型</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ConcurrentHashMap源码JDK8/">ConcurrentHashMap源码JDK8</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Java与线程/">Java与线程</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/BlockingQueue阻塞队列一/">BlockingQueue阻塞队列一</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ReentrantReadWriteLock原理/">ReentrantReadWriteLock原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ScheduledThreadPoolExecutor/">ScheduledThreadPoolExecutor</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Synchronized总结/">Synchronized总结</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/ThreadLocal原理/">ThreadLocal原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/原子性、可见性、有序性/">原子性、可见性、有序性</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Unsafe应用/">Unsafe应用</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/Volatile原理/">Volatile原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程安全/">线程安全</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程安全实现方式/">线程安全实现方式</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/同步工具类/">同步工具类</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/锁优化/">锁优化</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/线程池原理/">线程池原理</a></li>
                
                    <li class="file"><a href="/Blog/Java/并发/操作系统底层/">操作系统底层</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Java/JVM内存参数设置/">JVM内存参数设置</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM调优工具/">JVM调优工具</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM整体概览/">JVM整体概览</a></li>
                
                    <li class="file"><a href="/Blog/Java/JVM调优思路/">JVM调优思路</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Maven
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Maven/Maven仓库/">Maven仓库</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven Assembly标签全解/">Maven Assembly标签全解</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven基础/">Maven基础</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven加密JAR包/">Maven加密JAR包</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven个性化打包/">Maven个性化打包</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven属性/">Maven属性</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用/">Maven常用</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用工具/">Maven常用工具</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常见问题总结/">Maven常见问题总结</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven常用插件/">Maven常用插件</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven插件基础/">Maven插件基础</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven插件编写/">Maven插件编写</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven标签全解/">Maven标签全解</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven生命周期/">Maven生命周期</a></li>
                
                    <li class="file"><a href="/Blog/Maven/Maven聚合与继承/">Maven聚合与继承</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Spring
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            SpringBoot
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot Jar包启动原理/">SpringBoot Jar包启动原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot资源加载/">SpringBoot资源加载</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot自动装配原理/">SpringBoot自动装配原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringBoot/SpringBoot启动原理/">SpringBoot启动原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/Spring/AOP切面类解析/">AOP切面类解析</a></li>
                
                    <li class="file"><a href="/Blog/Spring/AOP创建代理与调用/">AOP创建代理与调用</a></li>
                
                    <li class="file"><a href="/Blog/Spring/BeanDefinition解析注册/">BeanDefinition解析注册</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Bean的生命周期/">Bean的生命周期</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Hystrix总结/">Hystrix总结</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Bean的加载过程/">Bean的加载过程</a></li>
                
                    <li class="file"><a href="/Blog/Spring/IoC容器/">IoC容器</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring Gzip压缩/">Spring Gzip压缩</a></li>
                
                    <li class="file"><a href="/Blog/Spring/IoC容器加载过程/">IoC容器加载过程</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc异步/">SpringMvc异步原理及实现</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc加载机制/">SpringMvc加载机制</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring初始化扩展/">Spring初始化扩展</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring整体架构/">Spring整体架构</a></li>
                
                    <li class="file"><a href="/Blog/Spring/SpringMvc处理分发请求原理/">SpringMvc处理分发请求原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/Spring线程池跨线程数据共享/">Spring线程池跨线程数据共享</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事件监听器/">事件监听器</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事务解析原理/">事务解析原理</a></li>
                
                    <li class="file"><a href="/Blog/Spring/事务调用原理/">事务调用原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Test
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/Test/IT测试总结/">IT测试总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/UT测试总结/">UT测试总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/JMeter日常总结/">JMeter日常总结</a></li>
                
                    <li class="file"><a href="/Blog/Test/LoadRunner日常总结/">LoadRunner日常总结</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            中间件
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Mybatis
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis缓存原理/">Mybatis缓存原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis执行SQL原理/">Mybatis执行SQL原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis集成到Spring原理/">Mybatis集成到Spring原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Mybatis/Mybatis配置文件解析原理/">Mybatis配置文件解析原理</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Tomcat
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/BIO和NIO底层原理对比/">BIO和NIO底层原理对比</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat处理响应过程/">Tomcat处理响应过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat启动过程/">Tomcat启动过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat处理请求过程/">Tomcat处理请求过程</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat工作原理/">Tomcat工作原理</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat热部署热加载/">Tomcat热部署热加载</a></li>
                
                    <li class="file"><a href="/Blog/中间件/Tomcat/Tomcat整体架构/">Tomcat整体架构</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            云原生
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/云原生/Docker基础/">Docker基础</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Docker Compose基础/">Docker Compose基础</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Docker搭建Prometheus&Grafana/">Docker搭建Prometheus&Grafana</a></li>
                
                    <li class="file"><a href="/Blog/云原生/Kubernetes基础/">Kubernetes基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            杂记
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Git
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Git/GIt基本概念/">Git基本概念</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Git/GIt常用命令/">Git常用命令</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Git/分支管理理解/">分支管理理解</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Linux
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux常用命令/">Linux常用命令</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux基础/">Linux基础</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Shell基础/">Shell基础</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux磁盘与文件系统/">Linux磁盘与文件系统</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/零拷贝技术/">零拷贝技术</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Linux非常用命令/">Linux非常用命令</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/文件&文件系统压缩打包备份/">Linux压缩打包备份</a></li>
                
                    <li class="file"><a href="/Blog/杂记/Linux/Vim编辑器/">Vim编辑器</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            协议族
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/协议族/TCPIP四层&五层模型/">TCP/IP四层&五层模型</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/以太网/">以太网</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/网络基础知识/">网络基础知识</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/地址解析协议/">地址解析协议ARP</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/TCP&UDP协议/">TCP&UDP协议</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/HTTP协议/">HTTP协议</a></li>
                
                    <li class="file"><a href="/Blog/杂记/协议族/HTTPs协议/">HTTPs协议</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/杂记/工具/SonarQube配置总结/">SonarQube配置总结</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/IDEA快捷的使用/">IDEA的快捷使用</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/Win实用工具/">Win实用工具</a></li>
                
                    <li class="file"><a href="/Blog/杂记/工具/XSD使用总结/">XSD实用总结</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            算法
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/算法/二叉搜索树/">二叉搜索树</a></li>
                
                    <li class="file"><a href="/Blog/算法/图基础/">图基础</a></li>
                
                    <li class="file"><a href="/Blog/算法/基础算法/">基础算法</a></li>
                
                    <li class="file"><a href="/Blog/算法/平衡二叉树/">平衡二叉树</a></li>
                
                    <li class="file"><a href="/Blog/算法/排序算法/">排序算法</a></li>
                
                    <li class="file"><a href="/Blog/算法/树基础/">树基础</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法-动态规划/">经典算法-动态规划</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法-栈/">经典算法-栈</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法-链表/">经典算法-链表</a></li>
                
                    <li class="file"><a href="/Blog/算法/经典算法/">经典算法</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            设计模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            创建型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/单例模式/">单例模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/原型模式/">原型模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/工厂模式/">工厂模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/创建型模式/建造者模式/">建造者模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            结构型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/外观模式/">外观模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/代理模式/">代理模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/组合模式/">组合模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/装饰模式/">装饰模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/适配器模式/">适配器模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/享元模式/">享元模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/结构型模式/桥梁模式/">桥梁模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            行为型模式
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/命令模式/">命令模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/备忘录模式/">备忘录模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/模板方法模式/">模板方法模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/状态模式/">状态模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/中介者模式/">中介者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/策略模式/">策略模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/观察者模式/">观察者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/责任链模式/">责任链模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/迭代器模式/">迭代器模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/访问者模式/">访问者模式</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/行为型模式/解释器模式/">解释器模式</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/设计模式/SOLID基本原则/">SOLID基本原则</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/设计模式概览/">设计模式概览</a></li>
                
                    <li class="file"><a href="/Blog/设计模式/设计模式对比/">设计模式对比</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            语言
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            CPP
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/CPP/IO流/">IO流</a></li>
                
                    <li class="file"><a href="/Blog/语言/CPP/CPP基础/">CPP基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Go
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/Go/Go基础/">Go基础</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Python
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/Python/Excel文件数据抽取/">Excel文件数据抽取</a></li>
                
            </ul>
        
                    </li>
                
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            前端
                        </a>
                        
            <ul class="unstyled" id="tree">
                
                    <li class="file"><a href="/Blog/语言/前端/JavaScript基础/">JavaScript基础</a></li>
                
                    <li class="file"><a href="/Blog/语言/前端/TypeScript基础/">TypeScript基础</a></li>
                
            </ul>
        
                    </li>
                
            </ul>
        
                    </li>
                
                    <li class="file"><a href="/Blog/index/"></a></li>
                
            </ul>
        
    </div>
    <script>
        $(document).ready(function () {
            var iconFolderOpenClass = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({duration: 100});
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({duration: 100});
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    subtrees.slideUp({duration: 100});
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({duration: 100});
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if (expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({duration: 100});
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({duration: 100});
                    icon.addClass(iconAllExpandClass);
                }
            });
        });
    </script>

    
</aside>
<div id="toTop" class="fa fa-angle-up"></div>

        
        <section id="main"><article id="post-Cloud/MQ/RocketMQ/NameServer&amp;Broker启动源码" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
        <i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Cloud/">Cloud</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Cloud/MQ/">MQ</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Cloud/MQ/RocketMQ/">RocketMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/RocketMQ/">RocketMQ</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/Blog/Cloud/MQ/RocketMQ/NameServer&Broker启动源码/">
            <time datetime="2021-12-28T16:00:00.000Z" itemprop="datePublished">2021-12-29</time>
        </a>
    </div>


                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            NameServer&amp;Broker启动源码
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
            
            
                    
            
            
                <h3 id="RocketMQ架构"><a href="#RocketMQ架构" class="headerlink" title="RocketMQ架构"></a>RocketMQ架构</h3><p><img src="../../../../../images/MQ/rocketmq_architecture_3.png" alt></p>
<h3 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h3><p>Topic是一类消息的集合，是一种逻辑上的分区，Kafka的Topic也是一种逻辑概念，每个Topic的数据会分成多个<strong>Partition</strong>，然后存储在不同的Broker上，在RocketMQ中Topic的数据也会分布式存储在Broker上的<strong>MessageQueue</strong>中。</p>
<h3 id="NameServer启动"><a href="#NameServer启动" class="headerlink" title="NameServer启动"></a>NameServer启动</h3><p>NameServer一个非常简单的<strong><code>Topic</code>路由注册中心</strong>，<strong>支持<code>Broker</code>动态注册与发现</strong>。通常也是<strong>集群方式部署</strong>，<strong>各实例间不信息通讯</strong>。<strong><code>Broker</code></strong>向<strong>每台<code>NameServer</code>注册</strong>自己的路由信息，故<strong>每个<code>NameServer</code>实例上都保存一份完整的路由信息</strong>。若当某个NameServer因某种原因下线，Broker仍可向其它NameServer同步其路由信息，Producer和Consumer仍可<strong>动态感知<code>Broker</code>路由信息</strong>。<strong><code>NameServer</code></strong>主要包括<strong><code>Broker</code>管理</strong>和<strong>路由信息管理</strong>两个功能：</p>
<ul>
<li><strong><code>Broker</code>管理</strong>：<strong><code>NameServer</code></strong>接受<strong>Broker集群的注册信息</strong>且保存<strong>作为路由信息基本数据</strong>。<strong>提供心跳检测机制</strong>，检查Broker是否存活；</li>
<li><strong>路由信息管理</strong>，每个<strong><code>NameServer</code></strong>将保存关于<strong>Broker集群的整个路由信息</strong>和用于<strong>客户端查询的队列信息</strong>。然后<strong><code>Producer</code></strong>和<strong><code>Conumser</code></strong>通过<strong><code>NameServer</code></strong>可知道<strong>整个<code>Broker</code>集群的路由信息</strong>，从而进行消息的投递和消费。 这里的路由信息是指，<strong>某个<code>Topic</code>下的<code>MessageQueue</code>在哪台<code>Broker</code>上</strong>。</li>
</ul>
<p>NameServer是一个<strong>几乎无状态</strong>节点，<strong>可集群部署</strong>，<strong>节点之间无任何信息同步</strong>。NameServer启动后监听端口，等待<strong><code>Broker</code></strong>、<strong><code>Producer</code></strong>、<strong><code>Consumer</code></strong>连接，相当于一个<strong>路由控制中心</strong>。</p>
<p>该类主要是<strong>完成配置文件的加载解析</strong>，将配置解析设置到<strong><code>NameServer</code></strong>自身<strong>运行参数</strong>配置类<strong><code>NameSrvConfig</code></strong>中，以及包含<strong>Netty服务端的配置参数</strong>的<strong><code>NettyServerConfig</code></strong>，可在配置文件中通过<strong><code>listenPort=9878</code></strong>修改服务端端口，将这两个总要配置类通过构造函数传入创建<strong><code>NamesrvController</code></strong>核心类，<strong>是<code>NameServer</code>的核心管理控制组件</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamesrvStartup</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        main0(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamesrvController <span class="title">main0</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// NameServer启动的核心组件，NamesrvController，类似于Web应用里的Controller，用来接收网络请求</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            NamesrvController controller = createNamesrvController(args);</span><br><span class="line">            start(controller);</span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamesrvController <span class="title">createNamesrvController</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, JoranException </span>&#123;</span><br><span class="line">        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line">        <span class="comment">//PackageConflictDetect.detectFastjson();</span></span><br><span class="line">        <span class="comment">//K2 检测命令行参数。简略</span></span><br><span class="line">        Options options = ServerUtil.buildCommandlineOptions(<span class="keyword">new</span> Options());</span><br><span class="line">        commandLine = ServerUtil.parseCmdLine(<span class="string">"mqnamesrv"</span>, args, buildCommandlineOptions(options), <span class="keyword">new</span> PosixParser());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == commandLine) &#123;</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// NameServer最核心的三个配置，NameSrvConfig包含NameServer自身运行的参数</span></span><br><span class="line">        <span class="comment">// NettyServerConfig包含Netty服务端的配置参数，Netty服务端口默认指定了9876</span></span><br><span class="line">        <span class="keyword">final</span> NamesrvConfig namesrvConfig = <span class="keyword">new</span> NamesrvConfig();</span><br><span class="line">        <span class="keyword">final</span> NettyServerConfig nettyServerConfig = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">        nettyServerConfig.setListenPort(<span class="number">9876</span>);</span><br><span class="line">        <span class="comment">//加载配置文件，解析三个配置对象</span></span><br><span class="line">        <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'c'</span>)) &#123;</span><br><span class="line">            String file = commandLine.getOptionValue(<span class="string">'c'</span>);</span><br><span class="line">            <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">                InputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">                properties = <span class="keyword">new</span> Properties();</span><br><span class="line">                properties.load(in);</span><br><span class="line">                MixAll.properties2Object(properties, namesrvConfig);</span><br><span class="line">                MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line">                namesrvConfig.setConfigStorePath(file);</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'p'</span>)) &#123;</span><br><span class="line">            InternalLogger console = InternalLoggerFactory.getLogger(LoggerName.NAMESRV_CONSOLE_NAME);</span><br><span class="line">            MixAll.printObjectProperties(console, namesrvConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyServerConfig);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), namesrvConfig);</span><br><span class="line">        <span class="comment">//ROCKETMQ_HOME环境变量检测</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == namesrvConfig.getRocketmqHome()) &#123;</span><br><span class="line">            System.exit(-<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//日志相关配置</span></span><br><span class="line">        configurator.doConfigure(namesrvConfig.getRocketmqHome() + <span class="string">"/conf/logback_namesrv.xml"</span>);</span><br><span class="line">        MixAll.printObjectProperties(log, namesrvConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, nettyServerConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> NamesrvController controller = <span class="keyword">new</span> NamesrvController(namesrvConfig, nettyServerConfig);</span><br><span class="line">        controller.getConfiguration().registerConfig(properties);</span><br><span class="line">        <span class="keyword">return</span> controller;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamesrvController <span class="title">start</span><span class="params">(<span class="keyword">final</span> NamesrvController controller)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == controller) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"NamesrvController is null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化，主要是初始化几个定时任务</span></span><br><span class="line">        <span class="keyword">boolean</span> initResult = controller.initialize();</span><br><span class="line">        <span class="keyword">if</span> (!initResult) &#123;</span><br><span class="line">            controller.shutdown();</span><br><span class="line">            System.exit(-<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 服务关闭钩子</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> ShutdownHookThread(log, <span class="keyword">new</span> Callable&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                controller.shutdown();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        controller.start(); <span class="comment">// 启动服务</span></span><br><span class="line">        <span class="keyword">return</span> controller;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>NamesrvController</code></strong>构造方法中会初始化<strong>路由信息管理类<code>RouteInfoManager</code></strong>，初始化一个<strong>Netty服务连接<code>Channel</code>的监听器<code>ChannelEventListener</code>的实现<code>BrokerHousekeepingService</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamesrvController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NamesrvController</span><span class="params">(NamesrvConfig namesrvConfig, NettyServerConfig nettyServerConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namesrvConfig = namesrvConfig;</span><br><span class="line">        <span class="keyword">this</span>.nettyServerConfig = nettyServerConfig;</span><br><span class="line">        <span class="keyword">this</span>.kvConfigManager = <span class="keyword">new</span> KVConfigManager(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.routeInfoManager = <span class="keyword">new</span> RouteInfoManager();</span><br><span class="line">        <span class="keyword">this</span>.brokerHousekeepingService = <span class="keyword">new</span> BrokerHousekeepingService(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.configuration = <span class="keyword">new</span> Configuration(log, <span class="keyword">this</span>.namesrvConfig, <span class="keyword">this</span>.nettyServerConfig);</span><br><span class="line">        <span class="keyword">this</span>.configuration.setStorePathFromConfig(<span class="keyword">this</span>.namesrvConfig, <span class="string">"configStorePath"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteInfoManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> BROKER_CHANNEL_EXPIRED_TIME = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>; <span class="comment">// Broker失效时间120秒</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* topic */</span>, List&lt;QueueData&gt;&gt; topicQueueTable;  <span class="comment">// 保存Topic对应的队列列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerName */</span>, BrokerData&gt; brokerAddrTable;  <span class="comment">// 保存Broker信息：brokerId，brokerAddr</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* clusterName */</span>, Set&lt;String<span class="comment">/* brokerName */</span>&gt;&gt; clusterAddrTable; <span class="comment">// 集群对应的Broker列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerAddr */</span>, BrokerLiveInfo&gt; brokerLiveTable; <span class="comment">// 保存最后一次停跳信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerAddr */</span>, List&lt;String&gt;<span class="comment">/* Filter Server */</span>&gt; filterServerTable;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RouteInfoManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.topicQueueTable = <span class="keyword">new</span> HashMap&lt;String, List&lt;QueueData&gt;&gt;(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">this</span>.brokerAddrTable = <span class="keyword">new</span> HashMap&lt;String, BrokerData&gt;(<span class="number">128</span>);</span><br><span class="line">        <span class="keyword">this</span>.clusterAddrTable = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;(<span class="number">32</span>);</span><br><span class="line">        <span class="keyword">this</span>.brokerLiveTable = <span class="keyword">new</span> HashMap&lt;String, BrokerLiveInfo&gt;(<span class="number">256</span>);</span><br><span class="line">        <span class="keyword">this</span>.filterServerTable = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;(<span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerHousekeepingService</span> <span class="keyword">implements</span> <span class="title">ChannelEventListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NamesrvController namesrvController;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BrokerHousekeepingService</span><span class="params">(NamesrvController namesrvController)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namesrvController = namesrvController;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChannelConnect</span><span class="params">(String remoteAddr, Channel channel)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChannelClose</span><span class="params">(String remoteAddr, Channel channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namesrvController.getRouteInfoManager().onChannelDestroy(remoteAddr, channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChannelException</span><span class="params">(String remoteAddr, Channel channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namesrvController.getRouteInfoManager().onChannelDestroy(remoteAddr, channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChannelIdle</span><span class="params">(String remoteAddr, Channel channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namesrvController.getRouteInfoManager().onChannelDestroy(remoteAddr, channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在NamesrvController初始化方法initialize中，首先将生成好的BrokerHousekeepingService监听器通过NettyRemotingServer构造函数设置到该类中，然后通过<strong><code>registerProcessor</code></strong>方法注册<strong>请求分发处理类<code>DefaultRequestProcessor</code></strong>，且开启以一个10s的周期任务通过执行<strong><code>scanNotActiveBroker</code></strong>方法，扫描保存<strong><code>broker</code></strong>心跳信息的<strong><code>brokerLiveTable</code></strong>中的心跳信息，判断是否<strong>超过120秒未收到心跳</strong>，若是则将broker通过<strong><code>onChannelDestroy</code></strong>方法从<strong><code>brokerAddrTable</code></strong>注册表中<strong>剔除</strong>，且同时剔除该broker对应的<strong><code>clusterAddrTable</code></strong>和<strong><code>topicQueueTable</code></strong>中关联的数据。其同时实例化一个文件监听线程<strong><code>FileWatchService</code></strong>，在NamesrvController的start方法中启动，用于扫描监听配置文件变化情况，实现配置文件热加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamesrvController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.kvConfigManager.load(); <span class="comment">// 加载KV配置</span></span><br><span class="line">        <span class="comment">// 创建NettyServer网络处理对象</span></span><br><span class="line">        <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.brokerHousekeepingService);</span><br><span class="line">        <span class="comment">// Netty服务器的工作线程池</span></span><br><span class="line">        <span class="keyword">this</span>.remotingExecutor = Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads(), <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"RemotingExecutorThread_"</span>));</span><br><span class="line">        <span class="keyword">this</span>.registerProcessor(); <span class="comment">// 注册Processor，把remotingExecutor注入到remotingServer中</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// 开启定时任务，每隔10s扫描一次Broker，移除不活跃的Broker，超过120s未接收到心跳则移除</span></span><br><span class="line">                NamesrvController.<span class="keyword">this</span>.routeInfoManager.scanNotActiveBroker();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">//开启定时任务，每隔10min打印一次KV配置</span></span><br><span class="line">                NamesrvController.<span class="keyword">this</span>.kvConfigManager.printAllPeriodically();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">if</span> (TlsSystemConfig.tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fileWatchService = <span class="keyword">new</span> FileWatchService(<span class="keyword">new</span> String[]&#123;TlsSystemConfig.tlsServerCertPath, TlsSystemConfig.tlsServerKeyPath, TlsSystemConfig.tlsServerTrustCertPath&#125;, <span class="keyword">new</span> FileWatchService.Listener() &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> certChanged, keyChanged = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(String path)</span> </span>&#123; <span class="comment">// 配置文件热加载体现</span></span><br><span class="line">                        <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerTrustCertPath)) &#123;</span><br><span class="line">                            reloadServerSslContext();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerCertPath)) &#123;</span><br><span class="line">                            certChanged = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerKeyPath)) &#123;</span><br><span class="line">                            keyChanged = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (certChanged &amp;&amp; keyChanged) &#123;</span><br><span class="line">                            certChanged = keyChanged = <span class="keyword">false</span>;</span><br><span class="line">                            reloadServerSslContext();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reloadServerSslContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        ((NettyRemotingServer) remotingServer).loadSslContext();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (namesrvConfig.isClusterTest()) &#123; <span class="comment">// 测试集群，不用管</span></span><br><span class="line">            <span class="keyword">this</span>.remotingServer.registerDefaultProcessor(<span class="keyword">new</span> ClusterTestRequestProcessor(<span class="keyword">this</span>, namesrvConfig.getProductEnvName()), <span class="keyword">this</span>.remotingExecutor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// NettyServer接收到的网络请求，就会由这个组件来处理。</span></span><br><span class="line">            <span class="keyword">this</span>.remotingServer.registerDefaultProcessor(<span class="keyword">new</span> DefaultRequestProcessor(<span class="keyword">this</span>), <span class="keyword">this</span>.remotingExecutor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteInfoManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 扫描不活动的Broker，超过120s未接收到心跳则移除，该工作每10s执行一次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanNotActiveBroker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 扫描的就是这个BrokerLiveTable，路由信息表，还有一个Brokernames</span></span><br><span class="line">        Iterator&lt;Entry&lt;String, BrokerLiveInfo&gt;&gt; it = <span class="keyword">this</span>.brokerLiveTable.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            Entry&lt;String, BrokerLiveInfo&gt; next = it.next();</span><br><span class="line">            <span class="keyword">long</span> last = next.getValue().getLastUpdateTimestamp();</span><br><span class="line">            <span class="comment">// 根据心跳时间判断是否存活的核心逻辑，判断最后心跳时间 + 120s 是否小于当前时间</span></span><br><span class="line">            <span class="keyword">if</span> ((last + BROKER_CHANNEL_EXPIRED_TIME) &lt; System.currentTimeMillis()) &#123;</span><br><span class="line">                RemotingUtil.closeChannel(next.getValue().getChannel()); <span class="comment">// 关闭连接</span></span><br><span class="line">                it.remove();</span><br><span class="line">                <span class="keyword">this</span>.onChannelDestroy(next.getKey(), next.getValue().getChannel());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChannelDestroy</span><span class="params">(String remoteAddr, Channel channel)</span> </span>&#123;</span><br><span class="line">        String brokerAddrFound = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.lock.readLock().lockInterruptibly();</span><br><span class="line">                    Iterator&lt;Entry&lt;String, BrokerLiveInfo&gt;&gt; itBrokerLiveTable = <span class="keyword">this</span>.brokerLiveTable.entrySet().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (itBrokerLiveTable.hasNext()) &#123;</span><br><span class="line">                        Entry&lt;String, BrokerLiveInfo&gt; entry = itBrokerLiveTable.next();</span><br><span class="line">                        <span class="keyword">if</span> (entry.getValue().getChannel() == channel) &#123;</span><br><span class="line">                            brokerAddrFound = entry.getKey();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.lock.readLock().unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == brokerAddrFound) &#123;</span><br><span class="line">            brokerAddrFound = remoteAddr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (brokerAddrFound != <span class="keyword">null</span> &amp;&amp; brokerAddrFound.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.lock.writeLock().lockInterruptibly();</span><br><span class="line">                    <span class="keyword">this</span>.brokerLiveTable.remove(brokerAddrFound);</span><br><span class="line">                    <span class="keyword">this</span>.filterServerTable.remove(brokerAddrFound);</span><br><span class="line">                    String brokerNameFound = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">boolean</span> removeBrokerName = <span class="keyword">false</span>;</span><br><span class="line">                    Iterator&lt;Entry&lt;String, BrokerData&gt;&gt; itBrokerAddrTable = <span class="keyword">this</span>.brokerAddrTable.entrySet().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (itBrokerAddrTable.hasNext() &amp;&amp; (<span class="keyword">null</span> == brokerNameFound)) &#123;</span><br><span class="line">                        BrokerData brokerData = itBrokerAddrTable.next().getValue();</span><br><span class="line">                        Iterator&lt;Entry&lt;Long, String&gt;&gt; it = brokerData.getBrokerAddrs().entrySet().iterator();</span><br><span class="line">                        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                            Entry&lt;Long, String&gt; entry = it.next();</span><br><span class="line">                            Long brokerId = entry.getKey();</span><br><span class="line">                            String brokerAddr = entry.getValue();</span><br><span class="line">                            <span class="keyword">if</span> (brokerAddr.equals(brokerAddrFound)) &#123;</span><br><span class="line">                                brokerNameFound = brokerData.getBrokerName();</span><br><span class="line">                                it.remove();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (brokerData.getBrokerAddrs().isEmpty()) &#123;</span><br><span class="line">                            removeBrokerName = <span class="keyword">true</span>;</span><br><span class="line">                            itBrokerAddrTable.remove();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (brokerNameFound != <span class="keyword">null</span> &amp;&amp; removeBrokerName) &#123;</span><br><span class="line">                        Iterator&lt;Entry&lt;String, Set&lt;String&gt;&gt;&gt; it = <span class="keyword">this</span>.clusterAddrTable.entrySet().iterator();</span><br><span class="line">                        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                            Entry&lt;String, Set&lt;String&gt;&gt; entry = it.next();</span><br><span class="line">                            String clusterName = entry.getKey();</span><br><span class="line">                            Set&lt;String&gt; brokerNames = entry.getValue();</span><br><span class="line">                            <span class="keyword">boolean</span> removed = brokerNames.remove(brokerNameFound);</span><br><span class="line">                            <span class="keyword">if</span> (removed) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (brokerNames.isEmpty()) &#123;</span><br><span class="line">                                    it.remove();</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (removeBrokerName) &#123;</span><br><span class="line">                        Iterator&lt;Entry&lt;String, List&lt;QueueData&gt;&gt;&gt; itTopicQueueTable = <span class="keyword">this</span>.topicQueueTable.entrySet().iterator();</span><br><span class="line">                        <span class="keyword">while</span> (itTopicQueueTable.hasNext()) &#123;</span><br><span class="line">                            Entry&lt;String, List&lt;QueueData&gt;&gt; entry = itTopicQueueTable.next();</span><br><span class="line">                            String topic = entry.getKey();</span><br><span class="line">                            List&lt;QueueData&gt; queueDataList = entry.getValue();</span><br><span class="line"></span><br><span class="line">                            Iterator&lt;QueueData&gt; itQueueData = queueDataList.iterator();</span><br><span class="line">                            <span class="keyword">while</span> (itQueueData.hasNext()) &#123;</span><br><span class="line">                                QueueData queueData = itQueueData.next();</span><br><span class="line">                                <span class="keyword">if</span> (queueData.getBrokerName().equals(brokerNameFound)) &#123;</span><br><span class="line">                                    itQueueData.remove();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (queueDataList.isEmpty()) &#123;</span><br><span class="line">                                itTopicQueueTable.remove();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.lock.writeLock().unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>start方法中主要是完成Netty服务端的启动，以及启动文件监听线程<strong><code>FileWatchService</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamesrvController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.start();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fileWatchService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fileWatchService.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyRemotingServer</span> <span class="keyword">extends</span> <span class="title">NettyRemotingAbstract</span> <span class="keyword">implements</span> <span class="title">RemotingServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> NettyServerHandler serverHandler; <span class="comment">// 其实就是实现了channelRead0方法</span></span><br><span class="line">    <span class="meta">@ChannelHandler</span>.Sharable <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">RemotingCommand</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            processMessageReceived(ctx, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultEventExecutorGroup = <span class="keyword">new</span> DefaultEventExecutorGroup(</span><br><span class="line">            nettyServerConfig.getServerWorkerThreads(),</span><br><span class="line">            <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                <span class="keyword">private</span> AtomicInteger threadIndex = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"NettyServerCodecThread_"</span> + <span class="keyword">this</span>.threadIndex.incrementAndGet());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        prepareSharableHandlers();</span><br><span class="line">        <span class="comment">//K1 Netty服务启动的核心流程，主要核心是基于Netty的API去配置和启动一个Netty网络服务器。</span></span><br><span class="line">        ServerBootstrap childHandler =</span><br><span class="line">            <span class="keyword">this</span>.serverBootstrap.group(<span class="keyword">this</span>.eventLoopGroupBoss, <span class="keyword">this</span>.eventLoopGroupSelector)</span><br><span class="line">            .channel(useEpoll() ? EpollServerSocketChannel.class : NioServerSocketChannel.class)</span><br><span class="line">            .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">            .option(ChannelOption.SO_REUSEADDR, <span class="keyword">true</span>)</span><br><span class="line">            .option(ChannelOption.SO_KEEPALIVE, <span class="keyword">false</span>)</span><br><span class="line">            .childOption(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">            .childOption(ChannelOption.SO_SNDBUF, nettyServerConfig.getServerSocketSndBufSize())</span><br><span class="line">            .childOption(ChannelOption.SO_RCVBUF, nettyServerConfig.getServerSocketRcvBufSize())</span><br><span class="line">            .localAddress(<span class="keyword">new</span> InetSocketAddress(<span class="keyword">this</span>.nettyServerConfig.getListenPort()))</span><br><span class="line">            <span class="comment">// Netty服务收到一个请求，那么就会依次使用下面的处理器来处理请求，serverHandler是负责最关键的网络请求处理的</span></span><br><span class="line">            .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ch.pipeline().addLast(defaultEventExecutorGroup, HANDSHAKE_HANDLER_NAME, handshakeHandler)</span><br><span class="line">                        .addLast(defaultEventExecutorGroup,</span><br><span class="line">                                 encoder,</span><br><span class="line">                                 <span class="keyword">new</span> NettyDecoder(),</span><br><span class="line">                                 <span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">0</span>, nettyServerConfig.getServerChannelMaxIdleTimeSeconds()),</span><br><span class="line">                                 connectionManageHandler,</span><br><span class="line">                                 serverHandler <span class="comment">// 处理转发请求和响应的Handler</span></span><br><span class="line">                                );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nettyServerConfig.isServerPooledByteBufAllocatorEnable()) &#123;</span><br><span class="line">            childHandler.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123; <span class="comment">//真正启动Netty服务端</span></span><br><span class="line">            ChannelFuture sync = <span class="keyword">this</span>.serverBootstrap.bind().sync();</span><br><span class="line">            InetSocketAddress addr = (InetSocketAddress) sync.channel().localAddress();</span><br><span class="line">            <span class="keyword">this</span>.port = addr.getPort();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.channelEventListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nettyEventExecutor.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123; <span class="comment">// 定期扫描过期超时已弃用的请求</span></span><br><span class="line">                    NettyRemotingServer.<span class="keyword">this</span>.scanResponseTable();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">3</span>, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="DefaultRequestProcessor工作原理"><a href="#DefaultRequestProcessor工作原理" class="headerlink" title="DefaultRequestProcessor工作原理"></a>DefaultRequestProcessor工作原理</h5><p>Netty在处理请求时通过调用<strong><code>NettyRemotingServer</code></strong>中的<strong><code>NettyServerHandler</code></strong>内部类的<strong><code>channelRead0</code></strong>方法，从而调用NettyRemotingAbstract的processRequestCommand方法，最终将请求交给DefaultRequestProcessor的核心方法<strong><code>processRequest</code></strong>来分发请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyRemotingServer</span> <span class="keyword">extends</span> <span class="title">NettyRemotingAbstract</span> <span class="keyword">implements</span> <span class="title">RemotingServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Pair&lt;NettyRequestProcessor, ExecutorService&gt; defaultRequestProcessor;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDefaultProcessor</span><span class="params">(NettyRequestProcessor processor, ExecutorService executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultRequestProcessor = <span class="keyword">new</span> Pair&lt;NettyRequestProcessor, ExecutorService&gt;(processor, executor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">RemotingCommand</span>&gt; </span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                processMessageReceived(ctx, msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyRemotingAbstract</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processMessageReceived</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> RemotingCommand cmd = msg;</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (cmd.getType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> REQUEST_COMMAND:</span><br><span class="line">                    processRequestCommand(ctx, cmd);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RESPONSE_COMMAND:</span><br><span class="line">                    processResponseCommand(ctx, cmd);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequestCommand</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> RemotingCommand cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Pair&lt;NettyRequestProcessor, ExecutorService&gt; matched = <span class="keyword">this</span>.processorTable.get(cmd.getCode());</span><br><span class="line">        <span class="keyword">final</span> Pair&lt;NettyRequestProcessor, ExecutorService&gt; pair = <span class="keyword">null</span> == matched ? <span class="keyword">this</span>.defaultRequestProcessor : matched;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> opaque = cmd.getOpaque();</span><br><span class="line">        <span class="keyword">if</span> (pair != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Runnable run = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        doBeforeRpcHooks(RemotingHelper.parseChannelRemoteAddr(ctx.channel()), cmd);</span><br><span class="line">                        <span class="keyword">final</span> RemotingResponseCallback callback = <span class="keyword">new</span> RemotingResponseCallback() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callback</span><span class="params">(RemotingCommand response)</span> </span>&#123;</span><br><span class="line">                                doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(ctx.channel()), cmd, response);</span><br><span class="line">                                <span class="keyword">if</span> (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                        response.setOpaque(opaque);</span><br><span class="line">                                        response.markResponseType();</span><br><span class="line">                                        <span class="keyword">try</span> &#123;</span><br><span class="line">                                            ctx.writeAndFlush(response);</span><br><span class="line">                                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;;</span><br><span class="line">                        <span class="keyword">if</span> (pair.getObject1() <span class="keyword">instanceof</span> AsyncNettyRequestProcessor) &#123;</span><br><span class="line">                            AsyncNettyRequestProcessor processor = (AsyncNettyRequestProcessor)pair.getObject1();</span><br><span class="line">                            processor.asyncProcessRequest(ctx, cmd, callback);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            NettyRequestProcessor processor = pair.getObject1();</span><br><span class="line">                            RemotingCommand response = processor.processRequest(ctx, cmd);</span><br><span class="line">                            callback.callback(response);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                            <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_ERROR,</span><br><span class="line">                                                                                                   RemotingHelper.exceptionSimpleDesc(e));</span><br><span class="line">                            response.setOpaque(opaque);</span><br><span class="line">                            ctx.writeAndFlush(response);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span> (pair.getObject1().rejectRequest()) &#123;</span><br><span class="line">                <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_BUSY, <span class="string">"[REJECTREQUEST]system busy, start flow control for a while"</span>);</span><br><span class="line">                response.setOpaque(opaque);</span><br><span class="line">                ctx.writeAndFlush(response);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> RequestTask requestTask = <span class="keyword">new</span> RequestTask(run, ctx.channel(), cmd);</span><br><span class="line">                pair.getObject2().submit(requestTask);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_BUSY, <span class="string">"[OVERLOAD]system busy, start flow control for a while"</span>);</span><br><span class="line">                    response.setOpaque(opaque);</span><br><span class="line">                    ctx.writeAndFlush(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String error = <span class="string">" request type "</span> + cmd.getCode() + <span class="string">" not supported"</span>;</span><br><span class="line">            <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.REQUEST_CODE_NOT_SUPPORTED, error);</span><br><span class="line">            response.setOpaque(opaque);</span><br><span class="line">            ctx.writeAndFlush(response);</span><br><span class="line">            log.error(RemotingHelper.parseChannelRemoteAddr(ctx.channel()) + error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRequestProcessor</span> <span class="keyword">extends</span> <span class="title">AsyncNettyRequestProcessor</span> <span class="keyword">implements</span> <span class="title">NettyRequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">processRequest</span><span class="params">(ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">"receive request, &#123;&#125; &#123;&#125; &#123;&#125;"</span>, request.getCode(), RemotingHelper.parseChannelRemoteAddr(ctx.channel()), request);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//K2 这里是NameServer处理请求的核心代码。根据请求类型有不同的处理过程</span></span><br><span class="line">        <span class="keyword">switch</span> (request.getCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> RequestCode.PUT_KV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.putKVConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_KV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getKVConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.DELETE_KV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.deleteKVConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.QUERY_DATA_VERSION:</span><br><span class="line">                <span class="keyword">return</span> queryBrokerTopicConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.REGISTER_BROKER:   <span class="comment">// 注册Broker的请求</span></span><br><span class="line">                Version brokerVersion = MQVersion.value2Version(request.getVersion());</span><br><span class="line">                <span class="keyword">if</span> (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.registerBrokerWithFilterServer(ctx, request);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">//注册Broker的实际方法</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.registerBroker(ctx, request);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> RequestCode.UNREGISTER_BROKER: <span class="comment">// 注销Broker请求</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.unregisterBroker(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_ROUTEINFO_BY_TOPIC: <span class="comment">// 通过Topic获取路由信息</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getRouteInfoByTopic(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_BROKER_CLUSTER_INFO: <span class="comment">// 获取Broker集群信息</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getBrokerClusterInfo(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.WIPE_WRITE_PERM_OF_BROKER:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.wipeWritePermOfBroker(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER: <span class="comment">// 获取所有的Topic列表</span></span><br><span class="line">                <span class="keyword">return</span> getAllTopicListFromNameserver(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.DELETE_TOPIC_IN_NAMESRV: <span class="comment">// 删除Topic</span></span><br><span class="line">                <span class="keyword">return</span> deleteTopicInNamesrv(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_KVLIST_BY_NAMESPACE:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getKVListByNamespace(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_TOPICS_BY_CLUSTER:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getTopicsByCluster(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getSystemTopicListFromNs(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_UNIT_TOPIC_LIST:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getUnitTopicList(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getHasUnitSubTopicList(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getHasUnitSubUnUnitTopicList(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.UPDATE_NAMESRV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.updateConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_NAMESRV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getConfig(ctx, request);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="BrokerServer启动"><a href="#BrokerServer启动" class="headerlink" title="BrokerServer启动"></a>BrokerServer启动</h4><p>Broker主要负责<strong>消息的存储</strong>、<strong>投递</strong>和<strong>查询</strong>以及<strong>服务高可用保证</strong>，为了实现这些功能，Broker包含了以下几个重要子模块。</p>
<ul>
<li><strong><code>Remoting Module</code></strong>：整个Broker的实体，负责<strong>处理来自clients端的请求</strong>。</li>
<li><strong><code>Client Manager</code></strong>：负责管理Producer和Consumer客户端和<strong>维护<code>Consumer</code>的<code>Topic</code>订阅信息</strong></li>
<li><strong><code>Store Service</code></strong>：提供方便简单的API接口处理<strong>消息存储到物理硬盘</strong>和<strong>查询功能</strong>。</li>
<li><strong><code>HA Service</code></strong>：高可用服务，提供<strong><code>Master Broker</code></strong>和<strong><code>Slave Broker</code></strong>之间的<strong>数据同步功能</strong>。</li>
<li><strong><code>Index Service</code></strong>：根据特定Message key对投递到Broker的消息进行<strong>索引服务</strong>，以提供消息的<strong>快速查询</strong>。</li>
</ul>
<p><strong>4.5</strong>之前<strong><code>Broker</code>分为<code>Master</code>与<code>Slave</code></strong>，一个Master可对应多个Slave，一个Slave只能对应一个Master，<strong>Master与Slave对应关系通过指定相同的<code>BrokerName</code>不同<code>BrokerId</code></strong>来定义，<strong><code>BrokerId</code>为<code>0</code>表示<code>Master</code></strong>，<strong>非<code>0</code>表示<code>Slave</code></strong>。Master可部署多个。<strong>每个<code>Broker</code></strong>与NameServer集群中的<strong>所有节点建立长连接</strong>，<strong>定时注册<code>Topic</code>信息</strong>到所有NameServer。 虽然支持一Master多Slave，但只有<strong><code>BrokerId=1</code></strong>的从服务器才会参与<strong>消息读负载</strong>。Broker启动后跟<strong>所有的<code>NameServer</code>保持长连接</strong>，定时发送心跳包。心跳包中包含当前Broker如IP、端口等信息，以及存储所有Topic信息。注册成功后NameServer集群中就有<strong><code>Topic</code>与<code>Broker</code>映射关系</strong>。</p>
<p>Broker启动的时候，会启动一个定时任务，定期的从Master Broker同步全量的数据。且<strong>Broker启动时会向NameServer注册自己</strong>，且每隔<strong><code>30</code>秒</strong>向NameServerv发送<strong>心跳</strong>，若某个Broker超过了<strong><code>120</code>秒</strong>没有发送心跳，则认为该Broker宕机并将其从维护信息中移除。</p>
<p>BrokerServer的启动是通过BrokerStartup的main方法完成的，通过createBrokerController方法创建Broker核心配置类，主要是<strong>解析配置文件中配置的参数</strong>，设置到几个配置类中，如Broker Server相关的配置类<strong><code>BrokerConfig</code></strong>，Broker<strong>服务端Netty</strong>配置类<strong><code>NettyServerConfig</code></strong>，Broker<strong>客户端Netty</strong>配置类<strong><code>NettyClientConfig</code></strong>，以及<strong>存储消息</strong>相关的配置类<strong><code>MessageStoreConfig</code></strong>，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerStartup</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        start(createBrokerController(args));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title">start</span><span class="params">(BrokerController controller)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;<span class="comment">// Controller启动</span></span><br><span class="line">            controller.start();</span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建Broker核心配置</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title">createBrokerController</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION)); <span class="comment">// 将当前RocketMQ版本号设置到环境变量中</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_SNDBUF_SIZE)) &#123;</span><br><span class="line">            NettySystemConfig.socketSndbufSize = <span class="number">131072</span>; <span class="comment">// remoting socket sndbuf size</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_RCVBUF_SIZE)) &#123;</span><br><span class="line">            NettySystemConfig.socketRcvbufSize = <span class="number">131072</span>; <span class="comment">// remoting socket rcvbuf size</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//PackageConflictDetect.detectFastjson();</span></span><br><span class="line">            Options options = ServerUtil.buildCommandlineOptions(<span class="keyword">new</span> Options());</span><br><span class="line">            commandLine = ServerUtil.parseCmdLine(<span class="string">"mqbroker"</span>, args, buildCommandlineOptions(options), <span class="keyword">new</span> PosixParser());</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == commandLine) &#123;</span><br><span class="line">                System.exit(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Broker的核心配置信息</span></span><br><span class="line">            <span class="keyword">final</span> BrokerConfig brokerConfig = <span class="keyword">new</span> BrokerConfig();</span><br><span class="line">            <span class="keyword">final</span> NettyServerConfig nettyServerConfig = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">            <span class="keyword">final</span> NettyClientConfig nettyClientConfig = <span class="keyword">new</span> NettyClientConfig();</span><br><span class="line">            <span class="comment">// TLS加密相关</span></span><br><span class="line">            nettyClientConfig.setUseTLS(Boolean.parseBoolean(System.getProperty(TLS_ENABLE, String.valueOf(TlsSystemConfig.tlsMode == TlsMode.ENFORCING))));</span><br><span class="line">            <span class="comment">// Netty服务端的监听端口10911</span></span><br><span class="line">            nettyServerConfig.setListenPort(<span class="number">10911</span>);</span><br><span class="line">            <span class="comment">// 这个明显是Broker用来存储消息的一些配置信息</span></span><br><span class="line">            <span class="keyword">final</span> MessageStoreConfig messageStoreConfig = <span class="keyword">new</span> MessageStoreConfig();</span><br><span class="line">            <span class="comment">// 若是SLAVE，会设置一个参数</span></span><br><span class="line">            <span class="keyword">if</span> (BrokerRole.SLAVE == messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="keyword">int</span> ratio = messageStoreConfig.getAccessMessageInMemoryMaxRatio() - <span class="number">10</span>;</span><br><span class="line">                messageStoreConfig.setAccessMessageInMemoryMaxRatio(ratio); <span class="comment">// 访问消息内存最大比率</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 加载配置文件中的配置到配置类中</span></span><br><span class="line">            <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'c'</span>)) &#123;</span><br><span class="line">                String file = commandLine.getOptionValue(<span class="string">'c'</span>);</span><br><span class="line">                <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    configFile = file;</span><br><span class="line">                    InputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">                    properties = <span class="keyword">new</span> Properties();</span><br><span class="line">                    properties.load(in);</span><br><span class="line">                    properties2SystemEnv(properties);</span><br><span class="line">                    MixAll.properties2Object(properties, brokerConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, nettyClientConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, messageStoreConfig);</span><br><span class="line">                    BrokerPathConfigHelper.setBrokerConfigPath(file);</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// 填充brokerConfig</span></span><br><span class="line">            MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), brokerConfig);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == brokerConfig.getRocketmqHome()) &#123;</span><br><span class="line">                System.exit(-<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            String namesrvAddr = brokerConfig.getNamesrvAddr(); <span class="comment">// 获取NameServer地址</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != namesrvAddr) &#123; <span class="comment">// 验证NameServer地址</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String[] addrArray = namesrvAddr.split(<span class="string">";"</span>); <span class="comment">// 配置一个集群</span></span><br><span class="line">                    <span class="keyword">for</span> (String addr : addrArray) &#123;</span><br><span class="line">                        RemotingUtil.string2SocketAddress(addr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.exit(-<span class="number">3</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判断集群角色，通过BrokerId判断主从</span></span><br><span class="line">            <span class="keyword">switch</span> (messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="keyword">case</span> ASYNC_MASTER:</span><br><span class="line">                <span class="keyword">case</span> SYNC_MASTER:</span><br><span class="line">                    brokerConfig.setBrokerId(MixAll.MASTER_ID);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> SLAVE:</span><br><span class="line">                    <span class="keyword">if</span> (brokerConfig.getBrokerId() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        System.exit(-<span class="number">3</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判断是否基于Dledger技术来管理主从同步和CommitLog的条件就是brokerId设置为-1</span></span><br><span class="line">            <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">                brokerConfig.setBrokerId(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            messageStoreConfig.setHaListenPort(nettyServerConfig.getListenPort() + <span class="number">1</span>); <span class="comment">// 主从同步端口</span></span><br><span class="line">            <span class="comment">// 注意下这里又是个神奇的配置文件指定。</span></span><br><span class="line">            configurator.doConfigure(brokerConfig.getRocketmqHome() + <span class="string">"/conf/logback_broker.xml"</span>);</span><br><span class="line">            <span class="comment">// 创建BrokerController</span></span><br><span class="line">            <span class="keyword">final</span> BrokerController controller = <span class="keyword">new</span> BrokerController(brokerConfig, nettyServerConfig, nettyClientConfig, messageStoreConfig);</span><br><span class="line">            <span class="comment">// remember all configs to prevent discard</span></span><br><span class="line">            controller.getConfiguration().registerConfig(properties); <span class="comment">// 存储所有配置防止丢失</span></span><br><span class="line">            <span class="comment">// 初始化注意从中理清楚Broker的组件结构</span></span><br><span class="line">            <span class="keyword">boolean</span> initResult = controller.initialize();</span><br><span class="line">            <span class="keyword">if</span> (!initResult) &#123;</span><br><span class="line">                controller.shutdown();</span><br><span class="line">                System.exit(-<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过BrokerController构造方法传入几个配置配，完成一些<strong>功能组件的初始化</strong>：</p>
<ul>
<li><strong><code>ConsumerOffsetManager</code></strong>：管理<strong>某个消费者组消费某个topic的某个队列的offset</strong></li>
<li><strong>TopicConfigManager</strong>：Topic配置管理类，其初始化时会初始化一系列内部消息队列配置，以及作为<strong>创建新<code>Topic</code></strong>的模板的<strong><code>TBW102</code></strong>，如<strong><code>SCHEDULE_TOPIC_XXXX</code></strong>延迟消息队列，管理到<strong><code>topicConfigTable</code></strong>中</li>
<li><strong>PullMessageProcessor</strong>：处理消息拉取请求的<strong><code>NettyRequestProcessor</code></strong>，同NameServer中处理请求分发的<strong><code>DefaultRequestProcessor</code></strong>类似</li>
<li><strong>PullRequestHoldService</strong>：管理消息拉<strong>取消费者长连接请求线程</strong></li>
<li><strong>NotifyMessageArrivingListener</strong>：消息通知监听器</li>
<li><strong>ConsumerManager</strong>：消费者管理类</li>
<li><strong>ProducerManager</strong>：生产者管理类</li>
<li>发送、拉取、重试、查询、客户端管理、消费者管理、心跳等一系列<strong>阻塞队列</strong>初始化</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BrokerController</span><span class="params">(<span class="keyword">final</span> BrokerConfig brokerConfig, <span class="keyword">final</span> NettyServerConfig nettyServerConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">final</span> NettyClientConfig nettyClientConfig, <span class="keyword">final</span> MessageStoreConfig messageStoreConfig)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//四个核心组件保存起来。</span></span><br><span class="line">        <span class="keyword">this</span>.brokerConfig = brokerConfig;</span><br><span class="line">        <span class="keyword">this</span>.nettyServerConfig = nettyServerConfig;</span><br><span class="line">        <span class="keyword">this</span>.nettyClientConfig = nettyClientConfig;</span><br><span class="line">        <span class="keyword">this</span>.messageStoreConfig = messageStoreConfig;</span><br><span class="line">        <span class="comment">//K2 Broker的各种功能对应的组件。</span></span><br><span class="line">        <span class="keyword">this</span>.consumerOffsetManager = <span class="keyword">new</span> ConsumerOffsetManager(<span class="keyword">this</span>);<span class="comment">// 管理consumer消费offset</span></span><br><span class="line">        <span class="keyword">this</span>.topicConfigManager = <span class="keyword">new</span> TopicConfigManager(<span class="keyword">this</span>); <span class="comment">// 管理Topic配置，创建一系列系统默认的队列</span></span><br><span class="line">        <span class="keyword">this</span>.pullMessageProcessor = <span class="keyword">new</span> PullMessageProcessor(<span class="keyword">this</span>); <span class="comment">// 处理Consumer拉取消息的请求的</span></span><br><span class="line">        <span class="keyword">this</span>.pullRequestHoldService = <span class="keyword">new</span> PullRequestHoldService(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.messageArrivingListener = <span class="keyword">new</span> NotifyMessageArrivingListener(<span class="keyword">this</span>.pullRequestHoldService);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.consumerIdsChangeListener = <span class="keyword">new</span> DefaultConsumerIdsChangeListener(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.consumerManager = <span class="keyword">new</span> ConsumerManager(<span class="keyword">this</span>.consumerIdsChangeListener);</span><br><span class="line">        <span class="keyword">this</span>.consumerFilterManager = <span class="keyword">new</span> ConsumerFilterManager(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.producerManager = <span class="keyword">new</span> ProducerManager();</span><br><span class="line">        <span class="keyword">this</span>.clientHousekeepingService = <span class="keyword">new</span> ClientHousekeepingService(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.broker2Client = <span class="keyword">new</span> Broker2Client(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.subscriptionGroupManager = <span class="keyword">new</span> SubscriptionGroupManager(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.brokerOuterAPI = <span class="keyword">new</span> BrokerOuterAPI(nettyClientConfig);</span><br><span class="line">        <span class="keyword">this</span>.filterServerManager = <span class="keyword">new</span> FilterServerManager(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.slaveSynchronize = <span class="keyword">new</span> SlaveSynchronize(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sendThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getSendThreadPoolQueueCapacity());</span><br><span class="line">        <span class="keyword">this</span>.pullThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getPullThreadPoolQueueCapacity());</span><br><span class="line">        <span class="keyword">this</span>.replyThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getReplyThreadPoolQueueCapacity());</span><br><span class="line">        <span class="keyword">this</span>.queryThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getQueryThreadPoolQueueCapacity());</span><br><span class="line">        <span class="keyword">this</span>.clientManagerThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getClientManagerThreadPoolQueueCapacity());</span><br><span class="line">        <span class="keyword">this</span>.consumerManagerThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getConsumerManagerThreadPoolQueueCapacity());</span><br><span class="line">        <span class="keyword">this</span>.heartbeatThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolQueueCapacity());</span><br><span class="line">        <span class="keyword">this</span>.endTransactionThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="keyword">this</span>.brokerConfig.getEndTransactionPoolQueueCapacity());</span><br><span class="line">        <span class="comment">// 也是Borker的一些功能性组件。</span></span><br><span class="line">        <span class="keyword">this</span>.brokerStatsManager = <span class="keyword">new</span> BrokerStatsManager(<span class="keyword">this</span>.brokerConfig.getBrokerClusterName());</span><br><span class="line">        <span class="keyword">this</span>.setStoreHost(<span class="keyword">new</span> InetSocketAddress(<span class="keyword">this</span>.getBrokerConfig().getBrokerIP1(), <span class="keyword">this</span>.getNettyServerConfig().getListenPort()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.brokerFastFailure = <span class="keyword">new</span> BrokerFastFailure(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.configuration = <span class="keyword">new</span> Configuration(log, BrokerPathConfigHelper.getBrokerConfigPath(),                <span class="keyword">this</span>.brokerConfig, <span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.nettyClientConfig, <span class="keyword">this</span>.messageStoreConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicConfigManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, TopicConfig&gt; topicConfigTable = <span class="keyword">new</span> ConcurrentHashMap&lt;String, TopicConfig&gt;(<span class="number">1024</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TopicConfigManager</span><span class="params">(BrokerController brokerController)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerController = brokerController;</span><br><span class="line">        &#123;</span><br><span class="line">            String topic = TopicValidator.RMQ_SYS_SELF_TEST_TOPIC; <span class="comment">// SELF_TEST_TOPIC</span></span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            TopicValidator.addSystemTopic(topic);</span><br><span class="line">            topicConfig.setReadQueueNums(<span class="number">1</span>);</span><br><span class="line">            topicConfig.setWriteQueueNums(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isAutoCreateTopicEnable()) &#123; <span class="comment">// 是否自动创建Topic，默认true</span></span><br><span class="line">                String topic = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC; <span class="comment">// TBW102，作为创建新Topic的模板</span></span><br><span class="line">                TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">                TopicValidator.addSystemTopic(topic);</span><br><span class="line">                topicConfig.setReadQueueNums(<span class="keyword">this</span>.brokerController.getBrokerConfig().getDefaultTopicQueueNums()); <span class="comment">// 8</span></span><br><span class="line">                topicConfig.setWriteQueueNums(<span class="keyword">this</span>.brokerController.getBrokerConfig().getDefaultTopicQueueNums()); <span class="comment">// 8</span></span><br><span class="line">                <span class="keyword">int</span> perm = PermName.PERM_INHERIT | PermName.PERM_READ | PermName.PERM_WRITE;</span><br><span class="line">                topicConfig.setPerm(perm);</span><br><span class="line">                <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            String topic = TopicValidator.RMQ_SYS_BENCHMARK_TOPIC; <span class="comment">// BenchmarkTest</span></span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            TopicValidator.addSystemTopic(topic);</span><br><span class="line">            topicConfig.setReadQueueNums(<span class="number">1024</span>);</span><br><span class="line">            topicConfig.setWriteQueueNums(<span class="number">1024</span>);</span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            String topic = <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerClusterName(); <span class="comment">// DefaultCluster</span></span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            TopicValidator.addSystemTopic(topic);</span><br><span class="line">            <span class="keyword">int</span> perm = PermName.PERM_INHERIT;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isClusterTopicEnable()) &#123;</span><br><span class="line">                perm |= PermName.PERM_READ | PermName.PERM_WRITE;</span><br><span class="line">            &#125;</span><br><span class="line">            topicConfig.setPerm(perm);</span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            String topic = <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerName();</span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            TopicValidator.addSystemTopic(topic);</span><br><span class="line">            <span class="keyword">int</span> perm = PermName.PERM_INHERIT;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isBrokerTopicEnable()) &#123;</span><br><span class="line">                perm |= PermName.PERM_READ | PermName.PERM_WRITE;</span><br><span class="line">            &#125;</span><br><span class="line">            topicConfig.setReadQueueNums(<span class="number">1</span>);</span><br><span class="line">            topicConfig.setWriteQueueNums(<span class="number">1</span>);</span><br><span class="line">            topicConfig.setPerm(perm);</span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            String topic = TopicValidator.RMQ_SYS_OFFSET_MOVED_EVENT;</span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            TopicValidator.addSystemTopic(topic);</span><br><span class="line">            topicConfig.setReadQueueNums(<span class="number">1</span>);</span><br><span class="line">            topicConfig.setWriteQueueNums(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123; <span class="comment">// 创建延时队列</span></span><br><span class="line">            String topic = TopicValidator.RMQ_SYS_SCHEDULE_TOPIC; <span class="comment">// SCHEDULE_TOPIC_XXXX</span></span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            TopicValidator.addSystemTopic(topic);</span><br><span class="line">            topicConfig.setReadQueueNums(SCHEDULE_TOPIC_QUEUE_NUM); <span class="comment">// 18</span></span><br><span class="line">            topicConfig.setWriteQueueNums(SCHEDULE_TOPIC_QUEUE_NUM); <span class="comment">// 18</span></span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isTraceTopicEnable()) &#123; <span class="comment">// RMQ_SYS_TRACE_TOPIC</span></span><br><span class="line">                String topic = <span class="keyword">this</span>.brokerController.getBrokerConfig().getMsgTraceTopicName();</span><br><span class="line">                TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">                TopicValidator.addSystemTopic(topic);</span><br><span class="line">                topicConfig.setReadQueueNums(<span class="number">1</span>);</span><br><span class="line">                topicConfig.setWriteQueueNums(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            String topic = <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerClusterName() + <span class="string">"_"</span> + MixAll.REPLY_TOPIC_POSTFIX;</span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            TopicValidator.addSystemTopic(topic);</span><br><span class="line">            topicConfig.setReadQueueNums(<span class="number">1</span>);</span><br><span class="line">            topicConfig.setWriteQueueNums(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用BrokerController的<strong><code>initialize</code></strong>方法，首先加载一些磁盘中的如topic信息、队列消费偏移量等基础数据，然后实例化消息存储管理组件<strong><code>DefaultMessageStore</code></strong>、broker的统计组件<strong><code>BrokerStats</code></strong>，然后通过MessageStore的load方法<strong>检查<code>abort</code>文件</strong>、加载恢复延队列数据、加载恢复<strong><code>commitLog</code></strong>数据、加载恢复<strong><code>ConsumeQueue</code></strong>队列数据、加载恢复<strong><code>Index</code></strong>数据。</p>
<p>在<strong><code>DefaultMessageStore</code></strong>的实例化过程中会实例化以下一些比较重要的类：</p>
<ul>
<li><strong><code>MMap</code></strong>内存映射处理服务<strong><code>AllocateMappedFileService</code></strong></li>
<li><strong>消息队列刷盘服务<code>FlushConsumeQueueService</code></strong></li>
<li>定期<strong>清理过期<code>commitLog</code></strong>文件的服务<strong><code>CleanCommitLogService</code></strong></li>
<li>清理<strong>过期消息队列</strong>的服务<strong><code>CleanConsumeQueueService</code></strong></li>
<li>用于<strong>统计消息<code>put</code>到<code>commitLog</code>中</strong>花费的时间段的消息数统计<strong><code>StoreStatsService</code></strong></li>
<li>初始化消息<strong>索引</strong>服务<strong><code>IndexService</code></strong>，根据特定<strong><code>Message key</code></strong>对投递到Broker的消息进行索引服务，以提供消息的快速查询</li>
<li>若不是<strong><code>DLeger</code></strong>模式启动的，则需要启动主从同步服务<strong><code>HAService</code></strong></li>
<li>完成消息从CommitLog中转发到<strong><code>ConsumeQueue</code></strong>和<strong><code>IndexFile</code></strong>文件的<strong><code>ReputMessageService</code></strong>线程</li>
<li>延迟消息处理的<strong><code>ScheduleMessageService</code></strong></li>
</ul>
<p>然后实例化<strong><code>NettyRemotingServer</code></strong>、实例化处理<strong>发送消息</strong>线程的线程池<strong><code>sendMessageExecutor</code></strong>、实例化<strong>处理consumer的pull请求</strong>的线程池<strong><code>pullMessageExecutor</code></strong>、实例化<strong>回复消息</strong>的线程池<strong><code>replyMessageExecutor</code></strong>、实例化<strong>查询消息</strong>的线程池<strong><code>queryMessageExecutor</code></strong>、实例化<strong>管理<code>Broker</code>命令执行</strong>的线程池<strong><code>adminBrokerExecutor</code></strong>、实例化<strong>管理客户端</strong>的线程池<strong><code>clientManageExecutor</code></strong>、实例化处理<strong>心跳请求</strong>线程池<strong><code>heartbeatExecutor</code></strong>、实例化处理<strong>事务消息结束</strong>线程池<strong><code>endTransactionExecutor</code></strong>、实例化<strong>管理consumer</strong>的线程池<strong><code>consumerManageExecutor</code></strong>.</p>
<p>然后在<strong><code>registerProcessor</code></strong>方法中实例化<strong>以上线程池</strong>对应的<strong><code>NettyRequestProcessor</code></strong>，且将这些处理请求的处理器与对应的<strong><code>RequestCode</code></strong>绑定<strong>注册</strong>到<strong><code>processorTable</code></strong>中，当处理对应<strong><code>RequestCode</code></strong>请求时，通过<strong>创建一个Runnable线程</strong>提交到<strong>绑定的线程池中</strong>处理，也能起到<strong>线程池隔离</strong>作用。在NameServer中也有该过程，只是NameServer中<strong>没有做线程池隔离</strong>都是统一通过<strong><code>DefaultRequestProcessor</code></strong>来完成。</p>
<p>然后创建一些<strong>周期任务</strong>，如<strong>处理定时进行broker统计的任务</strong>、定时进行<strong><code>consumer</code></strong>消费<strong><code>offset</code></strong>持久化到磁盘的任务<strong><code>10s</code></strong>后开始每<strong><code>5s</code></strong>执行一次，对<strong><code>consumer</code></strong>的<strong><code>filter</code></strong>过滤器进行持久化的任务。</p>
<p>然后通过<strong><code>initialTransaction</code></strong>方法通过<strong>SPI机制</strong>初始化<strong>处理事务消息</strong>的<strong><code>TransactionalMessageService</code></strong>的实现类<strong><code>TransactionalMessageServiceImpl</code></strong>，且这里使用<strong>桥接模式</strong>使得<strong><code>TransactionalMessageService</code></strong>中可以调用<strong><code>MessageStore</code></strong>方法。以及<strong><code>initialAcl</code></strong>初始化ACL权限相关的<strong><code>AccessValidator</code></strong>列表，和<strong><code>initialRpcHooks</code></strong>初始化<strong><code>RPCHook</code></strong>列表；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="comment">//加载磁盘上的配置信息。这些配置信息就用到了MessageStoreConfig</span></span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">this</span>.topicConfigManager.load(); <span class="comment">// 加载配置文件broker.conf中配置的路径文件内容到内存中</span></span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.consumerOffsetManager.load();</span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.subscriptionGroupManager.load();</span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.consumerFilterManager.load();</span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123; <span class="comment">//消息存储管理组件，管理磁盘上的消息的。</span></span><br><span class="line">                <span class="keyword">this</span>.messageStore = <span class="keyword">new</span> DefaultMessageStore(<span class="keyword">this</span>.messageStoreConfig, <span class="keyword">this</span>.brokerStatsManager, <span class="keyword">this</span>.messageArrivingListener, <span class="keyword">this</span>.brokerConfig);</span><br><span class="line">                <span class="comment">//如果启用了Dledger，他就初始化一堆Dledger相关的组件</span></span><br><span class="line">                <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">                    DLedgerRoleChangeHandler roleChangeHandler = <span class="keyword">new</span> DLedgerRoleChangeHandler(<span class="keyword">this</span>, (DefaultMessageStore) messageStore);</span><br><span class="line">                    ((DLedgerCommitLog) ((DefaultMessageStore) messageStore).getCommitLog()).getdLedgerServer().getdLedgerLeaderElector().addRoleChangeHandler(roleChangeHandler);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//broker的统计组件</span></span><br><span class="line">                <span class="keyword">this</span>.brokerStats = <span class="keyword">new</span> BrokerStats((DefaultMessageStore) <span class="keyword">this</span>.messageStore);</span><br><span class="line">                <span class="comment">//load plugin 加载插件？</span></span><br><span class="line">                MessageStorePluginContext context = <span class="keyword">new</span> MessageStorePluginContext(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);</span><br><span class="line">                <span class="keyword">this</span>.messageStore = MessageStoreFactory.build(context, <span class="keyword">this</span>.messageStore);</span><br><span class="line">                <span class="keyword">this</span>.messageStore.getDispatcherList().addFirst(<span class="keyword">new</span> CommitLogDispatcherCalcBitMap(<span class="keyword">this</span>.brokerConfig, <span class="keyword">this</span>.consumerFilterManager));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                result = <span class="keyword">false</span>;</span><br><span class="line">                log.error(<span class="string">"Failed to initialize"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.messageStore.load(); <span class="comment">// Broker文件恢复</span></span><br><span class="line">        <span class="comment">//K2 Broker的Netty组件。注意，Broker需要既是服务端(接收Producer和Consumer的请求)，又是客户端(要往NameServer和Producer发送请求)。</span></span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            <span class="comment">//Netty网络组件</span></span><br><span class="line">            <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">            NettyServerConfig fastConfig = (NettyServerConfig) <span class="keyword">this</span>.nettyServerConfig.clone();</span><br><span class="line">            fastConfig.setListenPort(nettyServerConfig.getListenPort() - <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.fastRemotingServer = <span class="keyword">new</span> NettyRemotingServer(fastConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">            <span class="comment">//发送消息的处理线程池</span></span><br><span class="line">            <span class="keyword">this</span>.sendMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.sendThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"SendMessageThread_"</span>));</span><br><span class="line">            <span class="comment">//处理consumer的pull请求的线程池</span></span><br><span class="line">            <span class="keyword">this</span>.pullMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.pullThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"PullMessageThread_"</span>));</span><br><span class="line">            <span class="comment">//回复消息的线程池</span></span><br><span class="line">            <span class="keyword">this</span>.replyMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.replyThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ProcessReplyMessageThread_"</span>));</span><br><span class="line">            <span class="comment">//查询消息的线程池。</span></span><br><span class="line">            <span class="keyword">this</span>.queryMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.queryThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"QueryMessageThread_"</span>));</span><br><span class="line">            <span class="comment">//这个一看就是管理Broker的一些命令执行的线程池</span></span><br><span class="line">            <span class="keyword">this</span>.adminBrokerExecutor = Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getAdminBrokerThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"AdminBrokerThread_"</span>));</span><br><span class="line">            <span class="comment">//这个就是管理客户端的线程池</span></span><br><span class="line">            <span class="keyword">this</span>.clientManageExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.clientManagerThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ClientManageThread_"</span>));</span><br><span class="line">            <span class="comment">//心跳请求线程池</span></span><br><span class="line">            <span class="keyword">this</span>.heartbeatExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.heartbeatThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"HeartbeatThread_"</span>, <span class="keyword">true</span>));</span><br><span class="line">            <span class="comment">//事务消息结束线程池？一看就是跟事务消息有关。</span></span><br><span class="line">            <span class="keyword">this</span>.endTransactionExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.endTransactionThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"EndTransactionThread_"</span>));</span><br><span class="line">            <span class="comment">//管理consumer的线程池</span></span><br><span class="line">            <span class="keyword">this</span>.consumerManageExecutor = Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getConsumerManageThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ConsumerManageThread_"</span>));</span><br><span class="line">            <span class="comment">//注册各种处理器。用上了之前那一大堆的线程池。</span></span><br><span class="line">            <span class="keyword">this</span>.registerProcessor();</span><br><span class="line">            <span class="comment">//又是一些后台定时任务</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> initialDelay = UtilAll.computeNextMorningTimeMillis() - System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> period = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">            <span class="comment">//定时进行broker统计的任务</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.getBrokerStats().record();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="comment">//定时进行consumer消费offset持久化到磁盘的任务，10s后开始每5s执行一次</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.consumerOffsetManager.persist();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="comment">//对consumer的filter过滤器进行持久化的任务。这里可以看到，消费者的filter是被下推到了Broker来执行的。</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.consumerFilterManager.persist();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">"schedule persist consumer filter error."</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="comment">//定时进行broker保护</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.protectBroker();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line">            <span class="comment">//定时打印水位线</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.printWaterMark();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">10</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="comment">//定时进行落后commitlog分发的任务</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        log.info(<span class="string">"dispatch behind commit log &#123;&#125; bytes"</span>, BrokerController.<span class="keyword">this</span>.getMessageStore().dispatchBehindBytes());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="comment">//设置NameServer的地址列表。可以配置加载，也可以发远程请求加载。</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.getNamesrvAddr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            BrokerController.<span class="keyword">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//开启Dledger后的一些操作</span></span><br><span class="line">            <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="keyword">this</span>.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress() != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress().length() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.messageStore.updateHaMasterAddress(<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">                        <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">false</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                BrokerController.<span class="keyword">this</span>.printMasterAndSlaveDiff();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//跟安全文件相关的代码，先不管他。看清主线再说。</span></span><br><span class="line">            <span class="keyword">if</span> (TlsSystemConfig.tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">                <span class="comment">// Register a listener to reload SslContext</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fileWatchService = <span class="keyword">new</span> FileWatchService(</span><br><span class="line">                        <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                            TlsSystemConfig.tlsServerCertPath,</span><br><span class="line">                            TlsSystemConfig.tlsServerKeyPath,</span><br><span class="line">                            TlsSystemConfig.tlsServerTrustCertPath</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="keyword">new</span> FileWatchService.Listener() &#123;</span><br><span class="line">                            <span class="keyword">boolean</span> certChanged, keyChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerTrustCertPath)) &#123;</span><br><span class="line">                                    reloadServerSslContext();</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerCertPath)) &#123;</span><br><span class="line">                                    certChanged = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerKeyPath)) &#123;</span><br><span class="line">                                    keyChanged = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (certChanged &amp;&amp; keyChanged) &#123;</span><br><span class="line">                                    certChanged = keyChanged = <span class="keyword">false</span>;</span><br><span class="line">                                    reloadServerSslContext();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reloadServerSslContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                ((NettyRemotingServer) remotingServer).loadSslContext();</span><br><span class="line">                                ((NettyRemotingServer) fastRemotingServer).loadSslContext();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//这三行一看就是一些初始化的东西，暂时先不关注。</span></span><br><span class="line">            <span class="comment">//看完主线可以回头再来关注下，使用的SPI机制加载的服务，而SPI机制往往意味着可扩展。</span></span><br><span class="line">            initialTransaction();</span><br><span class="line">            initialAcl();</span><br><span class="line">            initialRpcHooks();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerProcessor</span><span class="params">()</span> </span>&#123; <span class="comment">// SendMessageProcessor</span></span><br><span class="line">        SendMessageProcessor sendProcessor = <span class="keyword">new</span> SendMessageProcessor(<span class="keyword">this</span>);</span><br><span class="line">        sendProcessor.registerSendMessageHook(sendMessageHookList);</span><br><span class="line">        sendProcessor.registerConsumeMessageHook(consumeMessageHookList);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">        <span class="comment">// PullMessageProcessor</span></span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.PULL_MESSAGE, <span class="keyword">this</span>.pullMessageProcessor, <span class="keyword">this</span>.pullMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.pullMessageProcessor.registerConsumeMessageHook(consumeMessageHookList);</span><br><span class="line">        <span class="comment">// ReplyMessageProcessor</span></span><br><span class="line">        ReplyMessageProcessor replyMessageProcessor = <span class="keyword">new</span> ReplyMessageProcessor(<span class="keyword">this</span>);</span><br><span class="line">        replyMessageProcessor.registerSendMessageHook(sendMessageHookList);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_REPLY_MESSAGE, replyMessageProcessor, replyMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_REPLY_MESSAGE_V2, replyMessageProcessor, replyMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_REPLY_MESSAGE, replyMessageProcessor, replyMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_REPLY_MESSAGE_V2, replyMessageProcessor, replyMessageExecutor);</span><br><span class="line">        <span class="comment">// QueryMessageProcessor</span></span><br><span class="line">        NettyRequestProcessor queryProcessor = <span class="keyword">new</span> QueryMessageProcessor(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.QUERY_MESSAGE, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.VIEW_MESSAGE_BY_ID, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.QUERY_MESSAGE, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.VIEW_MESSAGE_BY_ID, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">        <span class="comment">// ClientManageProcessor</span></span><br><span class="line">        ClientManageProcessor clientProcessor = <span class="keyword">new</span> ClientManageProcessor(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.HEART_BEAT, clientProcessor, <span class="keyword">this</span>.heartbeatExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.UNREGISTER_CLIENT, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.CHECK_CLIENT_CONFIG, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.HEART_BEAT, clientProcessor, <span class="keyword">this</span>.heartbeatExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.UNREGISTER_CLIENT, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.CHECK_CLIENT_CONFIG, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">        <span class="comment">// ConsumerManageProcessor</span></span><br><span class="line">        ConsumerManageProcessor consumerManageProcessor = <span class="keyword">new</span> ConsumerManageProcessor(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.GET_CONSUMER_LIST_BY_GROUP, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.UPDATE_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.QUERY_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.GET_CONSUMER_LIST_BY_GROUP, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.UPDATE_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.QUERY_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">        <span class="comment">// EndTransactionProcessor</span></span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.END_TRANSACTION, <span class="keyword">new</span> EndTransactionProcessor(<span class="keyword">this</span>), <span class="keyword">this</span>.endTransactionExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.END_TRANSACTION, <span class="keyword">new</span> EndTransactionProcessor(<span class="keyword">this</span>), <span class="keyword">this</span>.endTransactionExecutor);</span><br><span class="line">        <span class="comment">// Default</span></span><br><span class="line">        AdminBrokerProcessor adminProcessor = <span class="keyword">new</span> AdminBrokerProcessor(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerDefaultProcessor(adminProcessor, <span class="keyword">this</span>.adminBrokerExecutor);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.registerDefaultProcessor(adminProcessor, <span class="keyword">this</span>.adminBrokerExecutor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMessageStore</span> <span class="keyword">implements</span> <span class="title">MessageStore</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultMessageStore</span><span class="params">(<span class="keyword">final</span> MessageStoreConfig messageStoreConfig, <span class="keyword">final</span> BrokerStatsManager brokerStatsManager, <span class="keyword">final</span> MessageArrivingListener messageArrivingListener, <span class="keyword">final</span> BrokerConfig brokerConfig)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.messageArrivingListener = messageArrivingListener;</span><br><span class="line">        <span class="keyword">this</span>.brokerConfig = brokerConfig;</span><br><span class="line">        <span class="keyword">this</span>.messageStoreConfig = messageStoreConfig;</span><br><span class="line">        <span class="keyword">this</span>.brokerStatsManager = brokerStatsManager;</span><br><span class="line">        <span class="keyword">this</span>.allocateMappedFileService = <span class="keyword">new</span> AllocateMappedFileService(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.commitLog = <span class="keyword">new</span> DLedgerCommitLog(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.commitLog = <span class="keyword">new</span> CommitLog(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.consumeQueueTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.flushConsumeQueueService = <span class="keyword">new</span> FlushConsumeQueueService();</span><br><span class="line">        <span class="keyword">this</span>.cleanCommitLogService = <span class="keyword">new</span> CleanCommitLogService();</span><br><span class="line">        <span class="keyword">this</span>.cleanConsumeQueueService = <span class="keyword">new</span> CleanConsumeQueueService();</span><br><span class="line">        <span class="keyword">this</span>.storeStatsService = <span class="keyword">new</span> StoreStatsService();</span><br><span class="line">        <span class="keyword">this</span>.indexService = <span class="keyword">new</span> IndexService(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.haService = <span class="keyword">new</span> HAService(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.haService = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.reputMessageService = <span class="keyword">new</span> ReputMessageService();</span><br><span class="line">        <span class="keyword">this</span>.scheduleMessageService = <span class="keyword">new</span> ScheduleMessageService(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.transientStorePool = <span class="keyword">new</span> TransientStorePool(messageStoreConfig);</span><br><span class="line">        <span class="keyword">if</span> (messageStoreConfig.isTransientStorePoolEnable()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.transientStorePool.init();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.allocateMappedFileService.start();</span><br><span class="line">        <span class="keyword">this</span>.indexService.start();</span><br><span class="line">        <span class="keyword">this</span>.dispatcherList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.dispatcherList.addLast(<span class="keyword">new</span> CommitLogDispatcherBuildConsumeQueue());</span><br><span class="line">        <span class="keyword">this</span>.dispatcherList.addLast(<span class="keyword">new</span> CommitLogDispatcherBuildIndex());</span><br><span class="line">        File file = <span class="keyword">new</span> File(StorePathConfigHelper.getLockFile(messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">        MappedFile.ensureDirOK(file.getParent());</span><br><span class="line">        lockFile = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">"rw"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123; <span class="comment">// 根据abort临时文件判断服务是否正常关闭。abort文件不存在说明是正常关闭</span></span><br><span class="line">            <span class="keyword">boolean</span> lastExitOK = !<span class="keyword">this</span>.isTempFileExist();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != scheduleMessageService) &#123; <span class="comment">// 延迟消息：延迟消息处理服务加载。</span></span><br><span class="line">                result = result &amp;&amp; <span class="keyword">this</span>.scheduleMessageService.load();</span><br><span class="line">            &#125;</span><br><span class="line">            result = result &amp;&amp; <span class="keyword">this</span>.commitLog.load();<span class="comment">// load Commit Log</span></span><br><span class="line">            result = result &amp;&amp; <span class="keyword">this</span>.loadConsumeQueue();<span class="comment">// load Consume Queue</span></span><br><span class="line">            <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                <span class="keyword">this</span>.storeCheckpoint = <span class="keyword">new</span> StoreCheckpoint(StorePathConfigHelper.getStoreCheckpoint(<span class="keyword">this</span>.messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">                <span class="keyword">this</span>.indexService.load(lastExitOK);</span><br><span class="line">                <span class="keyword">this</span>.recover(lastExitOK);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            result = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            <span class="keyword">this</span>.allocateMappedFileService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>主从同步</strong>服务<strong><code>HAService</code></strong>是在<strong><code>DefaultMessageStore</code></strong>的构造方法中被初始化，在<strong><code>DefaultMessageStore</code></strong>的start中启动，这里并没有使用Netty而是直接使用的<strong><code>NIO</code></strong>，启动了主从同步的服务端口<strong><code>10912</code></strong>，这里的<strong><code>HAClient</code></strong>启动了，但是<strong>并没有真正连接到<code>Master Broker</code></strong>，而是等到注册成功后通过<strong><code>updateMasterAddress</code></strong>方法更新<strong><code>masterAddress</code></strong>后才会真正连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HAService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HAService</span><span class="params">(<span class="keyword">final</span> DefaultMessageStore defaultMessageStore)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultMessageStore = defaultMessageStore;</span><br><span class="line">        <span class="keyword">this</span>.acceptSocketService = <span class="keyword">new</span> AcceptSocketService(defaultMessageStore.getMessageStoreConfig().getHaListenPort());</span><br><span class="line">        <span class="keyword">this</span>.groupTransferService = <span class="keyword">new</span> GroupTransferService();</span><br><span class="line">        <span class="keyword">this</span>.haClient = <span class="keyword">new</span> HAClient();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.acceptSocketService.beginAccept();</span><br><span class="line">        <span class="keyword">this</span>.acceptSocketService.start();</span><br><span class="line">        <span class="keyword">this</span>.groupTransferService.start();</span><br><span class="line">        <span class="keyword">this</span>.haClient.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AcceptSocketService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SocketAddress socketAddressListen;</span><br><span class="line">        <span class="keyword">private</span> ServerSocketChannel serverSocketChannel;</span><br><span class="line">        <span class="keyword">private</span> Selector selector;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AcceptSocketService</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.socketAddressListen = <span class="keyword">new</span> InetSocketAddress(port);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginAccept</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">            <span class="keyword">this</span>.selector = RemotingUtil.openSelector();</span><br><span class="line">            <span class="keyword">this</span>.serverSocketChannel.socket().setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">this</span>.serverSocketChannel.socket().bind(<span class="keyword">this</span>.socketAddressListen); <span class="comment">// 这里的端口默认为10912</span></span><br><span class="line">            <span class="keyword">this</span>.serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">this</span>.serverSocketChannel.register(<span class="keyword">this</span>.selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.selector.select(<span class="number">1000</span>);</span><br><span class="line">                    Set&lt;SelectionKey&gt; selected = <span class="keyword">this</span>.selector.selectedKeys();</span><br><span class="line">                    <span class="keyword">if</span> (selected != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (SelectionKey k : selected) &#123;</span><br><span class="line">                            <span class="keyword">if</span> ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != <span class="number">0</span>) &#123;</span><br><span class="line">                                SocketChannel sc = ((ServerSocketChannel) k.channel()).accept();</span><br><span class="line">                                <span class="keyword">if</span> (sc != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">try</span> &#123;</span><br><span class="line">                                        HAConnection conn = <span class="keyword">new</span> HAConnection(HAService.<span class="keyword">this</span>, sc);</span><br><span class="line">                                        conn.start();</span><br><span class="line">                                        HAService.<span class="keyword">this</span>.addConnection(conn);</span><br><span class="line">                                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                        sc.close();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        selected.clear();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HAClient</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> SocketChannel socketChannel;</span><br><span class="line">        <span class="keyword">private</span> Selector selector;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HAClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.selector = RemotingUtil.openSelector();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.connectMaster()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.isTimeToReportOffset()) &#123;</span><br><span class="line">                            <span class="keyword">boolean</span> result = <span class="keyword">this</span>.reportSlaveMaxOffset(<span class="keyword">this</span>.currentReportedOffset);</span><br><span class="line">                            <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">                                <span class="keyword">this</span>.closeMaster();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">this</span>.selector.select(<span class="number">1000</span>);</span><br><span class="line">                        <span class="keyword">boolean</span> ok = <span class="keyword">this</span>.processReadEvent();</span><br><span class="line">                        <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.closeMaster();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!reportSlaveMaxOffsetPlus()) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">long</span> interval = HAService.<span class="keyword">this</span>.getDefaultMessageStore().getSystemClock().now() - <span class="keyword">this</span>.lastWriteTimestamp;</span><br><span class="line">                        <span class="keyword">if</span> (interval &gt; HAService.<span class="keyword">this</span>.getDefaultMessageStore().getMessageStoreConfig().getHaHousekeepingInterval()) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.closeMaster();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.waitForRunning(<span class="number">1000</span> * <span class="number">5</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.waitForRunning(<span class="number">1000</span> * <span class="number">5</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先加载磁盘中的数据，主要是加载topic、<strong>具体消费者组消费某topic的某个队列的offset</strong>、订阅组信息、消费者过滤信息、<strong>延迟消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String fileName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileName = <span class="keyword">this</span>.configFilePath(); <span class="comment">// 获取配置文件broker.conf中配置的路径</span></span><br><span class="line">            String jsonString = MixAll.file2String(fileName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == jsonString || jsonString.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.loadBak(); <span class="comment">// 若为空则加载.bak备份文件</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.decode(jsonString); <span class="comment">// 加载数据到内存中</span></span><br><span class="line">                log.info(<span class="string">"load "</span> + fileName + <span class="string">" OK"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.loadBak(); <span class="comment">// 若异常则加载.bak备份文件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadBak</span><span class="params">()</span> </span>&#123; <span class="comment">// 记载备份数据到内存中</span></span><br><span class="line">        String fileName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileName = <span class="keyword">this</span>.configFilePath();</span><br><span class="line">            String jsonString = MixAll.file2String(fileName + <span class="string">".bak"</span>);</span><br><span class="line">            <span class="keyword">if</span> (jsonString != <span class="keyword">null</span> &amp;&amp; jsonString.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.decode(jsonString);  <span class="comment">// 加载数据到内存中</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicConfigManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, TopicConfig&gt; topicConfigTable = <span class="keyword">new</span> ConcurrentHashMap&lt;String, TopicConfig&gt;(<span class="number">1024</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(String jsonString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            TopicConfigSerializeWrapper topicConfigSerializeWrapper = TopicConfigSerializeWrapper.fromJson(jsonString, TopicConfigSerializeWrapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (topicConfigSerializeWrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.topicConfigTable.putAll(topicConfigSerializeWrapper.getTopicConfigTable());</span><br><span class="line">                <span class="keyword">this</span>.dataVersion.assignNewOne(topicConfigSerializeWrapper.getDataVersion());</span><br><span class="line">                <span class="keyword">this</span>.printLoadDataWhenFirstBoot(topicConfigSerializeWrapper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerOffsetManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存具体的Topic的消费者组的消费进度</span></span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;String<span class="comment">/* topic@group */</span>, ConcurrentMap&lt;Integer, Long&gt;&gt; offsetTable = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ConcurrentMap&lt;Integer, Long&gt;&gt;(<span class="number">512</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(String jsonString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.offsetTable = obj.offsetTable;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscriptionGroupManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(String jsonString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SubscriptionGroupManager obj = RemotingSerializable.fromJson(jsonString, SubscriptionGroupManager<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.subscriptionGroupTable.putAll(obj.subscriptionGroupTable);</span><br><span class="line">                <span class="keyword">this</span>.dataVersion.assignNewOne(obj.dataVersion);</span><br><span class="line">                <span class="keyword">this</span>.printLoadDataWhenFirstBoot(obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 延迟消息服务，在DefaultMessageStore构造方法中被初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleMessageService</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Integer <span class="comment">/* level */</span>, Long<span class="comment">/* delay timeMillis */</span>&gt; delayLevelTable = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, Long&gt;(<span class="number">32</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Integer <span class="comment">/* level */</span>, Long<span class="comment">/* offset */</span>&gt; offsetTable = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, Long&gt;(<span class="number">32</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(String jsonString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            DelayOffsetSerializeWrapper delayOffsetSerializeWrapper = DelayOffsetSerializeWrapper.fromJson(jsonString, DelayOffsetSerializeWrapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (delayOffsetSerializeWrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.offsetTable.putAll(delayOffsetSerializeWrapper.getOffsetTable());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerFilterManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> String jsonString)</span> </span>&#123;</span><br><span class="line">        ConsumerFilterManager load = RemotingSerializable.fromJson(jsonString, ConsumerFilterManager<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (load != <span class="keyword">null</span> &amp;&amp; load.filterDataByTopic != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> bloomChanged = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (String topic : load.filterDataByTopic.keySet()) &#123;</span><br><span class="line">                FilterDataMapByTopic dataMapByTopic = load.filterDataByTopic.get(topic);</span><br><span class="line">                <span class="keyword">if</span> (dataMapByTopic == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (String group : dataMapByTopic.getGroupFilterData().keySet()) &#123;</span><br><span class="line">                    ConsumerFilterData filterData = dataMapByTopic.getGroupFilterData().get(group);</span><br><span class="line">                    <span class="keyword">if</span> (filterData == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        filterData.setCompiledExpression(</span><br><span class="line">                            FilterFactory.INSTANCE.get(filterData.getExpressionType()).compile(filterData.getExpression())</span><br><span class="line">                        );</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">                    <span class="comment">// check whether bloom filter is changed if changed, ignore the bit map calculated before.</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">this</span>.bloomFilter.isValid(filterData.getBloomFilterData())) &#123;</span><br><span class="line">                        bloomChanged = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    log.info(<span class="string">"load exist consumer filter data: &#123;&#125;"</span>, filterData);</span><br><span class="line">                    <span class="keyword">if</span> (filterData.getDeadTime() == <span class="number">0</span>) &#123; <span class="comment">// we think all consumers are dead when load</span></span><br><span class="line">                        <span class="keyword">long</span> deadTime = System.currentTimeMillis() - <span class="number">30</span> * <span class="number">1000</span>;</span><br><span class="line">                        filterData.setDeadTime(</span><br><span class="line">                            deadTime &lt;= filterData.getBornTime() ? filterData.getBornTime() : deadTime</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!bloomChanged) &#123;</span><br><span class="line">                <span class="keyword">this</span>.filterDataByTopic = load.filterDataByTopic;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用BrokerController的start方法来启动一些列服务，首先启动<strong>消息存储的核心功能组件<code>DefaultMessageStore</code></strong>：</p>
<ul>
<li>启动<strong><code>commitLog</code></strong>消息分发服务<strong><code>ReputMessageService</code></strong>，根据<strong><code>CommitLog</code></strong>文件来构建<strong><code>ConsumeQueue</code></strong>和<strong><code>indexFile</code></strong>文件</li>
<li>若是<strong>非<code>DLeger</code>模式</strong>启动，则启动<strong>主从同步</strong>服务<strong><code>HAService</code></strong>，若是<strong>从节点</strong>停掉<strong>延迟消息</strong>服务<strong><code>ScheduleMessageService</code></strong>，<strong>主节点</strong>则<strong>启动</strong></li>
<li>启动消息队列文件刷盘线程<strong><code>FlushConsumeQueueService</code></strong>，<strong>1秒</strong>执行一次，且超过<strong><code>60s</code></strong>刷一次<strong><code>Checkpoint</code></strong></li>
<li>通过<strong><code>CommitLog</code></strong>的<strong><code>start</code></strong>方法，启动<strong><code>FlushCommitLogService</code></strong>，注意这里分为<strong><code>GroupCommitService</code>同步刷盘</strong>和<strong><code>FlushRealTimeService</code>异步刷盘<code>500ms</code></strong>执行一次</li>
<li>启动往<strong><code>commitLog</code></strong>中<strong><code>put</code></strong>数据<strong>耗时统计</strong>服务<strong><code>StoreStatsService</code></strong>线程</li>
<li>通过<strong><code>addScheduleTask</code></strong>方法添加<strong>周期</strong>任务每<strong><code>10s</code></strong>清理一次过期的<strong><code>commitLog</code></strong>文件和<strong><code>ConsumeQueue</code></strong>文件</li>
</ul>
<p>然后启动两个<strong><code>NettyRemotingServer</code></strong>服务<strong><code>remotingServer</code></strong>和<strong><code>fastRemotingServer</code></strong>，用于接收消费者和生产者的请求，在NameServer中同样是通过<strong><code>NettyRemotingServer</code></strong>类启动的<strong><code>remotingServer</code></strong>只不过使用的<strong>端口</strong>默认是<strong><code>9876</code></strong>，而在Broker中<strong><code>remotingServer</code></strong>和<strong><code>fastRemotingServer</code></strong>使用的端口默认分别为<strong><code>10911</code></strong>和<strong><code>10909</code></strong>，是通过<strong><code>localAddress</code></strong>方法绑定的服务端<strong>监听端口</strong>，以及<strong>主从同步端口<code>10912</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.messageStore != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.messageStore.start(); <span class="comment">// 启动核心的消息存储组件</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.remotingServer != <span class="keyword">null</span>) &#123; <span class="comment">// Broker中启动了两个Netty服务，这样就可以接收请求了。</span></span><br><span class="line">            <span class="keyword">this</span>.remotingServer.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fastRemotingServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fastRemotingServer.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fileWatchService != <span class="keyword">null</span>) &#123; <span class="comment">//跟文件相关的一个服务组件，暂不关注</span></span><br><span class="line">            <span class="keyword">this</span>.fileWatchService.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.brokerOuterAPI != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.brokerOuterAPI.start();<span class="comment">// Broker的brokerOuterAPI可以理解为一个Netty客户端。往外发送请求的，例如心跳。</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//下面这几个都是实现功能的核心组件，暂时不用深究。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.pullRequestHoldService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pullRequestHoldService.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.clientHousekeepingService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.clientHousekeepingService.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.filterServerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.filterServerManager.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">            startProcessorByHa(messageStoreConfig.getBrokerRole()); <span class="comment">// 开始事务消息检查</span></span><br><span class="line">            handleSlaveSynchronize(messageStoreConfig.getBrokerRole());</span><br><span class="line">            <span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Broker核心的心跳注册任务。该任务间隔时间默认是30秒</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, brokerConfig.isForceRegister());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"registerBrokerAll Exception"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, Math.max(<span class="number">10000</span>, Math.min(brokerConfig.getRegisterNameServerPeriod(), <span class="number">60000</span>)), TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.brokerStatsManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.brokerStatsManager.start();<span class="comment">// 也是启动一些功能组件，但这里什么也没做</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.brokerFastFailure != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.brokerFastFailure.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMessageStore</span> <span class="keyword">implements</span> <span class="title">MessageStore</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        lock = lockFile.getChannel().tryLock(<span class="number">0</span>, <span class="number">1</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (lock == <span class="keyword">null</span> || lock.isShared() || !lock.isValid()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Lock failed,MQ already started"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        lockFile.getChannel().write(ByteBuffer.wrap(<span class="string">"lock"</span>.getBytes()));</span><br><span class="line">        lockFile.getChannel().force(<span class="keyword">true</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 1. Make sure the fast-forward messages to be truncated during the recovering according to the max physical offset of the commitlog;</span></span><br><span class="line"><span class="comment">             * 2. DLedger committedPos may be missing, so the maxPhysicalPosInLogicQueue maybe bigger that maxOffset returned by DLedgerCommitLog, just let it go;</span></span><br><span class="line"><span class="comment">             * 3. Calculate the reput offset according to the consume queue;</span></span><br><span class="line"><span class="comment">             * 4. Make sure the fall-behind messages to be dispatched before starting the commitlog, especially when the broker role are automatically changed.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">long</span> maxPhysicalPosInLogicQueue = commitLog.getMinOffset();</span><br><span class="line">            <span class="keyword">for</span> (ConcurrentMap&lt;Integer, ConsumeQueue&gt; maps : <span class="keyword">this</span>.consumeQueueTable.values()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (ConsumeQueue logic : maps.values()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (logic.getMaxPhysicOffset() &gt; maxPhysicalPosInLogicQueue) &#123;</span><br><span class="line">                        maxPhysicalPosInLogicQueue = logic.getMaxPhysicOffset();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (maxPhysicalPosInLogicQueue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                maxPhysicalPosInLogicQueue = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (maxPhysicalPosInLogicQueue &lt; <span class="keyword">this</span>.commitLog.getMinOffset()) &#123;</span><br><span class="line">                maxPhysicalPosInLogicQueue = <span class="keyword">this</span>.commitLog.getMinOffset();</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * This happens in following conditions:</span></span><br><span class="line"><span class="comment">                 * 1. If someone removes all the consumequeue files or the disk get damaged.</span></span><br><span class="line"><span class="comment">                 * 2. Launch a new broker, and copy the commitlog from other brokers.</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * All the conditions has the same in common that the maxPhysicalPosInLogicQueue should be 0.</span></span><br><span class="line"><span class="comment">                 * If the maxPhysicalPosInLogicQueue is gt 0, there maybe something wrong.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//K2 Broker启动时会启动一个线程来更新ConsumerQueue索引文件。</span></span><br><span class="line">            <span class="keyword">this</span>.reputMessageService.setReputFromOffset(maxPhysicalPosInLogicQueue);</span><br><span class="line">            <span class="keyword">this</span>.reputMessageService.start();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *  1. Finish dispatching the messages fall behind, then to start other services.</span></span><br><span class="line"><span class="comment">             *  2. DLedger committedPos may be missing, so here just require dispatchBehindBytes &lt;= 0</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dispatchBehindBytes() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.recoverTopicQueueTable();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.haService.start();</span><br><span class="line">            <span class="keyword">this</span>.handleScheduleMessageService(messageStoreConfig.getBrokerRole());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.flushConsumeQueueService.start();<span class="comment">// 消息队列文件刷盘线程，1秒执行一次</span></span><br><span class="line">        <span class="keyword">this</span>.commitLog.start(); <span class="comment">//  开启FlushCommitLogService刷盘线程</span></span><br><span class="line">        <span class="keyword">this</span>.storeStatsService.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.createTempFile();</span><br><span class="line">        <span class="comment">//K2 Broker启动删除过期文件的定时任务</span></span><br><span class="line">        <span class="keyword">this</span>.addScheduleTask();</span><br><span class="line">        <span class="keyword">this</span>.shutdown = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlushConsumeQueueService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_TIMES_OVER = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastFlushTimestamp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFlush</span><span class="params">(<span class="keyword">int</span> retryTimes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> flushConsumeQueueLeastPages = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueLeastPages();</span><br><span class="line">        <span class="keyword">if</span> (retryTimes == RETRY_TIMES_OVER) &#123;</span><br><span class="line">            flushConsumeQueueLeastPages = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> logicsMsgTimestamp = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// flushConsumeQueueThoroughInterval默认60s</span></span><br><span class="line">        <span class="keyword">int</span> flushConsumeQueueThoroughInterval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();</span><br><span class="line">        <span class="keyword">long</span> currentTimeMillis = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (currentTimeMillis &gt;= (<span class="keyword">this</span>.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.lastFlushTimestamp = currentTimeMillis;</span><br><span class="line">            flushConsumeQueueLeastPages = <span class="number">0</span>;</span><br><span class="line">            logicsMsgTimestamp = DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().getLogicsMsgTimestamp();</span><br><span class="line">        &#125;</span><br><span class="line">        ConcurrentMap&lt;String, ConcurrentMap&lt;Integer, ConsumeQueue&gt;&gt; tables = DefaultMessageStore.<span class="keyword">this</span>.consumeQueueTable;</span><br><span class="line">        <span class="keyword">for</span> (ConcurrentMap&lt;Integer, ConsumeQueue&gt; maps : tables.values()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ConsumeQueue cq : maps.values()) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; retryTimes &amp;&amp; !result; i++) &#123;</span><br><span class="line">                    result = cq.flush(flushConsumeQueueLeastPages);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == flushConsumeQueueLeastPages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logicsMsgTimestamp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">            DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// 1s执行一次</span></span><br><span class="line">        DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> interval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushIntervalConsumeQueue();</span><br><span class="line">                <span class="keyword">this</span>.waitForRunning(interval);</span><br><span class="line">                <span class="keyword">this</span>.doFlush(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.doFlush(RETRY_TIMES_OVER);</span><br><span class="line">        DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommitLog</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flushCommitLogService.start();</span><br><span class="line">        <span class="keyword">if</span> (defaultMessageStore.getMessageStoreConfig().isTransientStorePoolEnable()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.commitLogService.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<strong><code>BrokerOuterAPI</code></strong>启动持有<strong><code>NettyClientConfig</code></strong>配置的<strong><code>NettyRemotingClient</code></strong>线程来管理<strong><code>Broker</code></strong>与<strong><code>NameServer</code></strong>的<strong><code>Netty</code>客户端</strong>，这里使用的服务端地址是通过<strong><code>BrokerController</code></strong>的<strong><code>initialize</code></strong>方法中通过调用<strong><code>BrokerOuterAPI</code></strong>的<strong><code>updateNameServerAddressList</code></strong>方法设置到<strong><code>NettyRemotingClient</code></strong>的<strong><code>namesrvAddrList</code></strong>和<strong><code>namesrvAddrChoosed</code></strong>中的，但是这里调用<strong><code>BrokerOuterAPI</code></strong>的<strong><code>start</code></strong>方法只是设置了<strong><code>Netty</code>客户端<code>Bootstrap</code></strong>的一些参数，并<strong>没有开启客户端与服务端的连</strong>，客户端和服务端的连接是在调用<strong><code>invokeSync</code></strong>、<strong><code>invokeAsync</code></strong>、<strong><code>invokeOneway</code></strong>等方法时通过<strong><code>NettyRemotingClient</code></strong>的<strong><code>createChannel</code></strong>方法来完成的。<strong><code>createChannel</code></strong>方法不仅用于<strong><code>Broker</code></strong>客户端与<strong><code>NameServer</code></strong>服务端建立连接，也用于<strong>Slave从节点</strong>客户端与<strong>主节点</strong>建立连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="comment">//设置NameServer的地址列表。可以配置加载，也可以发远程请求加载。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.getNamesrvAddr() != <span class="keyword">null</span>) &#123; <span class="comment">// 将NamesrvAddr设置到NettyRemotingClient的namesrvAddrList和namesrvAddrChoosed中保存</span></span><br><span class="line">            <span class="keyword">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// 每120秒拉取一下最新的NameServer地址</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerOuterAPI</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RemotingClient remotingClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TopAddressing topAddressing = <span class="keyword">new</span> TopAddressing(MixAll.getWSAddr());</span><br><span class="line">    <span class="keyword">private</span> String nameSrvAddr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TopAddressing topAddressing = <span class="keyword">new</span> TopAddressing(MixAll.getWSAddr());</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BrokerOuterAPI</span><span class="params">(<span class="keyword">final</span> NettyClientConfig nettyClientConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(nettyClientConfig, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BrokerOuterAPI</span><span class="params">(<span class="keyword">final</span> NettyClientConfig nettyClientConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(nettyClientConfig, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BrokerOuterAPI</span><span class="params">(<span class="keyword">final</span> NettyClientConfig nettyClientConfig, RPCHook rpcHook)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.remotingClient = <span class="keyword">new</span> NettyRemotingClient(nettyClientConfig);</span><br><span class="line">        <span class="keyword">this</span>.remotingClient.registerRPCHook(rpcHook);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123; <span class="comment">// 启动NettyRemotingClient</span></span><br><span class="line">        <span class="keyword">this</span>.remotingClient.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fetchNameServerAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String addrs = <span class="keyword">this</span>.topAddressing.fetchNSAddr();</span><br><span class="line">            <span class="keyword">if</span> (addrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!addrs.equals(<span class="keyword">this</span>.nameSrvAddr)) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.updateNameServerAddressList(addrs);</span><br><span class="line">                    <span class="keyword">this</span>.nameSrvAddr = addrs;</span><br><span class="line">                    <span class="keyword">return</span> nameSrvAddr;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> nameSrvAddr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNameServerAddressList</span><span class="params">(<span class="keyword">final</span> String addrs)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; lst = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        String[] addrArray = addrs.split(<span class="string">";"</span>);</span><br><span class="line">        <span class="keyword">for</span> (String addr : addrArray) &#123;</span><br><span class="line">            lst.add(addr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.remotingClient.updateNameServerAddressList(lst);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyRemotingClient</span> <span class="keyword">extends</span> <span class="title">NettyRemotingAbstract</span> <span class="keyword">implements</span> <span class="title">RemotingClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NettyClientConfig nettyClientConfig;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String <span class="comment">/* addr */</span>, ChannelWrapper&gt; channelTables = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ChannelWrapper&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;List&lt;String&gt;&gt; namesrvAddrList = <span class="keyword">new</span> AtomicReference&lt;List&lt;String&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String&gt; namesrvAddrChoosed = <span class="keyword">new</span> AtomicReference&lt;String&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultEventExecutorGroup = <span class="keyword">new</span> DefaultEventExecutorGroup(</span><br><span class="line">            nettyClientConfig.getClientWorkerThreads(),</span><br><span class="line">            <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                <span class="keyword">private</span> AtomicInteger threadIndex = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"NettyClientWorkerThread_"</span> + <span class="keyword">this</span>.threadIndex.incrementAndGet());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        Bootstrap handler = <span class="keyword">this</span>.bootstrap.group(<span class="keyword">this</span>.eventLoopGroupWorker).channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">TCP_NODELAY</span>, <span class="title">true</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_KEEPALIVE</span>, <span class="title">false</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">CONNECT_TIMEOUT_MILLIS</span>, <span class="title">nettyClientConfig</span>.<span class="title">getConnectTimeoutMillis</span>())</span></span><br><span class="line"><span class="class">            .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_SNDBUF</span>, <span class="title">nettyClientConfig</span>.<span class="title">getClientSocketSndBufSize</span>())</span></span><br><span class="line"><span class="class">            .<span class="title">option</span>(<span class="title">ChannelOption</span>.<span class="title">SO_RCVBUF</span>, <span class="title">nettyClientConfig</span>.<span class="title">getClientSocketRcvBufSize</span>())</span></span><br><span class="line"><span class="class">            .<span class="title">handler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                    <span class="keyword">if</span> (nettyClientConfig.isUseTLS()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">null</span> != sslContext) &#123;</span><br><span class="line">                            pipeline.addFirst(defaultEventExecutorGroup, <span class="string">"sslHandler"</span>, sslContext.newHandler(ch.alloc()));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    pipeline.addLast(defaultEventExecutorGroup, <span class="keyword">new</span> NettyEncoder(), <span class="keyword">new</span> NettyDecoder(),</span><br><span class="line">                                     <span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">0</span>,  nettyClientConfig.getClientChannelMaxIdleTimeSeconds()),</span><br><span class="line">                                     <span class="keyword">new</span> NettyConnectManageHandler(), <span class="keyword">new</span> NettyClientHandler());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">this</span>.timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    NettyRemotingClient.<span class="keyword">this</span>.scanResponseTable();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">3</span>, <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.channelEventListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nettyEventExecutor.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNameServerAddressList</span><span class="params">(List&lt;String&gt; addrs)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; old = <span class="keyword">this</span>.namesrvAddrList.get();</span><br><span class="line">        <span class="keyword">boolean</span> update = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!addrs.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == old) &#123;</span><br><span class="line">                update = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (addrs.size() != old.size()) &#123;</span><br><span class="line">                update = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; addrs.size() &amp;&amp; !update; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!old.contains(addrs.get(i))) &#123;</span><br><span class="line">                        update = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (update) &#123;</span><br><span class="line">                Collections.shuffle(addrs);</span><br><span class="line">                <span class="keyword">this</span>.namesrvAddrList.set(addrs);</span><br><span class="line">                <span class="keyword">if</span> (!addrs.contains(<span class="keyword">this</span>.namesrvAddrChoosed.get())) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.namesrvAddrChoosed.set(<span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Channel <span class="title">createChannel</span><span class="params">(<span class="keyword">final</span> String addr)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">        <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</span><br><span class="line">            <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这一堆也是从缓存中获取channel</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lockChannelTables.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">boolean</span> createNewConnection;</span><br><span class="line">                cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">                <span class="keyword">if</span> (cw != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cw.isOK()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!cw.getChannelFuture().isDone()) &#123;</span><br><span class="line">                        createNewConnection = <span class="keyword">false</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.channelTables.remove(addr);</span><br><span class="line">                        createNewConnection = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    createNewConnection = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (createNewConnection) &#123; <span class="comment">// Broker真正构建与Nameserver的channel的地方</span></span><br><span class="line">                    ChannelFuture channelFuture = <span class="keyword">this</span>.bootstrap.connect(RemotingHelper.string2SocketAddress(addr));</span><br><span class="line">                    cw = <span class="keyword">new</span> ChannelWrapper(channelFuture);</span><br><span class="line">                    <span class="keyword">this</span>.channelTables.put(addr, cw);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.lockChannelTables.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//把创建的channel缓存起来。</span></span><br><span class="line">        <span class="keyword">if</span> (cw != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ChannelFuture channelFuture = cw.getChannelFuture();</span><br><span class="line">            <span class="keyword">if</span> (channelFuture.awaitUninterruptibly(<span class="keyword">this</span>.nettyClientConfig.getConnectTimeoutMillis())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cw.isOK()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Channel <span class="title">getAndCreateChannel</span><span class="params">(<span class="keyword">final</span> String addr)</span> <span class="keyword">throws</span> RemotingConnectException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == addr) &#123;</span><br><span class="line">            <span class="keyword">return</span> getAndCreateNameserverChannel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这里看出，所有的channel是有本地缓存的。</span></span><br><span class="line">        ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">        <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</span><br><span class="line">            <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.createChannel(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Channel <span class="title">getAndCreateNameserverChannel</span><span class="params">()</span> <span class="keyword">throws</span> RemotingConnectException, InterruptedException </span>&#123;</span><br><span class="line">        String addr = <span class="keyword">this</span>.namesrvAddrChoosed.get();</span><br><span class="line">        <span class="keyword">if</span> (addr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">            <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</span><br><span class="line">                <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> List&lt;String&gt; addrList = <span class="keyword">this</span>.namesrvAddrList.get();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lockNamesrvChannel.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                addr = <span class="keyword">this</span>.namesrvAddrChoosed.get();</span><br><span class="line">                <span class="keyword">if</span> (addr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">                    <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (addrList != <span class="keyword">null</span> &amp;&amp; !addrList.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; addrList.size(); i++) &#123;</span><br><span class="line">                        <span class="keyword">int</span> index = <span class="keyword">this</span>.namesrvIndex.incrementAndGet();</span><br><span class="line">                        index = Math.abs(index);</span><br><span class="line">                        index = index % addrList.size();</span><br><span class="line">                        String newAddr = addrList.get(index);</span><br><span class="line">                        <span class="keyword">this</span>.namesrvAddrChoosed.set(newAddr);</span><br><span class="line">                        Channel channelNew = <span class="keyword">this</span>.createChannel(newAddr);</span><br><span class="line">                        <span class="keyword">if</span> (channelNew != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> channelNew;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingConnectException(addrList.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.lockNamesrvChannel.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后调用<strong><code>PullRequestHoldService</code></strong>的<strong><code>start</code></strong>方法，启动消息拉取长连接的处理，其实就是<strong>消息推送</strong>的底层实现，每5s通过拉取Offset与目前消息队列的最大Offset比较检查是否有新消息，若有则响应给<strong><code>Consumer</code></strong>客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullRequestHoldService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</span><br><span class="line">    <span class="comment">//请求放入队列，等待线程唤醒后处理。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspendPullRequest</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">        String key = <span class="keyword">this</span>.buildKey(topic, queueId);</span><br><span class="line">        ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mpr) &#123;</span><br><span class="line">            mpr = <span class="keyword">new</span> ManyPullRequest();</span><br><span class="line">            ManyPullRequest prev = <span class="keyword">this</span>.pullRequestTable.putIfAbsent(key, mpr);</span><br><span class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mpr = prev;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mpr.addPullRequest(pullRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// 处理ManyPullRequest线程</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;<span class="comment">// 如果开启了长轮询，等待5秒后再去查</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.waitForRunning(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">// 没有开启长轮询，等待1秒后再去查。</span></span><br><span class="line">                    <span class="keyword">this</span>.waitForRunning(<span class="keyword">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">long</span> beginLockTimestamp = <span class="keyword">this</span>.systemClock.now();</span><br><span class="line">                <span class="keyword">this</span>.checkHoldRequest();<span class="comment">// 检查请求对象</span></span><br><span class="line">                <span class="keyword">long</span> costTime = <span class="keyword">this</span>.systemClock.now() - beginLockTimestamp;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">//请求放入队列，等待线程唤醒后处理。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspendPullRequest</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">        String key = <span class="keyword">this</span>.buildKey(topic, queueId);</span><br><span class="line">        ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mpr) &#123;</span><br><span class="line">            mpr = <span class="keyword">new</span> ManyPullRequest();</span><br><span class="line">            ManyPullRequest prev = <span class="keyword">this</span>.pullRequestTable.putIfAbsent(key, mpr);</span><br><span class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mpr = prev;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mpr.addPullRequest(pullRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkHoldRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String key : <span class="keyword">this</span>.pullRequestTable.keySet()) &#123;</span><br><span class="line">            String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">2</span> == kArray.length) &#123;</span><br><span class="line">                String topic = kArray[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">int</span> queueId = Integer.parseInt(kArray[<span class="number">1</span>]);</span><br><span class="line">                <span class="comment">//从CommitLog中检查是否有新的消息。</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQueue(topic, queueId);</span><br><span class="line">                <span class="keyword">try</span> &#123;<span class="comment">//通知消息到达</span></span><br><span class="line">                    <span class="keyword">this</span>.notifyMessageArriving(topic, queueId, offset);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset)</span> </span>&#123;</span><br><span class="line">        notifyMessageArriving(topic, queueId, maxOffset, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset, <span class="keyword">final</span> Long tagsCode, <span class="keyword">long</span> msgStoreTime, <span class="keyword">byte</span>[] filterBitMap, Map&lt;String, String&gt; properties)</span> </span>&#123;</span><br><span class="line">        String key = <span class="keyword">this</span>.buildKey(topic, queueId);</span><br><span class="line">        ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</span><br><span class="line">        <span class="keyword">if</span> (mpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            List&lt;PullRequest&gt; requestList = mpr.cloneListAndClear();</span><br><span class="line">            <span class="keyword">if</span> (requestList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                List&lt;PullRequest&gt; replayList = <span class="keyword">new</span> ArrayList&lt;PullRequest&gt;();</span><br><span class="line">                <span class="keyword">for</span> (PullRequest request : requestList) &#123;</span><br><span class="line">                    <span class="keyword">long</span> newestOffset = maxOffset;</span><br><span class="line">                    <span class="keyword">if</span> (newestOffset &lt;= request.getPullFromThisOffset()) &#123;</span><br><span class="line">                        newestOffset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQueue(topic, queueId);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (newestOffset &gt; request.getPullFromThisOffset()) &#123;<span class="comment">//判断是否有新的消息</span></span><br><span class="line">                        <span class="comment">// 检查新的消息是否是ConsumeQueue感兴趣的消息</span></span><br><span class="line">                        <span class="keyword">boolean</span> match = request.getMessageFilter().isMatchedByConsumeQueue(tagsCode, <span class="keyword">new</span> ConsumeQueueExt.CqExtUnit(tagsCode, msgStoreTime, filterBitMap));</span><br><span class="line">                        <span class="comment">// match by bit map, need eval again when properties is not null.</span></span><br><span class="line">                        <span class="keyword">if</span> (match &amp;&amp; properties != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            match = request.getMessageFilter().isMatchedByCommitLog(<span class="keyword">null</span>, properties);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (match) &#123; <span class="comment">//如果是感兴趣的消息，就等待线程唤醒后执行消息推送。</span></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(), request.getRequestCommand());</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//请求超时后也给客户端响应。</span></span><br><span class="line">                    <span class="keyword">if</span> (System.currentTimeMillis() &gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(), request.getRequestCommand());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    replayList.add(request);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!replayList.isEmpty()) &#123;</span><br><span class="line">                    mpr.addPullRequest(replayList);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过启动<strong><code>ClientHousekeepingService</code></strong>来定期清理<strong><code>Producer</code></strong>和<strong><code>Consumer</code></strong>中不再存活的对象，通过检查最后心跳时间是否超过<strong><code>120s</code></strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHousekeepingService</span> <span class="keyword">implements</span> <span class="title">ChannelEventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ClientHousekeepingService.<span class="keyword">this</span>.scanExceptionChannel();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanExceptionChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerController.getProducerManager().scanNotActiveChannel();</span><br><span class="line">        <span class="keyword">this</span>.brokerController.getConsumerManager().scanNotActiveChannel();</span><br><span class="line">        <span class="keyword">this</span>.brokerController.getFilterServerManager().scanNotActiveChannel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CHANNEL_EXPIRED_TIMEOUT = <span class="number">1000</span> * <span class="number">120</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GET_AVALIABLE_CHANNEL_RETRY_COUNT = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String <span class="comment">/* group name */</span>, ConcurrentHashMap&lt;Channel, ClientChannelInfo&gt;&gt; groupChannelTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Channel&gt; clientChannelTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanNotActiveChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, ConcurrentHashMap&lt;Channel, ClientChannelInfo&gt;&gt; entry : <span class="keyword">this</span>.groupChannelTable.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String group = entry.getKey();</span><br><span class="line">            <span class="keyword">final</span> ConcurrentHashMap&lt;Channel, ClientChannelInfo&gt; chlMap = entry.getValue();</span><br><span class="line">            Iterator&lt;Entry&lt;Channel, ClientChannelInfo&gt;&gt; it = chlMap.entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                Entry&lt;Channel, ClientChannelInfo&gt; item = it.next();</span><br><span class="line">                <span class="keyword">final</span> ClientChannelInfo info = item.getValue();</span><br><span class="line">                <span class="keyword">long</span> diff = System.currentTimeMillis() - info.getLastUpdateTimestamp();</span><br><span class="line">                <span class="keyword">if</span> (diff &gt; CHANNEL_EXPIRED_TIMEOUT) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                    clientChannelTable.remove(info.getClientId());  <span class="comment">// 移除缓存</span></span><br><span class="line">                    RemotingUtil.closeChannel(info.getChannel()); <span class="comment">// 关闭连接</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CHANNEL_EXPIRED_TIMEOUT = <span class="number">1000</span> * <span class="number">120</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String<span class="comment">/* Group */</span>, ConsumerGroupInfo&gt; consumerTable = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ConsumerGroupInfo&gt;(<span class="number">1024</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanNotActiveChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;Entry&lt;String, ConsumerGroupInfo&gt;&gt; it = <span class="keyword">this</span>.consumerTable.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            Entry&lt;String, ConsumerGroupInfo&gt; next = it.next();</span><br><span class="line">            String group = next.getKey();</span><br><span class="line">            ConsumerGroupInfo consumerGroupInfo = next.getValue();</span><br><span class="line">            ConcurrentMap&lt;Channel, ClientChannelInfo&gt; channelInfoTable = consumerGroupInfo.getChannelInfoTable();</span><br><span class="line">            Iterator&lt;Entry&lt;Channel, ClientChannelInfo&gt;&gt; itChannel = channelInfoTable.entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (itChannel.hasNext()) &#123;</span><br><span class="line">                Entry&lt;Channel, ClientChannelInfo&gt; nextChannel = itChannel.next();</span><br><span class="line">                ClientChannelInfo clientChannelInfo = nextChannel.getValue();</span><br><span class="line">                <span class="keyword">long</span> diff = System.currentTimeMillis() - clientChannelInfo.getLastUpdateTimestamp();</span><br><span class="line">                <span class="keyword">if</span> (diff &gt; CHANNEL_EXPIRED_TIMEOUT) &#123;</span><br><span class="line">                    RemotingUtil.closeChannel(clientChannelInfo.getChannel()); <span class="comment">// 关闭连接</span></span><br><span class="line">                    itChannel.remove(); <span class="comment">// 移除缓存</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (channelInfoTable.isEmpty()) &#123;</span><br><span class="line">                it.remove(); <span class="comment">// 移除缓存</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若<strong>没有开启<code>DLeger</code></strong>，则通过<strong><code>startProcessorByHa</code></strong>方法首先判断，若为<strong>主节点</strong>则<strong>开启事务消息回查检查</strong>，<strong><code>60s</code></strong>回查一次；然后通过<strong><code>handleSlaveSynchronize</code></strong>方法判断若是<strong>从节点</strong>，则开启一个周期任务每<strong><code>10s</code></strong>执行一次<strong><code>SlaveSynchronize</code></strong>的<strong><code>syncAll</code></strong>方法，进行一次主从数据同步，若为主节点若周期任务不为null这关闭主从同步周期任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">            startProcessorByHa(messageStoreConfig.getBrokerRole()); <span class="comment">// 开始事务消息检查</span></span><br><span class="line">            handleSlaveSynchronize(messageStoreConfig.getBrokerRole());</span><br><span class="line">            <span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startProcessorByHa</span><span class="params">(BrokerRole role)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (BrokerRole.SLAVE != role) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.transactionalMessageCheckService != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.transactionalMessageCheckService.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleSlaveSynchronize</span><span class="params">(BrokerRole role)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (role == BrokerRole.SLAVE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != slaveSyncFuture) &#123;</span><br><span class="line">                slaveSyncFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.slaveSynchronize.setMasterAddr(<span class="keyword">null</span>);</span><br><span class="line">            slaveSyncFuture = <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.slaveSynchronize.syncAll();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">3</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// handle the slave synchronise</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != slaveSyncFuture) &#123;</span><br><span class="line">                slaveSyncFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.slaveSynchronize.setMasterAddr(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalMessageCheckService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> checkInterval = brokerController.getBrokerConfig().getTransactionCheckInterval(); <span class="comment">// 默认60s</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.waitForRunning(checkInterval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onWaitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> timeout = brokerController.getBrokerConfig().getTransactionTimeOut(); <span class="comment">// 获取超时时间6s</span></span><br><span class="line">        <span class="keyword">int</span> checkMax = brokerController.getBrokerConfig().getTransactionCheckMax();  <span class="comment">// 获取最大回查次数15</span></span><br><span class="line">        <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.brokerController.getTransactionalMessageService().check(timeout, checkMax, <span class="keyword">this</span>.brokerController.getTransactionalMessageCheckListener());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalMessageServiceImpl</span> <span class="keyword">implements</span> <span class="title">TransactionalMessageService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(<span class="keyword">long</span> transactionTimeout, <span class="keyword">int</span> transactionCheckMax, AbstractTransactionalMessageCheckListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String topic = TopicValidator.RMQ_SYS_TRANS_HALF_TOPIC; <span class="comment">// RMQ_SYS_TRANS_HALF_TOPIC</span></span><br><span class="line">            Set&lt;MessageQueue&gt; msgQueues = transactionalMessageBridge.fetchMessageQueues(topic);</span><br><span class="line">            <span class="keyword">if</span> (msgQueues == <span class="keyword">null</span> || msgQueues.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (MessageQueue messageQueue : msgQueues) &#123;</span><br><span class="line">                <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">                MessageQueue opQueue = getOpQueue(messageQueue); <span class="comment">// 获取RMQ_SYS_TRANS_OP_HALF_TOPIC事务完成队列</span></span><br><span class="line">                <span class="keyword">long</span> halfOffset = transactionalMessageBridge.fetchConsumeOffset(messageQueue);</span><br><span class="line">                <span class="keyword">long</span> opOffset = transactionalMessageBridge.fetchConsumeOffset(opQueue);</span><br><span class="line">                <span class="keyword">if</span> (halfOffset &lt; <span class="number">0</span> || opOffset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;Long&gt; doneOpOffset = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                HashMap&lt;Long, Long&gt; removeMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                PullResult pullResult = fillOpRemoveMap(removeMap, opQueue, opOffset, halfOffset, doneOpOffset);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == pullResult) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// single thread</span></span><br><span class="line">                <span class="keyword">int</span> getMessageNullCount = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">long</span> newOffset = halfOffset;</span><br><span class="line">                <span class="keyword">long</span> i = halfOffset;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (System.currentTimeMillis() - startTime &gt; MAX_PROCESS_TIME_LIMIT) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (removeMap.containsKey(i)) &#123;</span><br><span class="line">                        Long removedOpOffset = removeMap.remove(i);</span><br><span class="line">                        doneOpOffset.add(removedOpOffset);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        GetResult getResult = getHalfMsg(messageQueue, i); <span class="comment">// 消费RMQ_SYS_TRANS_HALF_TOPIC队列中的事务消息</span></span><br><span class="line">                        MessageExt msgExt = getResult.getMsg();</span><br><span class="line">                        <span class="keyword">if</span> (msgExt == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (getMessageNullCount++ &gt; MAX_RETRY_COUNT_WHEN_HALF_NULL) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (getResult.getPullResult().getPullStatus() == PullStatus.NO_NEW_MSG) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                i = getResult.getPullResult().getNextBeginOffset();</span><br><span class="line">                                newOffset = i;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (needDiscard(msgExt, transactionCheckMax) || needSkip(msgExt)) &#123;<span class="comment">// 若已经超过最大回查次数了</span></span><br><span class="line">                            listener.resolveDiscardMsg(msgExt); <span class="comment">// 将消息添加到TRANS_CHECK_MAXTIME_TOPIC队列中</span></span><br><span class="line">                            newOffset = i + <span class="number">1</span>;</span><br><span class="line">                            i++;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (msgExt.getStoreTimestamp() &gt;= startTime) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">long</span> valueOfCurrentMinusBorn = System.currentTimeMillis() - msgExt.getBornTimestamp();</span><br><span class="line">                        <span class="keyword">long</span> checkImmunityTime = transactionTimeout;</span><br><span class="line">                        String checkImmunityTimeStr = msgExt.getUserProperty(MessageConst.PROPERTY_CHECK_IMMUNITY_TIME_IN_SECONDS);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">null</span> != checkImmunityTimeStr) &#123;</span><br><span class="line">                            checkImmunityTime = getImmunityTime(checkImmunityTimeStr, transactionTimeout);</span><br><span class="line">                            <span class="keyword">if</span> (valueOfCurrentMinusBorn &lt; checkImmunityTime) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (checkPrepareQueueOffset(removeMap, doneOpOffset, msgExt)) &#123;</span><br><span class="line">                                    newOffset = i + <span class="number">1</span>;</span><br><span class="line">                                    i++;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> ((<span class="number">0</span> &lt;= valueOfCurrentMinusBorn) &amp;&amp; (valueOfCurrentMinusBorn &lt; checkImmunityTime)) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        List&lt;MessageExt&gt; opMsg = pullResult.getMsgFoundList();</span><br><span class="line">                        <span class="keyword">boolean</span> isNeedCheck = (opMsg == <span class="keyword">null</span> &amp;&amp; valueOfCurrentMinusBorn &gt; checkImmunityTime)</span><br><span class="line">                            || (opMsg != <span class="keyword">null</span> &amp;&amp; (opMsg.get(opMsg.size() - <span class="number">1</span>).getBornTimestamp() - startTime &gt; transactionTimeout))</span><br><span class="line">                            || (valueOfCurrentMinusBorn &lt;= -<span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">if</span> (isNeedCheck) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!putBackHalfMsgQueue(msgExt, i)) &#123; <span class="comment">// 写回RMQ_SYS_TRANS_HALF_TOPIC队列中</span></span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            listener.resolveHalfMsg(msgExt); <span class="comment">// 回调客户端checkLocalTransaction方法</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            pullResult = fillOpRemoveMap(removeMap, opQueue, pullResult.getNextBeginOffset(), halfOffset, doneOpOffset);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    newOffset = i + <span class="number">1</span>;</span><br><span class="line">                    i++;DefaultMessageStore&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从节点的syncAll会同步Topic信息、每个Topic的队列的消费进度等，上面可以看到注册周期任务时是将masterAddr置为空的，该任务真正执行是会等到Broker注册到NameServer中后，调用<strong><code>SlaveSynchronize</code></strong>的<strong><code>setMasterAddr</code></strong>设置该地址后才进行；从主节点请求数据是通过BrokerOuterAPI最终调用<strong><code>NettyRemotingClient</code></strong>的<strong><code>invokeSync</code></strong>方法通过Natty实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SlaveSynchronize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.syncTopicConfig();</span><br><span class="line">        <span class="keyword">this</span>.syncConsumerOffset();</span><br><span class="line">        <span class="keyword">this</span>.syncDelayOffset();</span><br><span class="line">        <span class="keyword">this</span>.syncSubscriptionGroupConfig();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncTopicConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String masterAddrBak = <span class="keyword">this</span>.masterAddr;</span><br><span class="line">        <span class="keyword">if</span> (masterAddrBak != <span class="keyword">null</span> &amp;&amp; !masterAddrBak.equals(brokerController.getBrokerAddr())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TopicConfigSerializeWrapper topicWrapper = <span class="keyword">this</span>.brokerController.getBrokerOuterAPI().getAllTopicConfig(masterAddrBak);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getTopicConfigManager().getDataVersion().equals(topicWrapper.getDataVersion())) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().getDataVersion().assignNewOne(topicWrapper.getDataVersion());</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().getTopicConfigTable().clear();</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().getTopicConfigTable().putAll(topicWrapper.getTopicConfigTable());</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().persist();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncTopicConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String masterAddrBak = <span class="keyword">this</span>.masterAddr;</span><br><span class="line">        <span class="keyword">if</span> (masterAddrBak != <span class="keyword">null</span> &amp;&amp; !masterAddrBak.equals(brokerController.getBrokerAddr())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TopicConfigSerializeWrapper topicWrapper = <span class="keyword">this</span>.brokerController.getBrokerOuterAPI().getAllTopicConfig(masterAddrBak);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getTopicConfigManager().getDataVersion().equals(topicWrapper.getDataVersion())) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().getDataVersion().assignNewOne(topicWrapper.getDataVersion());</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().getTopicConfigTable().clear();</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().getTopicConfigTable().putAll(topicWrapper.getTopicConfigTable());</span><br><span class="line">                    <span class="keyword">this</span>.brokerController.getTopicConfigManager().persist();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncConsumerOffset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String masterAddrBak = <span class="keyword">this</span>.masterAddr;</span><br><span class="line">        <span class="keyword">if</span> (masterAddrBak != <span class="keyword">null</span> &amp;&amp; !masterAddrBak.equals(brokerController.getBrokerAddr())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ConsumerOffsetSerializeWrapper offsetWrapper = <span class="keyword">this</span>.brokerController.getBrokerOuterAPI().getAllConsumerOffset(masterAddrBak);</span><br><span class="line">                <span class="keyword">this</span>.brokerController.getConsumerOffsetManager().getOffsetTable().putAll(offsetWrapper.getOffsetTable());</span><br><span class="line">                <span class="keyword">this</span>.brokerController.getConsumerOffsetManager().persist();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncDelayOffset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String masterAddrBak = <span class="keyword">this</span>.masterAddr;</span><br><span class="line">        <span class="keyword">if</span> (masterAddrBak != <span class="keyword">null</span> &amp;&amp; !masterAddrBak.equals(brokerController.getBrokerAddr())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String delayOffset = <span class="keyword">this</span>.brokerController.getBrokerOuterAPI().getAllDelayOffset(masterAddrBak);</span><br><span class="line">                <span class="keyword">if</span> (delayOffset != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String fileName = StorePathConfigHelper.getDelayOffsetStorePath(<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getStorePathRootDir());</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        MixAll.string2File(delayOffset, fileName);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerOuterAPI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> TopicConfigSerializeWrapper <span class="title">getAllTopicConfig</span><span class="params">(<span class="keyword">final</span> String addr)</span> <span class="keyword">throws</span> RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class="line">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_TOPIC_CONFIG, <span class="keyword">null</span>);</span><br><span class="line">        RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class="keyword">true</span>, addr), request, <span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">assert</span> response != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (response.getCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> ResponseCode.SUCCESS: &#123;</span><br><span class="line">                <span class="keyword">return</span> TopicConfigSerializeWrapper.decode(response.getBody(), TopicConfigSerializeWrapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MQBrokerException(response.getCode(), response.getRemark());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyRemotingClient</span> <span class="keyword">extends</span> <span class="title">NettyRemotingAbstract</span> <span class="keyword">implements</span> <span class="title">RemotingClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">invokeSync</span><span class="params">(String addr, <span class="keyword">final</span> RemotingCommand request, <span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> InterruptedException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 这个channel就是和Nameserver之间建立的一个连接。</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = <span class="keyword">this</span>.getAndCreateChannel(addr);</span><br><span class="line">        <span class="comment">// 这个判断就是说网络连接如果是ok的，就发送请求</span></span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span> &amp;&amp; channel.isActive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doBeforeRpcHooks(addr, request); <span class="comment">// 计算时间的代码，不用太关注。</span></span><br><span class="line">                <span class="keyword">long</span> costTime = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="keyword">if</span> (timeoutMillis &lt; costTime) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTimeoutException(<span class="string">"invokeSync call timeout"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 真正发网络请求的地方</span></span><br><span class="line">                RemotingCommand response = <span class="keyword">this</span>.invokeSyncImpl(channel, request, timeoutMillis - costTime);</span><br><span class="line">                <span class="comment">// 请求之后的操作，也不用太关注。</span></span><br><span class="line">                doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(channel), request, response);</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingSendRequestException e) &#123;</span><br><span class="line">                <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingTimeoutException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nettyClientConfig.isClientCloseSocketIfTimeout()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemotingConnectException(addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">invokeSyncImpl</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> RemotingCommand request, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> InterruptedException, RemotingSendRequestException, RemotingTimeoutException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> opaque = request.getOpaque();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ResponseFuture responseFuture = <span class="keyword">new</span> ResponseFuture(channel, opaque, timeoutMillis, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.responseTable.put(opaque, responseFuture);</span><br><span class="line">            <span class="keyword">final</span> SocketAddress addr = channel.remoteAddress();</span><br><span class="line">            <span class="comment">// Broker发送心跳请求的核心。基于Netty开发的核心就是基于channel把请求写出去</span></span><br><span class="line">            channel.writeAndFlush(request).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture f)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (f.isSuccess()) &#123;</span><br><span class="line">                        responseFuture.setSendRequestOK(<span class="keyword">true</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        responseFuture.setSendRequestOK(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    responseTable.remove(opaque);</span><br><span class="line">                    responseFuture.setCause(f.cause());</span><br><span class="line">                    responseFuture.putResponse(<span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 核心就是等待请求的返回。</span></span><br><span class="line">            RemotingCommand responseCommand = responseFuture.waitResponse(timeoutMillis);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == responseCommand) &#123;</span><br><span class="line">                <span class="keyword">if</span> (responseFuture.isSendRequestOK()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTimeoutException(RemotingHelper.parseSocketAddressAddr(addr), timeoutMillis, responseFuture.getCause());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingSendRequestException(RemotingHelper.parseSocketAddressAddr(addr), responseFuture.getCause());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> responseCommand;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.responseTable.remove(opaque);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成事务回查任务以及主从同步的任务相关逻辑后，则调用<strong><code>registerBrokerAll</code></strong>方法完成<strong><code>Broker</code>注册</strong>，注册前会先调用<strong><code>needRegister</code></strong>方法到NameServer中查询一下心跳信息是否存在，以及数据版本是否变更。最终是通过NameServer的<strong><code>DefaultRequestProcessor</code></strong>来处理Broker的请求，且该方法会<strong>更新心跳信息</strong>，后续的心跳任务也是通过调用该方法完成的，且心跳任务是<strong>每<code>30s</code></strong>执行一次，更新最后心跳时间，且在注册会发送心跳时会带上Topic信息，若Topic信息发送变化会更新NameServer中存储的<strong><code>topicQueueTable</code></strong>，<strong>只有<code>Master</code>节点会做此操作</strong>。</p>
<p><strong><code>doRegisterBrokerAll</code></strong>才会真正调用NameServer注册Broker，注册时会生成<strong>主从同步地址</strong>，注意这里<strong>注册成功</strong>会将<strong>Broker主节点</strong>地址设置到<strong><code>SlaveSynchronize</code></strong>中，但是在<strong><code>RouteInfoManager</code></strong>的<strong><code>registerBroker</code></strong>逻辑中只有从节点才会返回<strong><code>haServerAddr</code></strong>和<strong><code>masterAddr</code></strong>，此时主从同步的周期任务才会真正执行同步逻辑；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">registerBrokerAll</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> checkOrderConfig, <span class="keyword">boolean</span> oneway, <span class="keyword">boolean</span> forceRegister)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里才是比较关键的地方。先判断是否需要注册，然后调用doRegisterBrokerAll方法真正去注册。</span></span><br><span class="line">        <span class="keyword">if</span> (forceRegister || needRegister(<span class="keyword">this</span>.brokerConfig.getBrokerClusterName(), <span class="keyword">this</span>.getBrokerAddr(), <span class="keyword">this</span>.brokerConfig.getBrokerName(), <span class="keyword">this</span>.brokerConfig.getBrokerId(), <span class="keyword">this</span>.brokerConfig.getRegisterBrokerTimeoutMills())) &#123;</span><br><span class="line">            doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">needRegister</span><span class="params">(<span class="keyword">final</span> String clusterName, <span class="keyword">final</span> String brokerAddr, <span class="keyword">final</span> String brokerName, <span class="keyword">final</span> <span class="keyword">long</span> brokerId, <span class="keyword">final</span> <span class="keyword">int</span> timeoutMills)</span> </span>&#123;</span><br><span class="line">        TopicConfigSerializeWrapper topicConfigWrapper = <span class="keyword">this</span>.getTopicConfigManager().buildTopicConfigSerializeWrapper();</span><br><span class="line">        List&lt;Boolean&gt; changeList = brokerOuterAPI.needRegister(clusterName, brokerAddr, brokerName, brokerId, topicConfigWrapper, timeoutMills);</span><br><span class="line">        <span class="keyword">boolean</span> needRegister = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Boolean changed : changeList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">                needRegister = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> needRegister;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRegisterBrokerAll</span><span class="params">(<span class="keyword">boolean</span> checkOrderConfig, <span class="keyword">boolean</span> oneway, TopicConfigSerializeWrapper topicConfigWrapper)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//为什么返回的是个List？这就是因为Broker是向所有的NameServer进行注册。</span></span><br><span class="line">        List&lt;RegisterBrokerResult&gt; registerBrokerResultList = <span class="keyword">this</span>.brokerOuterAPI.registerBrokerAll(<span class="keyword">this</span>.brokerConfig.getBrokerClusterName(), <span class="keyword">this</span>.getBrokerAddr(),                                                                                        <span class="keyword">this</span>.brokerConfig.getBrokerName(), <span class="keyword">this</span>.brokerConfig.getBrokerId(), <span class="keyword">this</span>.getHAServerAddr(), topicConfigWrapper, <span class="keyword">this</span>.filterServerManager.buildNewFilterServerList(),</span><br><span class="line">                                                                                                    oneway, <span class="keyword">this</span>.brokerConfig.getRegisterBrokerTimeoutMills(), <span class="keyword">this</span>.brokerConfig.isCompressedRegister());</span><br><span class="line">        <span class="comment">//如果注册结果的数量大于0，那么就对结果进行处理</span></span><br><span class="line">        <span class="keyword">if</span> (registerBrokerResultList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            RegisterBrokerResult registerBrokerResult = registerBrokerResultList.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (registerBrokerResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//主节点地址</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.updateMasterHAServerAddrPeriodically &amp;&amp; registerBrokerResult.getHaServerAddr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.messageStore.updateHaMasterAddress(registerBrokerResult.getHaServerAddr());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 注意这里很关键，这里设置MasterAddr后，主从同步的周期任务才会真正执行同步逻辑</span></span><br><span class="line">                <span class="keyword">this</span>.slaveSynchronize.setMasterAddr(registerBrokerResult.getMasterAddr());</span><br><span class="line">                <span class="keyword">if</span> (checkOrderConfig) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.getTopicConfigManager().updateOrderTopicConfig(registerBrokerResult.getKvTable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerOuterAPI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Boolean&gt; <span class="title">needRegister</span><span class="params">(<span class="keyword">final</span> String clusterName, <span class="keyword">final</span> String brokerAddr, <span class="keyword">final</span> String brokerName, <span class="keyword">final</span> <span class="keyword">long</span> brokerId, <span class="keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper, <span class="keyword">final</span> <span class="keyword">int</span> timeoutMills)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;Boolean&gt; changedList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; nameServerAddressList = <span class="keyword">this</span>.remotingClient.getNameServerAddressList();</span><br><span class="line">        <span class="keyword">if</span> (nameServerAddressList != <span class="keyword">null</span> &amp;&amp; nameServerAddressList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(nameServerAddressList.size());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String namesrvAddr : nameServerAddressList) &#123;</span><br><span class="line">                brokerOuterExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            QueryDataVersionRequestHeader requestHeader = <span class="keyword">new</span> QueryDataVersionRequestHeader();</span><br><span class="line">                            requestHeader.setBrokerAddr(brokerAddr);</span><br><span class="line">                            requestHeader.setBrokerId(brokerId);</span><br><span class="line">                            requestHeader.setBrokerName(brokerName);</span><br><span class="line">                            requestHeader.setClusterName(clusterName);</span><br><span class="line">                            RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_DATA_VERSION, requestHeader);</span><br><span class="line">                            request.setBody(topicConfigWrapper.getDataVersion().encode());</span><br><span class="line">                            RemotingCommand response = remotingClient.invokeSync(namesrvAddr, request, timeoutMills);</span><br><span class="line">                            DataVersion nameServerDataVersion = <span class="keyword">null</span>;</span><br><span class="line">                            Boolean changed = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">switch</span> (response.getCode()) &#123;</span><br><span class="line">                                <span class="keyword">case</span> ResponseCode.SUCCESS: &#123;</span><br><span class="line">                                    QueryDataVersionResponseHeader queryDataVersionResponseHeader = (QueryDataVersionResponseHeader) response.decodeCommandCustomHeader(QueryDataVersionResponseHeader<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                                    changed = queryDataVersionResponseHeader.getChanged();</span><br><span class="line">                                    <span class="keyword">byte</span>[] body = response.getBody();</span><br><span class="line">                                    <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                        nameServerDataVersion = DataVersion.decode(body, DataVersion<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                                        <span class="keyword">if</span> (!topicConfigWrapper.getDataVersion().equals(nameServerDataVersion)) &#123;</span><br><span class="line">                                            changed = <span class="keyword">true</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">if</span> (changed == <span class="keyword">null</span> || changed) &#123;</span><br><span class="line">                                        changedList.add(Boolean.TRUE);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">default</span>:</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            changedList.add(Boolean.TRUE);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            countDownLatch.countDown();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> changedList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;RegisterBrokerResult&gt; <span class="title">registerBrokerAll</span><span class="params">(<span class="keyword">final</span> String clusterName, <span class="keyword">final</span> String brokerAddr, <span class="keyword">final</span> String brokerName, <span class="keyword">final</span> <span class="keyword">long</span> brokerId, <span class="keyword">final</span> String haServerAddr, <span class="keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper, <span class="keyword">final</span> List&lt;String&gt; filterServerList, <span class="keyword">final</span> <span class="keyword">boolean</span> oneway, <span class="keyword">final</span> <span class="keyword">int</span> timeoutMills, <span class="keyword">final</span> <span class="keyword">boolean</span> compressed)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化一个list，用来放向每个NameServer注册的结果。</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;RegisterBrokerResult&gt; registerBrokerResultList = Lists.newArrayList();</span><br><span class="line">        <span class="comment">// NameSrv的地址列表</span></span><br><span class="line">        List&lt;String&gt; nameServerAddressList = <span class="keyword">this</span>.remotingClient.getNameServerAddressList();</span><br><span class="line">        <span class="keyword">if</span> (nameServerAddressList != <span class="keyword">null</span> &amp;&amp; nameServerAddressList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 构建Broker注册的网络请求。可以看看有哪些关键参数。</span></span><br><span class="line">            <span class="keyword">final</span> RegisterBrokerRequestHeader requestHeader = <span class="keyword">new</span> RegisterBrokerRequestHeader();</span><br><span class="line">            requestHeader.setBrokerAddr(brokerAddr);</span><br><span class="line">            requestHeader.setBrokerId(brokerId);</span><br><span class="line">            requestHeader.setBrokerName(brokerName);</span><br><span class="line">            requestHeader.setClusterName(clusterName);</span><br><span class="line">            requestHeader.setHaServerAddr(haServerAddr);</span><br><span class="line">            requestHeader.setCompressed(compressed);</span><br><span class="line">            <span class="comment">//请求体</span></span><br><span class="line">            RegisterBrokerBody requestBody = <span class="keyword">new</span> RegisterBrokerBody();</span><br><span class="line">            requestBody.setTopicConfigSerializeWrapper(topicConfigWrapper);</span><br><span class="line">            requestBody.setFilterServerList(filterServerList);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] body = requestBody.encode(compressed);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> bodyCrc32 = UtilAll.crc32(body);</span><br><span class="line">            requestHeader.setBodyCrc32(bodyCrc32);</span><br><span class="line">            <span class="comment">//这个东东的作用是等待向全部的Nameserver都进行了注册后再往下走。</span></span><br><span class="line">            <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(nameServerAddressList.size());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String namesrvAddr : nameServerAddressList) &#123;</span><br><span class="line">                brokerOuterExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;<span class="comment">// Broker真正执行注册的方法</span></span><br><span class="line">                            RegisterBrokerResult result = registerBroker(namesrvAddr, oneway, timeoutMills, requestHeader, body);</span><br><span class="line">                            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123; <span class="comment">//注册完了，在本地保存下来。</span></span><br><span class="line">                                registerBrokerResultList.add(result);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            countDownLatch.countDown();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;<span class="comment">//在这里等待所有的NameSrv都注册完成了才往下走。</span></span><br><span class="line">                countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> registerBrokerResultList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> RegisterBrokerResult <span class="title">registerBroker</span><span class="params">(<span class="keyword">final</span> String namesrvAddr, <span class="keyword">final</span> <span class="keyword">boolean</span> oneway, <span class="keyword">final</span> <span class="keyword">int</span> timeoutMills, <span class="keyword">final</span> RegisterBrokerRequestHeader requestHeader, <span class="keyword">final</span> <span class="keyword">byte</span>[] body)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemotingCommandException, MQBrokerException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 封装一个网络请求</span></span><br><span class="line">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.REGISTER_BROKER, requestHeader);</span><br><span class="line">        request.setBody(body);</span><br><span class="line">        <span class="comment">// 特殊请求 sendOneWay</span></span><br><span class="line">        <span class="keyword">if</span> (oneway) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.remotingClient.invokeOneway(namesrvAddr, request, timeoutMills);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingTooMuchRequestException e) &#123;<span class="comment">/* Ignore*/</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//真正发送网络请求的地方。这个remotingClient就是一个NettyClient。</span></span><br><span class="line">        RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(namesrvAddr, request, timeoutMills);</span><br><span class="line">        <span class="comment">//封装网络请求结果。</span></span><br><span class="line">        <span class="keyword">assert</span> response != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (response.getCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> ResponseCode.SUCCESS: &#123;</span><br><span class="line">                RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.decodeCommandCustomHeader(RegisterBrokerResponseHeader<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                RegisterBrokerResult result = <span class="keyword">new</span> RegisterBrokerResult();</span><br><span class="line">                result.setMasterAddr(responseHeader.getMasterAddr());</span><br><span class="line">                result.setHaServerAddr(responseHeader.getHaServerAddr());</span><br><span class="line">                <span class="keyword">if</span> (response.getBody() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    result.setKvTable(KVTable.decode(response.getBody(), KVTable<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MQBrokerException(response.getCode(), response.getRemark());<span class="comment">//请求不成功就直接抛出异常。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRequestProcessor</span> <span class="keyword">extends</span> <span class="title">AsyncNettyRequestProcessor</span> <span class="keyword">implements</span> <span class="title">NettyRequestProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">processRequest</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line">        <span class="comment">// 这里是NameServer处理请求的核心代码。根据请求类型有不同的处理过程</span></span><br><span class="line">        <span class="keyword">switch</span> (request.getCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> RequestCode.QUERY_DATA_VERSION:</span><br><span class="line">                <span class="keyword">return</span> queryBrokerTopicConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.REGISTER_BROKER:   <span class="comment">// 注册Broker的请求</span></span><br><span class="line">                Version brokerVersion = MQVersion.value2Version(request.getVersion());</span><br><span class="line">                <span class="keyword">if</span> (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.registerBrokerWithFilterServer(ctx, request);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">//注册Broker的实际方法</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.registerBroker(ctx, request);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">queryBrokerTopicConfig</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(QueryDataVersionResponseHeader<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">final</span> QueryDataVersionResponseHeader responseHeader = (QueryDataVersionResponseHeader) response.readCustomHeader();</span><br><span class="line">        <span class="keyword">final</span> QueryDataVersionRequestHeader requestHeader = (QueryDataVersionRequestHeader) request.decodeCommandCustomHeader(QueryDataVersionRequestHeader<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        DataVersion dataVersion = DataVersion.decode(request.getBody(), DataVersion<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Boolean changed = <span class="keyword">this</span>.namesrvController.getRouteInfoManager().isBrokerTopicConfigChanged(requestHeader.getBrokerAddr(), dataVersion);</span><br><span class="line">        <span class="keyword">if</span> (!changed) &#123;</span><br><span class="line">            <span class="keyword">this</span>.namesrvController.getRouteInfoManager().updateBrokerInfoUpdateTimestamp(requestHeader.getBrokerAddr());</span><br><span class="line">        &#125;</span><br><span class="line">        DataVersion nameSeverDataVersion = <span class="keyword">this</span>.namesrvController.getRouteInfoManager().queryBrokerTopicConfig(requestHeader.getBrokerAddr());</span><br><span class="line">        response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">        response.setRemark(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (nameSeverDataVersion != <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.setBody(nameSeverDataVersion.encode());</span><br><span class="line">        &#125;</span><br><span class="line">        responseHeader.setChanged(changed);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">registerBroker</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">// 解析注册请求，然后构造返回响应</span></span><br><span class="line">        <span class="keyword">final</span> RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader();</span><br><span class="line">        <span class="keyword">final</span> RegisterBrokerRequestHeader requestHeader = (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!checksum(ctx, request, requestHeader)) &#123;</span><br><span class="line">            response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">            response.setRemark(<span class="string">"crc32 not match"</span>);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">        TopicConfigSerializeWrapper topicConfigWrapper;</span><br><span class="line">        <span class="keyword">if</span> (request.getBody() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            topicConfigWrapper = TopicConfigSerializeWrapper.decode(request.getBody(), TopicConfigSerializeWrapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            topicConfigWrapper = <span class="keyword">new</span> TopicConfigSerializeWrapper();</span><br><span class="line">            topicConfigWrapper.getDataVersion().setCounter(<span class="keyword">new</span> AtomicLong(<span class="number">0</span>));</span><br><span class="line">            topicConfigWrapper.getDataVersion().setTimestamp(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// RouteInfoMapper就是管理路由信息的核心组件。</span></span><br><span class="line">        RegisterBrokerResult result = <span class="keyword">this</span>.namesrvController.getRouteInfoManager().registerBroker(requestHeader.getClusterName(), requestHeader.getBrokerAddr(), requestHeader.getBrokerName(), requestHeader.getBrokerId(), requestHeader.getHaServerAddr(), topicConfigWrapper, <span class="keyword">null</span>, ctx.channel());</span><br><span class="line">        responseHeader.setHaServerAddr(result.getHaServerAddr());   <span class="comment">// 从节点地址</span></span><br><span class="line">        responseHeader.setMasterAddr(result.getMasterAddr());       <span class="comment">// Broker主节点地址</span></span><br><span class="line">        <span class="keyword">byte</span>[] jsonValue = <span class="keyword">this</span>.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG);</span><br><span class="line">        response.setBody(jsonValue);</span><br><span class="line">        response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">        response.setRemark(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteInfoManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBrokerTopicConfigChanged</span><span class="params">(<span class="keyword">final</span> String brokerAddr, <span class="keyword">final</span> DataVersion dataVersion)</span> </span>&#123;</span><br><span class="line">        DataVersion prev = queryBrokerTopicConfig(brokerAddr);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == prev || !prev.equals(dataVersion);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataVersion <span class="title">queryBrokerTopicConfig</span><span class="params">(<span class="keyword">final</span> String brokerAddr)</span> </span>&#123;</span><br><span class="line">        BrokerLiveInfo prev = <span class="keyword">this</span>.brokerLiveTable.get(brokerAddr);</span><br><span class="line">        <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> prev.getDataVersion();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RegisterBrokerResult <span class="title">registerBroker</span><span class="params">(<span class="keyword">final</span> String clusterName, <span class="keyword">final</span> String brokerAddr, <span class="keyword">final</span> String brokerName, <span class="keyword">final</span> <span class="keyword">long</span> brokerId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> String haServerAddr, <span class="keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper, <span class="keyword">final</span> List&lt;String&gt; filterServerList, <span class="keyword">final</span> Channel channel)</span> </span>&#123;</span><br><span class="line">        RegisterBrokerResult result = <span class="keyword">new</span> RegisterBrokerResult();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.lock.writeLock().lockInterruptibly(); <span class="comment">// 并发加锁，同一时间只能一个线程写。</span></span><br><span class="line">                <span class="comment">// Broker列表，用的一个set，自动去重。</span></span><br><span class="line">                Set&lt;String&gt; brokerNames = <span class="keyword">this</span>.clusterAddrTable.get(clusterName);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == brokerNames) &#123;</span><br><span class="line">                    brokerNames = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">                    <span class="keyword">this</span>.clusterAddrTable.put(clusterName, brokerNames);</span><br><span class="line">                &#125;</span><br><span class="line">                brokerNames.add(brokerName);</span><br><span class="line">                <span class="keyword">boolean</span> registerFirst = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// 根据Broker名称获取数据。这个brokerAddrTable就是核心路由数据表</span></span><br><span class="line">                BrokerData brokerData = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</span><br><span class="line">                <span class="comment">// 第一次注册，这个brokerData就是null。后续心跳注册时就不会重复注册。</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == brokerData) &#123;</span><br><span class="line">                    registerFirst = <span class="keyword">true</span>;</span><br><span class="line">                    brokerData = <span class="keyword">new</span> BrokerData(clusterName, brokerName, <span class="keyword">new</span> HashMap&lt;Long, String&gt;());</span><br><span class="line">                    <span class="keyword">this</span>.brokerAddrTable.put(brokerName, brokerData);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 对路由数据做一些封装</span></span><br><span class="line">                Map&lt;Long, String&gt; brokerAddrsMap = brokerData.getBrokerAddrs();</span><br><span class="line">                <span class="comment">//Switch slave to master: first remove &lt;1, IP:PORT&gt; in namesrv, then add &lt;0, IP:PORT&gt;</span></span><br><span class="line">                <span class="comment">//The same IP:PORT must only have one record in brokerAddrTable</span></span><br><span class="line">                Iterator&lt;Entry&lt;Long, String&gt;&gt; it = brokerAddrsMap.entrySet().iterator();</span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    Entry&lt;Long, String&gt; item = it.next();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != brokerAddr &amp;&amp; brokerAddr.equals(item.getValue()) &amp;&amp; brokerId != item.getKey()) &#123;</span><br><span class="line">                        it.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                String oldAddr = brokerData.getBrokerAddrs().put(brokerId, brokerAddr);</span><br><span class="line">                registerFirst = registerFirst || (<span class="keyword">null</span> == oldAddr);</span><br><span class="line">                <span class="comment">// brokerId为0的表示是Master</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != topicConfigWrapper &amp;&amp; MixAll.MASTER_ID == brokerId) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion()) || registerFirst) &#123;</span><br><span class="line">                        ConcurrentMap&lt;String, TopicConfig&gt; tcTable = topicConfigWrapper.getTopicConfigTable();</span><br><span class="line">                        <span class="keyword">if</span> (tcTable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (Map.Entry&lt;String, TopicConfig&gt; entry : tcTable.entrySet()) &#123;</span><br><span class="line">                                <span class="keyword">this</span>.createAndUpdateQueueData(brokerName, entry.getValue());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 每隔30秒心跳注册时，会封装一个新的BrokerLiveInfo。这样就会覆盖上一次的数据。</span></span><br><span class="line">                <span class="comment">// 同时，这个BrokerLiveInfo里会保存一个当前时间戳，代表最近一次心跳时间。</span></span><br><span class="line">                BrokerLiveInfo prevBrokerLiveInfo = <span class="keyword">this</span>.brokerLiveTable.put(brokerAddr,</span><br><span class="line">                    <span class="keyword">new</span> BrokerLiveInfo(System.currentTimeMillis(), topicConfigWrapper.getDataVersion(), channel, haServerAddr));</span><br><span class="line">                <span class="keyword">if</span> (filterServerList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (filterServerList.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.filterServerTable.remove(brokerAddr);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.filterServerTable.put(brokerAddr, filterServerList);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (MixAll.MASTER_ID != brokerId) &#123; <span class="comment">// 若是从节点Broker</span></span><br><span class="line">                    String masterAddr = brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);</span><br><span class="line">                    <span class="keyword">if</span> (masterAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        BrokerLiveInfo brokerLiveInfo = <span class="keyword">this</span>.brokerLiveTable.get(masterAddr);</span><br><span class="line">                        <span class="keyword">if</span> (brokerLiveInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());</span><br><span class="line">                            result.setMasterAddr(masterAddr);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.lock.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        </div>
        
    <footer class="article-footer">
    </footer>
    </div>
</article>


    
    <nav id="article-nav">
        
        
            <a href="/Blog/Cloud/ELK/ElasticSearch实战/" id="article-nav-older" class="article-nav-link-wrap">
                <strong class="article-nav-caption">Older</strong>
                <div class="article-nav-title">ElasticSearch实战</div>
            </a>
        
    </nav>





    
    




    <!-- baidu url auto push script -->
    <script type="text/javascript">
        !function () {
            var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi, r = window.location.href,
                o = document.referrer;
            if (!e.test(r)) {
                var n = "//api.share.baidu.com/s.gif";
                o ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
                var t = new Image;
                t.src = n
            }
        }(window);
    </script>
</section>
    </div>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            YaoYingLong &copy; 2024
            <!-- <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a> -->
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten" rel="external nofollow noopener noreferrer" target="_blank">wikitten</a>
        </div>
    </div>
</footer>
    

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });


</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

</div>
</body>
